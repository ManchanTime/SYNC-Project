<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>ZC102FIR0014F01</title>
</head>
<body bgcolor="#FFFFE0">
<font size="3" face = "Arial" color="#000000"><b>Code listing for: ZC102FIR0014F01</b></font>
<br>
<font size="3" face = "Arial" color="#000000"><b>Description:  Include ZC102FIR0014F01</b></font>
<hr>
<pre width="100">
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Include          ZC102FIR0014F01</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_reverse_txt50</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_reverse_txt50 .

<font color ="#0000FF">* SE11 DD07T 도메인 이름 넣고 실행</font>
  CLEAR gt_reverse_code.
  SELECT domvalue_l AS stgrd ddtext AS txt50
    FROM dd07t
    INTO CORRESPONDING FIELDS OF TABLE gt_reverse_code
  WHERE domname EQ 'ZC102D_FI_STGRD'.

  IF gt_reverse_code IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
    STOP.
  ENDIF.



ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_init_value</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_init_value .

  gv_bukrs = '1000'.
  gv_gjahr = sy-datum(4).
  gv_budat = sy-datum.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_screen_100</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM display_screen_100 .</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  IF go_container IS NOT BOUND.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    CLEAR : gt_top_fcat, gs_top_fcat.</font>
<font color ="#0000FF">*    PERFORM set_top_field_catalog USING : 'X' 'BUKRS' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          'X' 'GJAHR' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          'X' 'BELNR' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'BLART' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'BLDAT' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'BUDAT' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'BKTXT' 'ZC102FIT0009' ' ' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'STBLG' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'STODT' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'STGRD' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'WAERS' 'ZC102FIT0009' 'C' ' '.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    CLEAR : gt_bot_fcat, gs_bot_fcat.</font>
<font color ="#0000FF">*    PERFORM set_bot_field_catalog USING : 'X' 'BUKRS' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          'X' 'GJAHR' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          'X' 'BELNR' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'REBZG' 'ZC102FIT0016' 'C' 'X',</font>
<font color ="#0000FF">*                                          ' ' 'BLART' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'BLDAT' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'BUDAT' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">**                                          ' ' 'BKTXT' 'ZC102FIT0009' ' ' ' ',</font>
<font color ="#0000FF">**                                          ' ' 'STBLG' 'ZC102FIT0009' 'C' ' ',</font>
<font color ="#0000FF">**                                          ' ' 'STODT' 'ZC102FIT0009' ' ' ' ',</font>
<font color ="#0000FF">**                                          ' ' 'STGRD' 'ZC102FIT0009' ' ' ' ',</font>
<font color ="#0000FF">*                                          ' ' 'WAERS' 'ZC102FIT0009' 'C' ' '.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    PERFORM set_top_layout.</font>
<font color ="#0000FF">*    PERFORM set_bot_layout.</font>
<font color ="#0000FF">*    PERFORM create_object_100.</font>

<font color ="#0000FF">*    CALL METHOD go_top_grid-&gt;set_table_for_first_display</font>
<font color ="#0000FF">*      EXPORTING</font>
<font color ="#0000FF">*        is_variant      = gs_top_variant</font>
<font color ="#0000FF">*        i_save          = 'A'</font>
<font color ="#0000FF">*        i_default       = 'X'</font>
<font color ="#0000FF">*        is_layout       = gs_top_layout</font>
<font color ="#0000FF">*      CHANGING</font>
<font color ="#0000FF">*        it_outtab       = gt_header</font>
<font color ="#0000FF">*        it_fieldcatalog = gt_top_fcat.</font>
<font color ="#0000FF">**        it_sort                       =</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    CALL METHOD go_bottom_grid-&gt;set_table_for_first_display</font>
<font color ="#0000FF">*      EXPORTING</font>
<font color ="#0000FF">*        is_variant      = gs_bot_variant</font>
<font color ="#0000FF">*        i_save          = 'A'</font>
<font color ="#0000FF">*        i_default       = 'X'</font>
<font color ="#0000FF">*        is_layout       = gs_bot_layout</font>
<font color ="#0000FF">*      CHANGING</font>
<font color ="#0000FF">*        it_outtab       = gt_reverse</font>
<font color ="#0000FF">*        it_fieldcatalog = gt_bot_fcat.</font>
<font color ="#0000FF">**        it_sort                       =</font>

<font color ="#0000FF">*  ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_top_field_catalog</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM set_top_field_catalog  USING pv_key pv_field pv_table pv_just pv_emph.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  gs_top_fcat-key       = pv_key.</font>
<font color ="#0000FF">*  gs_top_fcat-fieldname = pv_field.</font>
<font color ="#0000FF">*  gs_top_fcat-ref_table = pv_table.</font>
<font color ="#0000FF">*  gs_top_fcat-just      = pv_just.</font>
<font color ="#0000FF">*  gs_top_fcat-emphasize = pv_emph.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  APPEND gs_top_fcat TO gt_top_fcat.</font>
<font color ="#0000FF">*  CLEAR gs_top_fcat.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_bot_field_catalog</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM set_bot_field_catalog  USING pv_key pv_field pv_table pv_just pv_emph.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  gs_bot_fcat-key       = pv_key.</font>
<font color ="#0000FF">*  gs_bot_fcat-fieldname = pv_field.</font>
<font color ="#0000FF">*  gs_bot_fcat-ref_table = pv_table.</font>
<font color ="#0000FF">*  gs_bot_fcat-just      = pv_just.</font>
<font color ="#0000FF">*  gs_bot_fcat-emphasize = pv_emph.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  APPEND gs_bot_fcat TO gt_bot_fcat.</font>
<font color ="#0000FF">*  CLEAR gs_bot_fcat.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_top_layout</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM set_top_layout .</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  gs_top_layout-zebra      = abap_true.</font>
<font color ="#0000FF">*  gs_top_layout-cwidth_opt = 'A'.</font>
<font color ="#0000FF">*  gs_top_layout-sel_mode   = ' '.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  gs_top_variant-report = sy-repid.</font>
<font color ="#0000FF">*  gs_top_variant-handle = 'TALV'.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_bot_layout</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM set_bot_layout .</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  gs_bot_layout-zebra      = abap_true.</font>
<font color ="#0000FF">*  gs_bot_layout-cwidth_opt = 'A'.</font>
<font color ="#0000FF">*  gs_bot_layout-sel_mode   = ' '.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  gs_bot_variant-report = sy-repid.</font>
<font color ="#0000FF">*  gs_bot_variant-handle = 'BALV'.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_object_100</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM create_object_100 .</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  CREATE OBJECT go_container</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      container_name = 'MAIN_CONT'.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">**-- 화면분할 : Split screen</font>
<font color ="#0000FF">*  CREATE OBJECT go_split_cont</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      parent  = go_container</font>
<font color ="#0000FF">*      rows    = 1</font>
<font color ="#0000FF">*      columns = 2.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">**-- Patch container</font>
<font color ="#0000FF">*  CALL METHOD go_split_cont-&gt;get_container</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      row       = 1</font>
<font color ="#0000FF">*      column    = 1</font>
<font color ="#0000FF">*    RECEIVING</font>
<font color ="#0000FF">*      container = go_top_cont.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  CALL METHOD go_split_cont-&gt;get_container</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      row       = 1</font>
<font color ="#0000FF">*      column    = 2</font>
<font color ="#0000FF">*    RECEIVING</font>
<font color ="#0000FF">*      container = go_bottom_cont.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">**-- Patch ALV</font>
<font color ="#0000FF">*  CREATE OBJECT go_top_grid</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      i_parent = go_top_cont.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  CREATE OBJECT go_bottom_grid</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      i_parent = go_bottom_cont.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_top_grid</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM refresh_top_grid .</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  DATA : ls_stable TYPE lvc_s_stbl.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">**-- 현재 커서</font>
<font color ="#0000FF">*  ls_stable-row = abap_true.</font>
<font color ="#0000FF">*  ls_stable-col = abap_true.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">**-- alv refresh</font>
<font color ="#0000FF">*  CALL METHOD go_top_grid-&gt;refresh_table_display</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      is_stable = ls_stable.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_reverse_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_jeonpyo_data .

  DATA : lv_answer.

  IF gv_reverse-belnr IS INITIAL.
    MESSAGE s058 DISPLAY LIKE 'E'.
    EXIT.
  ELSEIF gv_code IS INITIAL.
    MESSAGE s082 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  CLEAR gs_reverse_code.
  READ TABLE gt_reverse_code INTO gs_reverse_code WITH KEY stgrd = gv_code.

  IF gs_reverse_code IS INITIAL.
    MESSAGE s094 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.



  PERFORM confirm_data CHANGING lv_answer.

  CHECK lv_answer EQ '1'.

  PERFORM get_header_data.

  READ TABLE gt_header INTO gs_header INDEX 1.

  IF gs_header-stblg IS NOT INITIAL.
    MESSAGE s084 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  PERFORM number_get_next USING gv_reverse_belnr.

  PERFORM set_reverse_header. " 09 테이블에 역분개 헤더 전표 생성

  CASE gs_header-blart.
    WHEN 'SA' OR 'DR' OR 'KR'.
      PERFORM set_reverse_line.   " 10 데이블에 역분개 라인 전표 생성
    WHEN 'DZ' OR 'KZ'.
      PERFORM set_clear_data. " 반제 전표 원전표에서 반제일 반제전표 제거
  ENDCASE.

  PERFORM update_header_data. " 역분개 시킨 전표에 값 채워줌

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form confirm_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- LV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM confirm_data  CHANGING pv_answer.

  call function <a href ="zfm_cl102_cm_pop_up/zfm_cl102_cm_pop_up.html">'ZFM_CL102_CM_POP_UP'</a>
    EXPORTING
      iv_titlebar = '역분개 실행'
      iv_question = '해당 전표를 역분개하시겠습니까?'
    IMPORTING
      ev_answer   = pv_answer.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form number_get_next</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; GV_REVERSE_BELNR</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM number_get_next  USING pv_reverse_belnr.

  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      object      = 'ZC102CM_AU'  " SNRO 오브젝트 이름
      nr_range_nr = '03'          " 인터벌 번호
      subobject   = 'BNR'         " Prefix (서브오브젝트)
      quantity    = 1
    IMPORTING
      number      = pv_reverse_belnr
    EXCEPTIONS
      OTHERS      = 1.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_reverse_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_reverse_header .

  " 역분개 헤더 전표 만들기
  READ TABLE gt_header INTO gs_header INDEX 1.

  gs_reverse-bukrs = '1000'.
  gs_reverse-gjahr = sy-datum(4).
  gs_reverse-belnr = gv_reverse_belnr. " 역분개 전표번호
  gs_reverse-rebzg = gs_header-belnr.  " 조회한 전표번호
  gs_reverse-bldat = sy-datum.
  gs_reverse-budat = sy-datum.
  gs_reverse-waers = gs_header-waers.
  gs_reverse-erdat = sy-datum.
  gs_reverse-ernam = sy-uname.
  gs_reverse-erzet = sy-uzeit.

  CASE gs_header-blart.
    WHEN 'SA'.
      gs_reverse-blart = 'SX'.
    WHEN 'DR' OR 'DZ'.
      gs_reverse-blart = 'DX'.
    WHEN 'KR' OR 'KZ'.
      gs_reverse-blart = 'KX'.
  ENDCASE.

  APPEND gs_reverse TO gt_reverse.

  MOVE-CORRESPONDING gt_reverse TO gt_reverse_s.
  MODIFY zc102fit0009 FROM TABLE gt_reverse_s.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_stgrd</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_stgrd .

<font color ="#0000FF">*-- Screen 100 Data 추출 이거뭐 어디서든지 가능?</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

<font color ="#0000FF">*-- 소스 코드 구현 위한 Function 호출? (Screen 100 Data 추출?)</font>

  CALL FUNCTION 'DYNP_VALUES_READ'
    EXPORTING
      dyname     = sy-repid
      dynumb     = sy-dynnr
      request    = 'A'
    TABLES
      dynpfields = dynpfields
    EXCEPTIONS
      OTHERS     = 01.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'STGRD'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_REVERSE_CODE-STRGD'
      window_title = '역분개 사유'
      value_org    = 'S'
    TABLES
      value_tab    = gt_reverse_code
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form update_header_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM update_header_data .

  READ TABLE gt_header INTO gs_header WITH KEY belnr = gv_reverse-belnr.

  IF sy-subrc = 0.

    gs_header-stblg = gv_reverse_belnr.
    gs_header-stodt = sy-datum.
    gs_header-stgrd = gs_reverse_code-stgrd.
    gs_header-aedat = sy-datum.
    gs_header-aenam = sy-uname.
    gs_header-aezet = sy-uzeit.

    MODIFY gt_header FROM gs_header INDEX sy-tabix TRANSPORTING stblg stodt stgrd
                                                                aedat aenam aezet.

  ENDIF.

  MOVE-CORRESPONDING gt_header TO gt_header_s.
  MODIFY zc102fit0009 FROM TABLE gt_header_s.

  IF gs_header-stblg IS NOT INITIAL .
    MESSAGE 'Document ' && gv_reverse-belnr && ' was posted in company code 1000' TYPE 'I'.
    MESSAGE s086 DISPLAY LIKE 'S'.
    EXIT.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form lnr</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_parameter_id.

  DATA : lv_belnr TYPE zc102fit0009-belnr.
  DATA : mv_stgrd TYPE zc102fit0006-stgrd.

  GET PARAMETER ID 'BLN' FIELD lv_belnr.
  GET PARAMETER ID 'FSG' FIELD mv_stgrd.

  gs_reverse-belnr = lv_belnr.
  gv_code = mv_stgrd.

  SET PARAMETER ID 'BLN' FIELD space.
  SET PARAMETER ID 'FSG' FIELD space.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_header_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_header_data .

  CLEAR gt_header.
  SELECT bukrs belnr gjahr blart bldat budat bktxt stblg stodt
         stgrd waers erdat ernam erzet
    FROM zc102fit0009
    INTO CORRESPONDING FIELDS OF TABLE gt_header
   WHERE belnr = gv_reverse-belnr.

  IF gt_header IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_reverse_line</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_reverse_line .

  DATA : ls_bp TYPE zc102bpt0002,
         lt_bp TYPE TABLE OF zc102bpt0002.

<font color ="#0000FF">* 헤더 전표 라인아이템</font>
  CLEAR gt_line.
  SELECT bukrs belnr gjahr buzei saknr bpact augdt augbl bschl shkzg
         koart sgtxt wrbtr dmbtr waers ebeln vbeln partner
    FROM zc102fit0010
    INTO CORRESPONDING FIELDS OF TABLE gt_line
   WHERE belnr = gv_reverse-belnr.

  IF gt_line IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

<font color ="#0000FF">* bpt0002</font>
  CLEAR lt_bp.
  SELECT saknr bpact partner
    FROM zc102bpt0002
    INTO CORRESPONDING FIELDS OF TABLE lt_bp.

  CLEAR gs_line.
  LOOP AT gt_line INTO gs_line.

    READ TABLE lt_bp INTO ls_bp WITH KEY partner = gs_line-partner.

<font color ="#0000FF">* 비효율적인 코드 Move-corresponding을 생각하자</font>
<font color ="#0000FF">* 미결 전표 SA DR DZ</font>
    CLEAR gs_re_line.

    gs_re_line-bukrs = gs_line-bukrs.
    gs_re_line-belnr = gv_reverse_belnr.
    gs_re_line-gjahr = sy-datum(4).
    gs_re_line-buzei = gs_line-buzei.
    gs_re_line-saknr = gs_line-saknr.
    IF gs_line-saknr = ls_bp-bpact.
      gs_re_line-bpact = ls_bp-saknr.
    ENDIF.
    IF gs_line-partner IS NOT INITIAL.
      gs_re_line-partner = ls_bp-partner.
    ENDIF.
    gs_re_line-bschl = gs_line-bschl.
    gs_re_line-shkzg = SWITCH #( gs_line-shkzg
                                 WHEN 'S' THEN 'H'
                                 WHEN 'H' THEN 'S'
                                 ELSE gs_line-shkzg ).
    IF gs_line-ebeln IS NOT INITIAL.
      gs_re_line-ebeln = gs_line-ebeln.
    ENDIF.
    IF gs_line-vbeln IS NOT INITIAL.
      gs_re_line-vbeln = gs_line-vbeln.
    ENDIF.
    gs_re_line-koart = gs_line-koart.
    gs_re_line-wrbtr = gs_line-wrbtr.
    gs_re_line-waers = gs_line-waers.
    gs_re_line-sgtxt = |역분개: { gs_line-belnr }|.
    gs_re_line-erdat = sy-datum.
    gs_re_line-ernam = sy-uname.
    gs_re_line-erzet = sy-uzeit.

    APPEND gs_re_line TO gt_re_line.
    MODIFY zc102fit0010 FROM TABLE gt_re_line.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_clear</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_clear_data.

  DATA : ls_clear   TYPE zc102fit0016,
         lt_clear   TYPE TABLE OF zc102fit0016,
         ls_reverse TYPE zc102fit0009,
         lt_reverse TYPE TABLE OF zc102fit0009.

  " 반제 전표를 역분개 시키기 위해 원전표 반제일 반제전표
  CLEAR lt_clear.
  SELECT bukrs belnr gjahr buzei saknr bpact augbl augdt rebzg bschl
         shkzg koart sgtxt wrbtr dmbtr waers
    FROM zc102fit0016
    INTO CORRESPONDING FIELDS OF TABLE lt_clear
   WHERE belnr EQ gv_reverse-belnr.

  IF lt_clear IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  ls_clear = lt_clear[ 1 ]. " 킥
  CLEAR : gt_line.
  " 반제 전표에 들어있는 원전표 번호에서 미결 라인을 뽑아냄
  SELECT *
    FROM zc102fit0010
    INTO CORRESPONDING FIELDS OF TABLE gt_line
    WHERE belnr = ls_clear-rebzg. " 킥이 이쪽에서 이어짐

  " 미결 라인의 반제일과 반제전표 번호를 제거
  LOOP AT gt_line INTO gs_line.
    gs_line-augbl = ''.
    gs_line-augdt = ''.
    gs_line-aedat = sy-datum.
    gs_line-aenam = sy-uname.
    gs_line-aezet = sy-uzeit.
<font color ="#0000FF">* 반제일과 반제전표를 제거했으니 수정갱신</font>
    MODIFY gt_line FROM gs_line INDEX sy-tabix
                                TRANSPORTING augbl augdt
                                             aedat aenam aezet.
  ENDLOOP.

<font color ="#0000FF">* 관련 전표를 업데이트 침</font>
  MODIFY zc102fit0010 FROM TABLE gt_line.

<font color ="#0000FF">* 역분개 전표 라인아이템을 생성하기위해</font>
  MOVE-CORRESPONDING gt_line TO gt_re_line.

  LOOP AT gt_re_line INTO gs_re_line.

    CASE gs_re_line-shkzg.
      WHEN 'H'.
        gs_re_line-shkzg = 'S'.
      WHEN 'S'.
        gs_re_line-shkzg = 'H'.
    ENDCASE.

    gs_re_line-belnr = gv_reverse_belnr.
    gs_re_line-sgtxt = |역분개: { ls_clear-rebzg }|.
    gs_re_line-erdat = sy-datum.
    gs_re_line-ernam = sy-uname.
    gs_re_line-erzet = sy-uzeit.
    gs_re_line-aedat = ''.
    gs_re_line-aenam = ''.
    gs_re_line-aezet = ''.

    MODIFY gt_re_line FROM gs_re_line INDEX sy-tabix
                                      TRANSPORTING shkzg belnr sgtxt
                                                   erdat ernam erzet
                                                   aedat aenam aezet.

  ENDLOOP.

  MODIFY zc102fit0010 FROM TABLE gt_re_line.

  IF gs_line-augbl IS INITIAL.
    MESSAGE 'Clearing ' && gv_reverse-belnr && ' reset' TYPE 'I'.
  ENDIF.

ENDFORM.
</pre>
<hr>
<font size="2" face = "Sans Serif">Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 758
</font>
</body>
</html>
