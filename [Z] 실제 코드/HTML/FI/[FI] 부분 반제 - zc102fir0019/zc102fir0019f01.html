<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>ZC102FIR0019F01</title>
</head>
<body bgcolor="#FFFFE0">
<font size="3" face = "Arial" color="#000000"><b>Code listing for: ZC102FIR0019F01</b></font>
<br>
<font size="3" face = "Arial" color="#000000"><b>Description:  Include ZC102FIR0019F01</b></font>
<hr>
<pre width="100">
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Include          ZC102FIR0019F01</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_screen_0100</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_screen_0100 .

  IF go_split_cont IS NOT BOUND.

    CLEAR : gt_fcat_open, gs_fcat_open.
    PERFORM set_fcat_open USING :
                          'X' 'BELNR'       'ZC102FIT0010' 'C' ' ',
                          'X' 'GJAHR'       'ZC102FIT0010' 'C' ' ',
                          'X' 'BUZEI'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'SAKNR'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'TXT20'       'ZC102FIT0002' ' ' 'X',
                          ' ' 'AUGBL'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'AUGDT'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'BSCHL'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'LTEXT'       'ZC102FIT0004' ' ' 'X',
                          ' ' 'SHKZG'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'KOART'       'ZC102FIT0010' 'C' ' ',
<font color ="#0000FF">*                          ' ' 'PARTNER'     'ZC102FIT0010' 'C' ' ',</font>
                          ' ' 'SGTXT'       'ZC102FIT0010' ' ' 'X',
                          ' ' 'EBELN'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'VBELN'       'ZC102FIT0010' 'C' ' ',
                          ' ' 'WRBTR'       'ZC102FIT0010' ' ' 'X',
                          ' ' 'DMBTR'       'ZC102FIT0010' ' ' 'X',
                          ' ' 'WAERS'       'ZC102FIT0010' 'C' ' '.

    CLEAR : gt_fcat_clear, gs_fcat_clear.
    PERFORM set_fcat_clear USING :
<font color ="#0000FF">*                          'X' 'AUGBL'       'ZC102FIT0016' 'C' ' ',</font>
                          'X' 'BELNR'       'ZC102FIT0016' 'C' ' ',
                          'X' 'GJAHR'       'ZC102FIT0016' 'C' ' ',
                          'X' 'BUZEI'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'SAKNR'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'TXT20'       'ZC102FIT0002' ' ' 'X',
                          ' ' 'AUGDT'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'REBZG'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'BSCHL'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'LTEXT'       'ZC102FIT0004' ' ' 'X',
                          ' ' 'SHKZG'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'KOART'       'ZC102FIT0016' 'C' ' ',
<font color ="#0000FF">*                          ' ' 'PARTNER'     'ZC102FIT0016' 'C' ' ',</font>
                          ' ' 'SGTXT'       'ZC102FIT0016' ' ' 'X',
                          ' ' 'WRBTR'       'ZC102FIT0016' ' ' 'X',
                          ' ' 'WAERS'       'ZC102FIT0016' 'C' ' ',
                          ' ' 'SORT_KEY'    ' '            ' ' ' '.

    PERFORM set_layout_open.
    PERFORM set_layout_clear.
    PERFORM create_object.

<font color ="#0000FF">*    SET HANDLER lcl_event_handler=&gt;hotspot_click FOR go_left_grid.</font>
    CALL METHOD go_left_grid-&gt;set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout_open
      CHANGING
        it_outtab       = gt_open
        it_fieldcatalog = gt_fcat_open
        it_sort         = gt_sort_open.

    CALL METHOD go_right_grid-&gt;set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout_clear
      CHANGING
        it_outtab       = gt_clear
        it_fieldcatalog = gt_fcat_clear
        it_sort         = gt_sort_clear.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_fcat_line</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_fcat_open USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat_open-key       = pv_key.
  gs_fcat_open-fieldname = pv_field.
  gs_fcat_open-ref_table = pv_table.
  gs_fcat_open-just      = pv_just.
  gs_fcat_open-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'WRBTR'.
      gs_fcat_open-cfieldname = 'WAERS'.
      gs_fcat_open-do_sum     = abap_true.
<font color ="#0000FF">*    WHEN 'BELNR'.</font>
<font color ="#0000FF">*      gs_fcat_open-hotspot    = abap_true.</font>
  ENDCASE.

  APPEND gs_fcat_open TO gt_fcat_open.
  CLEAR gs_fcat_open.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_layout</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_layout_open .

  gs_layout_open-zebra      = abap_true.
  gs_layout_open-cwidth_opt = 'A'.
  gs_layout_open-sel_mode   = ' '.
  gs_layout_open-grid_title = TEXT-t01.
<font color ="#0000FF">*  gs_layout_open-totals_bef = abap_true. " Total 칼럼 맨 위로 올리기</font>
  gs_layout_open-no_totline = abap_true.

  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV1'.

<font color ="#0000FF">*-- SET SORT</font>
  CLEAR : gt_sort_open, gs_sort_open.
  gs_sort_open-spos      = 1.
  gs_sort_open-fieldname = 'BELNR'.
  gs_sort_open-up        = abap_true.
  gs_sort_open-subtot    = abap_true.
  APPEND gs_sort_open TO gt_sort_open.

  CLEAR : gs_sort_open.
  gs_sort_open-spos      = 2.
  gs_sort_open-fieldname = 'BUZEI'.
  gs_sort_open-up        = abap_true.
  APPEND gs_sort_open TO gt_sort_open.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_object</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_object .

  CREATE OBJECT go_container
    EXPORTING
      container_name = 'MAIN_CONT'.

  CREATE OBJECT go_split_cont
    EXPORTING
      parent  = go_container
      rows    = 2
      columns = 1.

  CALL METHOD go_split_cont-&gt;get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_left_cont.

  CALL METHOD go_split_cont-&gt;set_row_height
    EXPORTING
      id     = 1     " 첫 번째 행 (상단)
      height = 40.   " 퍼센트 기준


  CALL METHOD go_split_cont-&gt;get_container
    EXPORTING
      row       = 2
      column    = 1
    RECEIVING
      container = go_right_cont.

  CALL METHOD go_split_cont-&gt;set_row_height
    EXPORTING
      id     = 2     " 두 번째 행 (하단)
      height = 60.   " 퍼센트 기준

  CREATE OBJECT go_left_grid
    EXPORTING
      i_parent = go_left_cont.

  CREATE OBJECT go_right_grid
    EXPORTING
      i_parent = go_right_cont.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_open_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_open_data .

  DATA : lv_tabix TYPE sy-tabix.

  CLEAR : gt_open.
  SELECT bukrs belnr gjahr buzei saknr bpact augdt augbl bschl shkzg koart
         partner sgtxt ebeln vbeln wrbtr waers
         erdat ernam erzet aedat aenam aezet
    INTO CORRESPONDING FIELDS OF TABLE gt_open
    FROM zc102fit0010
    WHERE bukrs = gs_header-bukrs
      AND belnr = gs_header-belnr
      AND gjahr = gs_header-gjahr.

  IF sy-dbcnt = 0.
    MESSAGE s004 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  CLEAR gv_partner.
  LOOP AT gt_open INTO gs_open.

    lv_tabix = sy-tabix.
    IF gs_open-bpact IS NOT INITIAL.
      gs_open-saknr = gs_open-bpact.
      gv_partner = gs_open-partner.
      MODIFY gt_open FROM gs_open INDEX lv_tabix TRANSPORTING saknr.
    ENDIF.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_open_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_open_credit .

  CLEAR gv_sum_open.
  gv_waers_open = gs_header-waers.

  gv_sum_open = gt_open[ 1 ]-wrbtr.
<font color ="#0000FF">*  LOOP AT gt_open INTO gs_open.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    IF gs_open-shkzg = 'S'.</font>
<font color ="#0000FF">*      gv_sum_open += gs_open-wrbtr.</font>
<font color ="#0000FF">*    ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  ENDLOOP.</font>

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_fcat_clear</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_fcat_clear USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat_clear-key       = pv_key.
  gs_fcat_clear-fieldname = pv_field.
  gs_fcat_clear-ref_table = pv_table.
  gs_fcat_clear-just      = pv_just.
  gs_fcat_clear-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'WRBTR'.
      gs_fcat_clear-cfieldname = 'WAERS'.
      gs_fcat_clear-do_sum     = abap_true.
    WHEN 'SORT_KEY'.
      gs_fcat_clear-no_out = abap_true.
  ENDCASE.

  APPEND gs_fcat_clear TO gt_fcat_clear.
  CLEAR gs_fcat_clear.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_layout_clear</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_layout_clear .

  gs_layout_clear-zebra      = abap_true.
  gs_layout_clear-cwidth_opt = 'A'.
  gs_layout_clear-sel_mode   = ' '.
  gs_layout_clear-ctab_fname = 'COLOR'.
  gs_layout_clear-grid_title = TEXT-t02.
<font color ="#0000FF">*  gs_layout_open-totals_bef = abap_true. " Total 칼럼 맨 위로 올리기</font>
  gs_layout_clear-no_totline = abap_true.

<font color ="#0000FF">*-- SET SORT</font>
<font color ="#0000FF">*-- 새로 생긴 아이템 맨 위로</font>
  CLEAR : gt_sort_clear, gs_sort_clear.
  gs_sort_clear-spos = 1.
  gs_sort_clear-fieldname = 'SORT_KEY'.
  gs_sort_clear-up = abap_false.
  APPEND gs_sort_clear TO gt_sort_clear.

<font color ="#0000FF">*-- AUGBL 별 차/대변 합 구해야 함</font>
  CLEAR : gs_sort_clear.
  gs_sort_clear-spos      = 2.
  gs_sort_clear-fieldname = 'BELNR'.
  gs_sort_clear-up        = abap_true.
  gs_sort_clear-subtot    = abap_true.
  APPEND gs_sort_clear TO gt_sort_clear.

  CLEAR : gs_sort_clear.
  gs_sort_clear-spos = 3.
  gs_sort_clear-fieldname = 'BUZEI'.
  gs_sort_clear-up = abap_false.
  APPEND gs_sort_clear TO gt_sort_clear.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_hotspot_click</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_COLUMN_ID</font>
<font color ="#0000FF">*&      --&gt; E_ROW_ID</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_hotspot_click USING pv_column_id pv_row_id.

  DATA : lv_type TYPE dd01v-datatype.

  CALL FUNCTION 'NUMERIC_CHECK'
    EXPORTING
      string_in = pv_row_id
    IMPORTING
      htype     = lv_type.

  IF lv_type = 'CHAR'.
    MESSAGE s015 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.


  READ TABLE gt_open INTO gs_open INDEX pv_row_id.

  CHECK gs_open IS NOT INITIAL.

  CASE pv_column_id.
    WHEN 'BELNR'.
      PERFORM get_clear_data.
      PERFORM refresh_alv_grid.
  ENDCASE.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_clear_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_clear_data .

  DATA : lv_tabix TYPE sy-tabix.

  CLEAR gt_clear.
  SELECT belnr gjahr buzei rebzg saknr bpact augdt bschl shkzg koart
         partner sgtxt dmbtr wrbtr waers
         erdat ernam erzet aedat aenam aezet
    INTO CORRESPONDING FIELDS OF TABLE gt_clear
    FROM zc102fit0016
    WHERE bukrs = gs_header-bukrs
      AND rebzg = gs_header-belnr
      AND gjahr = gs_header-gjahr.

  LOOP AT gt_clear INTO gs_clear.

    lv_tabix = sy-tabix.
    IF gs_clear-bpact IS NOT INITIAL.
      gs_clear-saknr = gs_clear-bpact.

      MODIFY gt_clear FROM gs_clear INDEX lv_tabix TRANSPORTING saknr.
    ENDIF.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_alv_grid</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM refresh_alv_grid .

  DATA : ls_stable TYPE lvc_s_stbl.

  ls_stable-col = abap_true.
  ls_stable-row = abap_true.

  CALL METHOD go_left_grid-&gt;refresh_table_display
    EXPORTING
      is_stable = ls_stable.

  CALL METHOD go_right_grid-&gt;refresh_table_display
    EXPORTING
      is_stable = ls_stable.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_clear_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_clear_credit .

  CLEAR gv_sum_clear.
  gv_waers_clear = gs_header-waers.

  LOOP AT gt_clear INTO gs_clear.

    IF gs_clear-shkzg = 'S'.
      gv_sum_clear += gs_clear-wrbtr.
    ENDIF.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_remain_credit</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_remain_credit .

  gv_remain = gv_sum_open - gv_sum_clear.
  gv_waers_remain = gs_header-waers.

  IF gv_sum_clear = 0.
    gv_status = icon_led_red.
  ELSEIF gv_remain &gt; 0.
    gv_status = icon_led_yellow.
  ELSEIF gv_remain = 0.
    gv_status = icon_led_green.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_basic_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_basic_data .

  gs_clear_header-bldat = sy-datum.
  gs_clear_header-bukrs = gs_header-bukrs.
  gs_clear_header-rebzg = gs_header-belnr.
  gs_clear_header-waers = gs_header-waers.
  gs_clear_header-gjahr = gs_header-gjahr.
  gs_clear_header-budat = sy-datum.
  gs_clear_item-augdt = sy-datum.

  CASE gs_header-blart.
    WHEN 'DR'.
      gs_clear_header-blart = 'DZ'.
    WHEN 'KR'.
      gs_clear_header-blart = 'KZ'.
    WHEN 'SA'.
      gs_clear_header-blart = 'SA'.
  ENDCASE.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form clear_item</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM clear_item .

  DATA : lv_check.

  PERFORM call_popup USING TEXT-q04 TEXT-q02 lv_check.
  CHECK lv_check = '1'.
  CLEAR gs_clear_item.
  MESSAGE s020.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form call_popup</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; LV_CHECK</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM call_popup USING pv_title pv_question pv_check.

  call function <a href ="zfm_cl102_cm_pop_up/zfm_cl102_cm_pop_up.html">'ZFM_CL102_CM_POP_UP'</a>
    EXPORTING
      iv_titlebar = pv_title
      iv_question = pv_question
    IMPORTING
      ev_answer   = pv_check.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_screen_0110</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_screen_0110 .

  IF go_pop_clear_cont IS NOT BOUND.

    CLEAR : gt_fcat_pop_clear, gs_fcat_pop_clear.
    PERFORM set_fcat_pop_clear USING :
<font color ="#0000FF">*                               'X' 'BUZEI'       'ZC102FIT0016' 'C' ' ',</font>
                               ' ' 'SAKNR'       'ZC102FIT0016' 'C' ' ',
                               ' ' 'TXT20'       'ZC102FIT0002' ' ' 'X',
                               ' ' 'AUGDT'       'ZC102FIT0016' 'C' ' ',
                               ' ' 'REBZG'       'ZC102FIT0016' 'C' ' ',
                               ' ' 'BSCHL'       'ZC102FIT0016' 'C' ' ',
                               ' ' 'LTEXT'       'ZC102FIT0004' ' ' 'X',
                               ' ' 'SHKZG'       'ZC102FIT0016' 'C' ' ',
                               ' ' 'KOART'       'ZC102FIT0016' 'C' ' ',
<font color ="#0000FF">*                               ' ' 'PARTNER'     'ZC102FIT0016' 'C' ' ',</font>
                               ' ' 'SGTXT'       'ZC102FIT0016' ' ' 'X',
                               ' ' 'WRBTR'       'ZC102FIT0016' ' ' 'X',
                               ' ' 'WAERS'       'ZC102FIT0016' 'C' ' '.

    PERFORM set_layout_pop_clear.
    PERFORM set_exclude_toolbar.
    PERFORM create_object_pop_clear.

    SET HANDLER : lcl_event_handler=&gt;edit_toolbar FOR go_pop_clear_grid,
                  lcl_event_handler=&gt;user_command FOR go_pop_clear_grid.
    CALL METHOD go_pop_clear_grid-&gt;set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout_pop_clear
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_clear_item
        it_fieldcatalog      = gt_fcat_pop_clear.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_fcat_pop_clear</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_fcat_pop_clear USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat_pop_clear-key       = pv_key.
  gs_fcat_pop_clear-fieldname = pv_field.
  gs_fcat_pop_clear-ref_table = pv_table.
  gs_fcat_pop_clear-just      = pv_just.
  gs_fcat_pop_clear-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'WRBTR'.
      gs_fcat_pop_clear-cfieldname = 'WAERS'.
      gs_fcat_pop_clear-do_sum     = abap_true.
  ENDCASE.

  APPEND gs_fcat_pop_clear TO gt_fcat_pop_clear.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_layout_pop</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_layout_pop_clear .

  gs_layout_pop_clear-zebra      = abap_true.
  gs_layout_pop_clear-cwidth_opt = 'A'.
  gs_layout_pop_clear-sel_mode   = 'D'.
  gs_layout_pop_clear-grid_title = TEXT-t02.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_object_pop_clear</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_object_pop_clear .

  CREATE OBJECT go_pop_clear_cont
    EXPORTING
      container_name = 'MAIN_CONT'.

  CREATE OBJECT go_pop_clear_grid
    EXPORTING
      i_parent = go_pop_clear_cont.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form make_clear_item</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM make_clear_item .

  DATA : lv_check VALUE abap_true.

<font color ="#0000FF">*-- 필수 입력 칸이 비어있는지 체크</font>
  PERFORM check_field_empty USING lv_check.
  CLEAR gv_okcode.  " gv_okcode 초기화 -&gt; 안하면 계속 MAKE라서 진행이 안됨
  CHECK lv_check = abap_true. " 빈 필드있으면 나가기

<font color ="#0000FF">*-- gv_missing_field 초기화</font>
  CLEAR gv_missing_field.

<font color ="#0000FF">*-- gt_bschl(전기키 마스터 데이터) 기반으로 shkgz, koart, ltext 값 가져오기</font>
  PERFORM set_bschl_data.

<font color ="#0000FF">*-- SAP 금액, 순번 지정 -&gt; 기본값 세팅</font>
  PERFORM set_basic_clear_data.

<font color ="#0000FF">*-- ITAB에 넣고 갱신</font>
  READ TABLE gt_saknr INTO gs_saknr WITH KEY gs_clear_item-saknr
                                    BINARY SEARCH.
  IF sy-subrc = 0.
    gs_clear_item-txt20 = gs_saknr-txt20.
  ENDIF.
  APPEND gs_clear_item TO gt_clear_item.
  PERFORM refresh_pop_clear_grid.

<font color ="#0000FF">*-- 반제 전표 차/대변 금액 합 계산</font>
  PERFORM set_clear_sum.

<font color ="#0000FF">*-- 다쓴 아이템 필드 비우기</font>
  CLEAR gs_clear_item.
  gs_clear_item-waers = gs_clear_header-waers.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_pop_clear_grid</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM refresh_pop_clear_grid .

  go_pop_clear_grid-&gt;refresh_table_display( ).
  CLEAR gs_clear_item.
  " 강제 PBO 메소드
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_bschl_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_bschl_data .

  CLEAR gt_bschl.
  SELECT bschl shkzg koart ltext
    INTO CORRESPONDING FIELDS OF TABLE gt_bschl
    FROM zc102fit0004.

  SORT gt_bschl ASCENDING BY bschl.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_bschl_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_bschl_data .

  CLEAR gs_bschl.
  READ TABLE gt_bschl INTO gs_bschl WITH KEY gs_clear_item-bschl
                                    BINARY SEARCH.

  IF sy-subrc = 0.

    gs_clear_item-shkzg = gs_bschl-shkzg.
    gs_clear_item-koart = gs_bschl-koart.
    gs_clear_item-ltext = gs_bschl-ltext.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_basic_clear_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_basic_clear_data .

<font color ="#0000FF">*-- 환전 팡숀</font>
<font color ="#0000FF">*  CALL FUNCTION 'CURRENCY_AMOUNT_IDOC_TO_SAP'</font>
<font color ="#0000FF">*    EXPORTING</font>
<font color ="#0000FF">*      currency    = gs_clear_item-waers</font>
<font color ="#0000FF">*      idoc_amount = gs_clear_item-wrbtr</font>
<font color ="#0000FF">*    IMPORTING</font>
<font color ="#0000FF">*      sap_amount  = gs_clear_item-wrbtr.</font>

<font color ="#0000FF">*-- 반제 전표 번호, 회사코드, 회계연도 지정 -&gt; 헤더껄로</font>
  gs_clear_item-bukrs = gs_clear_header-bukrs.
<font color ="#0000FF">*  gs_clear_item-belnr = gs_clear_header-belnr.</font>
  gs_clear_item-rebzg = gs_header-belnr.
  gs_clear_item-gjahr = gs_clear_header-gjahr.

  IF gs_clear_item-wrbtr &lt; 0.
    gs_clear_item-wrbtr *= -1.
  ENDIF.

<font color ="#0000FF">*-- 대변일 경우 음수 처리</font>
  IF gs_clear_item-shkzg = 'H'.
    gs_clear_item-wrbtr = -1 * gs_clear_item-wrbtr.
  ENDIF.

<font color ="#0000FF">*  gs_clear_item = VALUE #( BASE gs_clear_item</font>
<font color ="#0000FF">*                                buzei = lines( gt_clear_item ) + 1 ).</font>


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_screen_data_0110</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_screen_data_0110 .

  DATA : lv_budat TYPE string.

<font color ="#0000FF">*-- 전표 유형 선택 시 오른쪽에 상세 텍스트 출력</font>
  IF gs_clear_header-blart IS NOT INITIAL.
    CLEAR gs_blart.
    READ TABLE gt_blart INTO gs_blart
                        WITH KEY gs_clear_header-blart
                        BINARY SEARCH.
    gs_clear_header-ltext = gs_blart-ltext.

  ENDIF.

<font color ="#0000FF">*-- 날짜 형식 2025/07/11, 2025-07-11 입력도 OK로 만들기</font>
  IF gs_clear_header-budat IS NOT INITIAL.
    lv_budat = gs_clear_header-budat.
  ENDIF.

<font color ="#0000FF">*-- 라인 아이템 통화키 동기화</font>
  IF gs_clear_item-waers IS INITIAL.
    gs_clear_item-waers = gs_clear_header-waers.
  ENDIF.

<font color ="#0000FF">*-- 계정과목에 따라 BPACT 값 입력</font>
  PERFORM set_bpact_data.

<font color ="#0000FF">*-- 생성 전표 아이템 금액 합계에 따른 생성 가능 여부</font>
  IF ( gt_clear_item IS INITIAL ) OR
     ( gv_clear_sum NE 0 ).
    gv_clear_status = icon_led_red.
  ELSEIF gv_clear_sum = 0.
    gv_clear_status = icon_led_green.
  ENDIF.

<font color ="#0000FF">*-- bschl가 유효하지 않다면</font>
  CLEAR gs_bschl.
  READ TABLE gt_bschl INTO gs_bschl
                      WITH KEY bschl = gs_clear_item-bschl.
  IF ( gs_bschl IS NOT INITIAL ) AND
     ( gs_bschl IS INITIAL ).
    MESSAGE s026 WITH '전기키' DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- Screen 세팅</font>
  LOOP AT SCREEN.
<font color ="#0000FF">*-- 필수 필드가 비어있다면 해당 필드를 강조하고 다른 모든 필드 잠그기</font>
    IF screen-group2 = 'IOF'.
      IF gv_missing_field IS NOT INITIAL.
        IF screen-name = gv_missing_field.
          screen-input = 1.
          screen-intensified = '1'.
        ELSE.
          screen-input = 0.
        ENDIF.
      ELSE.
        screen-input = 1.
        screen-intensified = 0.
      ENDIF.
    ENDIF.

<font color ="#0000FF">*-- 조정계정 필드 없애기</font>
    IF screen-group1 = 'ACT'.
      IF gs_clear_item-bpact IS INITIAL.
        screen-invisible = 1.
      ENDIF.
    ENDIF.

    IF gv_missing_field IS INITIAL.
<font color ="#0000FF">*-- 전기키 제외 다른 필드 잠그기</font>
      IF screen-group1 = 'FST'.
        IF gs_clear_item-bschl IS INITIAL.
          screen-input = 0.
        ELSE.
          screen-input = 1.
        ENDIF.
      ENDIF.

      IF screen-name = 'GS_CLEAR_ITEM-BSCHL'.
        IF gs_clear_item-bschl IS INITIAL.
          screen-input = 1.
        ELSE.
          screen-input = 0.
        ENDIF.
      ENDIF.
    ENDIF.


<font color ="#0000FF">*-- gt_clear_line(반제 전표 아이템)이 비어있지 않다면 Header 잠그기</font>
<font color ="#0000FF">*    CASE screen-group1.</font>
<font color ="#0000FF">*      WHEN 'LOC'.</font>
<font color ="#0000FF">*        IF gt_clear_item IS NOT INITIAL.</font>
<font color ="#0000FF">*          screen-input = 0.</font>
<font color ="#0000FF">*        ENDIF.</font>
<font color ="#0000FF">*    ENDCASE.</font>

    MODIFY SCREEN.
  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_blart_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_blart_data .

  CLEAR gt_blart.
  SELECT blart ltext
    INTO CORRESPONDING FIELDS OF TABLE gt_blart
    FROM zc102fit0005
    WHERE spras = sy-langu.

  SORT gt_blart ASCENDING BY blart.

ENDFORM.
FORM set_exclude_toolbar .

<font color ="#0000FF">*-- 툴바 제거</font>
  DATA : ls_ui_functions TYPE ui_func.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_undo.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_copy.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_copy_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_cut.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_delete_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_insert_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_append_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_paste.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_loc_paste_new_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_refresh.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_auf.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_average.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_print.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=&gt;mc_fc_graph.
  APPEND ls_ui_functions TO gt_ui_functions.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_edit_toolbar</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_INTERACTIVE</font>
<font color ="#0000FF">*&      --&gt; E_OBJECT</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_edit_toolbar USING pv_interactive
                               po_object TYPE REF TO
                                          cl_alv_event_toolbar_set.

  DATA : lv_enable.

<font color ="#0000FF">*-- 테이블 비었으면 삭제버튼 비활성화</font>
  IF gt_clear_item IS INITIAL.
    lv_enable = abap_true.
  ENDIF.

  CLEAR gs_button.

<font color ="#0000FF">*-- 구분선 생성</font>
  PERFORM make_division_line USING po_object.

<font color ="#0000FF">*-- 삭제 버튼 생성</font>
  PERFORM make_button USING 'DROW' icon_delete_row
                            lv_enable po_object.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form make_division_line</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; PO_OBJECT</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM make_division_line USING po_object TYPE REF TO
                                          cl_alv_event_toolbar_set.

  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object-&gt;mt_toolbar.
  CLEAR gs_button.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form make_button</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; ICON_DELETE_ROW</font>
<font color ="#0000FF">*&      --&gt; LV_ENABLE</font>
<font color ="#0000FF">*&      --&gt; PO_OBJECT</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM make_button USING pv_func pv_icon pv_enable
                       po_object TYPE REF TO cl_alv_event_toolbar_set.

  gs_button-function = pv_func.
  gs_button-icon     = pv_icon.
  gs_button-disabled = pv_enable.
  APPEND gs_button TO po_object-&gt;mt_toolbar.
  CLEAR gs_button.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_field_empty</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_field_empty USING pv_check.

<font color ="#0000FF">*-- blart가 유효하지 않다면</font>
  CLEAR gs_blart.
  READ TABLE gt_blart INTO gs_blart
                      WITH KEY blart = gs_clear_header-blart.
  IF gs_blart IS INITIAL.
    gv_missing_field = 'GS_CLEAR_HEADER-BLART'.
    MESSAGE s026 WITH '전표유형' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- blart가 비었다면</font>
  IF gs_clear_header-blart IS INITIAL.
    gv_missing_field = 'GS_CLEAR_HEADER-BLART'.
    MESSAGE s022 WITH '전표유형' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- budat가 비었다면</font>
  IF gs_clear_header-budat IS INITIAL.
    gv_missing_field = 'GS_CLEAR_HEADER-BUDAT'.
    MESSAGE s022 WITH '전기일' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- budat가 유효하지 않다면</font>
  IF gs_clear_header-budat &lt; gs_clear_header-bldat.
    gv_missing_field = 'GS_CLEAR_HEADER-BUDAT'.
    MESSAGE s059 WITH '전기일' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- bktxt가 비었다면</font>
  IF gs_clear_header-bktxt IS INITIAL.
    gv_missing_field = 'GS_CLEAR_HEADER-BKTXT'.
    MESSAGE s022 WITH '전표텍스트' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- bschl가 유효하지 않다면</font>
  CLEAR gs_bschl.
  READ TABLE gt_bschl INTO gs_bschl
                      WITH KEY bschl = gs_clear_item-bschl.
  IF gs_bschl IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-BSCHL'.
    MESSAGE s026 WITH '전기키' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- bschl가 비었다면</font>
  IF gs_clear_item-bschl IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-BSCHL'.
    MESSAGE s022 WITH '전기키' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- saknr가 유효하지 않다면</font>
  CLEAR gs_saknr.
  READ TABLE gt_saknr INTO gs_saknr
                      WITH KEY saknr = gs_clear_item-saknr.
  IF gs_saknr IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-SAKNR'.
    MESSAGE s026 WITH '계정과목' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- saknr가 비었다면</font>
  IF gs_clear_item-saknr IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-SAKNR'.
    MESSAGE s022 WITH '계정과목' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- augdt가 비었다면</font>
  IF gs_clear_item-augdt IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-AUGDT'.
    MESSAGE s022 WITH '반제일' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- wrbtr가 비었다면</font>
  IF gs_clear_item-wrbtr IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-WRBTR'.
    MESSAGE s022 WITH '입력 금액' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.

<font color ="#0000FF">*  CLEAR gs_partner.</font>
<font color ="#0000FF">*  READ TABLE gt_partner INTO gs_partner</font>
<font color ="#0000FF">*                      WITH KEY partner = gs_clear_item-partner.</font>
<font color ="#0000FF">*  IF gs_partner IS INITIAL.</font>
<font color ="#0000FF">*    gv_missing_field = 'GS_CLEAR_ITEM-PARTNER'.</font>
<font color ="#0000FF">*    MESSAGE s026 WITH '비즈니스 파트너' DISPLAY LIKE 'E'.</font>
<font color ="#0000FF">*    pv_check = abap_false.</font>
<font color ="#0000FF">*    EXIT.</font>
<font color ="#0000FF">*  ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">**-- partner가 비었다면</font>
<font color ="#0000FF">*  IF gs_clear_item-partner IS INITIAL.</font>
<font color ="#0000FF">*    gv_missing_field = 'GS_CLEAR_ITEM-PARTNER'.</font>
<font color ="#0000FF">*    MESSAGE s022 WITH '비즈니스 파트너' DISPLAY LIKE 'E'.</font>
<font color ="#0000FF">*    pv_check = abap_false.</font>
<font color ="#0000FF">*    EXIT.</font>
<font color ="#0000FF">*  ENDIF.</font>

<font color ="#0000FF">*-- sgtxt가 비었다면</font>
  IF gs_clear_item-sgtxt IS INITIAL.
    gv_missing_field = 'GS_CLEAR_ITEM-SGTXT'.
    MESSAGE s022 WITH '아이템 텍스트' DISPLAY LIKE 'E'.
    pv_check = abap_false.
    EXIT.
  ENDIF.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_field_not_empty</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_field_not_empty .

<font color ="#0000FF">*-- Field Symbol을 통해서 입력 필드 값을 Assign</font>
  ASSIGN (gv_missing_field) TO &lt;gs_fs&gt;.

<font color ="#0000FF">*-- 만약 &lt;gs_fs&gt; 즉 필드와 깂이 있다면 gv_missing_field를 초기화해서 스크린 페인터 초기화</font>
  IF sy-subrc = 0 AND &lt;gs_fs&gt; IS NOT INITIAL.
    CLEAR gv_missing_field.
    UNASSIGN &lt;gs_fs&gt;.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_clear_sum</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_clear_sum .

  CLEAR : gv_clear_sum, gv_clear_debit.
  LOOP AT gt_clear_item INTO gs_clear_item.
    gv_clear_sum += gs_clear_item-wrbtr.

<font color ="#0000FF">*-- 반제 금액 총 합</font>
    IF gs_clear_item-shkzg = 'S'.
      gv_clear_debit += gs_clear_item-wrbtr.
    ENDIF.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_user_command</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_UCOMM</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_user_command USING pv_ucomm.

  CASE pv_ucomm.
    WHEN 'DROW'.
      PERFORM delete_row.
  ENDCASE.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form delete_row</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM delete_row .

  DATA : lt_roid TYPE lvc_t_roid.

  go_pop_clear_grid-&gt;get_selected_rows( IMPORTING et_row_no = lt_roid ).

  SORT lt_roid DESCENDING BY row_id.
  LOOP AT lt_roid INTO DATA(ls_roid).

<font color ="#0000FF">*-- 0번은 통계 필드임</font>
    IF ls_roid-row_id &gt; 0.
      DELETE gt_clear_item INDEX ls_roid-row_id.
    ENDIF.

  ENDLOOP.

  PERFORM refresh_pop_clear_grid.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form save_clear_item</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM save_clear_item .

  DATA : lt_clear_item TYPE TABLE OF zc102fit0016,
         lv_check,
         lv_belnr      TYPE string. "반제 전표 번호

<font color ="#0000FF">*-- 반제 전표 아이템 테이블이 비었다면 필터</font>
  IF gt_clear_item IS INITIAL.
    MESSAGE i016 DISPLAY LIKE 'E'.
    EXIT.
<font color ="#0000FF">*-- 반제 전표 차/대변 합이 0이 아니라면 필터</font>
  ELSEIF gv_clear_sum NE 0.
    MESSAGE i014 DISPLAY LIKE 'E'.
    EXIT.
<font color ="#0000FF">*-- 입력 반제액이 미결잔액 보다 크다면 필터</font>
  ELSEIF ( gv_remain - gv_clear_debit ) &lt; 0.
    MESSAGE i024 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- 팝업 스크린 출력</font>
  PERFORM call_popup USING TEXT-q03 TEXT-q01 lv_check.
  CHECK lv_check = '1'.

<font color ="#0000FF">*-- 전표 번호 가져오기</font>
  PERFORM set_next_value USING lv_belnr.

<font color ="#0000FF">*-- 헤더 생성</font>
  CLEAR gs_clear_header_s.
  " 타임스탬프 및 생성 전표번호 박기
  PERFORM set_timestamp_header USING lv_belnr.
  MOVE-CORRESPONDING gs_clear_header TO gs_clear_header_s.
  MODIFY zc102fit0009 FROM gs_clear_header_s.

<font color ="#0000FF">*-- 아이템들 생성</font>
  CLEAR lt_clear_item.
  " 타임스탬프 박기 및 생성 전표번호(반제전표 번호) 박기 및 대변 양수로 변경
  PERFORM set_remain_data USING lv_belnr.
  MOVE-CORRESPONDING gt_clear_item TO lt_clear_item.
  MODIFY zc102fit0016 FROM TABLE lt_clear_item.

  IF sy-subrc = 0.
    COMMIT WORK AND WAIT.
<font color ="#0000FF">*-- 저장이 성공했다면 저장 팝업 종료 및 원 화면 갱신</font>
    PERFORM clear_save USING lv_belnr.
  ELSE.
    ROLLBACK WORK.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_timestamp</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_timestamp_header USING pv_belnr.

  gs_clear_header-belnr = pv_belnr.

  IF gs_clear_header-erdat IS INITIAL.
    gs_clear_header-erdat = sy-datum.
    gs_clear_header-ernam = sy-uname.
    gs_clear_header-erzet = sy-uzeit.
  ELSE.
    gs_clear_header-aedat = sy-datum.
    gs_clear_header-aenam = sy-uname.
    gs_clear_header-aezet = sy-uzeit.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_timestamp_item</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_remain_data USING pv_belnr.

  DATA : lv_tabix TYPE sy-tabix,
         lv_buzei TYPE zc102fit0016-buzei VALUE 1,
         lv_bpact TYPE zc102fit0016-bpact.

  SORT gt_clear_item BY shkzg DESCENDING.

  LOOP AT gt_clear_item INTO gs_clear_item.

    lv_tabix = sy-tabix.

<font color ="#0000FF">*-- 개별항목 세팅</font>
    gs_clear_item-buzei = lv_buzei.
    lv_buzei += 1.

<font color ="#0000FF">*-- 계정과목 조정계정 세팅</font>
    IF gs_clear_item-bpact IS NOT INITIAL.
      lv_bpact = gs_clear_item-bpact.
      gs_clear_item-bpact = gs_clear_item-saknr.
      gs_clear_item-saknr = lv_bpact.
    ENDIF.

<font color ="#0000FF">*-- 타임스태프 및 전표번호, 반제전표 번호 입력</font>
    gs_clear_item-belnr = pv_belnr.
    gs_clear_item-augbl = pv_belnr.
    IF gs_clear_item-erdat IS INITIAL.
      gs_clear_item-erdat = sy-datum.
      gs_clear_item-ernam = sy-uname.
      gs_clear_item-erzet = sy-uzeit.
    ELSE.
      gs_clear_item-aedat = sy-datum.
      gs_clear_item-aenam = sy-uname.
      gs_clear_item-aezet = sy-uzeit.
    ENDIF.

<font color ="#0000FF">*-- 대변 양수로 변경</font>
    IF gs_clear_item-shkzg = 'H'.
      gs_clear_item-wrbtr *= -1.
    ENDIF.

    MODIFY gt_clear_item FROM gs_clear_item INDEX lv_tabix
                                            TRANSPORTING
                                              aedat aenam aezet
                                              erdat ernam erzet
                                              augbl belnr wrbtr
                                              buzei bpact saknr.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_next_value</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; LV_AUGBL</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_next_value USING pv_belnr.

  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      object      = 'ZC102CM_AU'  " SNRO 오브젝트 이름
      nr_range_nr = '02'          " 인터벌 번호
      subobject   = 'BNR'         " Prefix (서브오브젝트)
      quantity    = 1
    IMPORTING
      number      = pv_belnr
    EXCEPTIONS
      OTHERS      = 1.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form clear_save</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM clear_save USING pv_belnr.

  DATA : lt_clear_item LIKE TABLE OF gs_clear.

  MESSAGE s007.
<font color ="#0000FF">*  PERFORM get_open_data.</font>
<font color ="#0000FF">*  PERFORM get_clear_data.</font>

<font color ="#0000FF">*-- 생성한 반제전표를 기존 메인 반제 전표 테이블로 이동</font>
  MOVE-CORRESPONDING gt_clear_item TO lt_clear_item.
  PERFORM set_color_item CHANGING lt_clear_item.        " 이동할 전표 아이템에 Color 데이터 추가
  INSERT LINES OF lt_clear_item INTO gt_clear INDEX 1.
<font color ="#0000FF">*  APPEND LINES OF lt_clear_item TO gt_clear.</font>
  PERFORM refresh_alv_grid.

<font color ="#0000FF">*-- 반제 상태(금액 정보) 갱신</font>
  PERFORM set_open_credit.
  PERFORM set_clear_credit.
  PERFORM set_remain_credit.

<font color ="#0000FF">*-- 반제가 완료되었다면...</font>
  IF gv_remain = 0.
    " 메시지 출력
    MESSAGE i023 DISPLAY LIKE 'S'.
    " 미결전표 반제처리
    PERFORM set_clear_field USING pv_belnr.
    PERFORM refresh_alv_grid.
  ENDIF.
<font color ="#0000FF">*-- 다쓴 아이템 필드 비우기</font>
  CLEAR gs_clear_item.
  PERFORM leave_to_0.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form leave_to_0</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM leave_to_0 .
  CLEAR : gt_clear_item, gs_clear_item, gs_clear_header, gv_missing_field.

  CALL METHOD : go_pop_clear_grid-&gt;free, go_pop_clear_cont-&gt;free.

  FREE : go_pop_clear_grid, go_pop_clear_cont.

  LEAVE TO SCREEN 0.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color_item</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_color_item CHANGING pt_clear_item LIKE gt_clear.

  DATA : lv_tabix TYPE sy-tabix,
         ls_scol  TYPE lvc_s_scol.

  LOOP AT pt_clear_item INTO DATA(ls_clear_item).

    lv_tabix = sy-tabix.

<font color ="#0000FF">*-- 대변 음수로 변경</font>
    IF ls_clear_item-shkzg = 'H'.
      ls_clear_item-wrbtr *= -1.
    ENDIF.

    PERFORM set_color USING ' ' 7 1 1 ' '
                      CHANGING ls_scol ls_clear_item.
    ls_clear_item-sort_key = 'A'.

    MODIFY pt_clear_item FROM ls_clear_item INDEX lv_tabix
                                            TRANSPORTING wrbtr
                                                         color
                                                         sort_key.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_7</font>
<font color ="#0000FF">*&      --&gt; P_1</font>
<font color ="#0000FF">*&      --&gt; P_1</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      &lt;-- LS_SCOL</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_color USING pv_field pv_color pv_int pv_inv pv_nokey
               CHANGING ps_scol TYPE lvc_s_scol
                        ps_clear_item LIKE gs_clear.

  ps_scol-fname = pv_field.
  ps_scol-color-col = pv_color.
  ps_scol-color-int = pv_int.
  ps_scol-color-inv = pv_inv.
  ps_scol-nokeycol = pv_nokey.
  INSERT ps_scol INTO TABLE ps_clear_item-color.
  CLEAR ps_scol.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_basic_color_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_basic_color_data .

  DATA : lv_tabix TYPE sy-tabix.

  LOOP AT gt_clear INTO gs_clear.

    lv_tabix = sy-tabix.

    CLEAR gs_clear-color.

    gs_clear-sort_key = 'B'.
    MODIFY gt_clear FROM gs_clear INDEX lv_tabix TRANSPORTING
                                                  sort_key color.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_clear_field</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_clear_field USING pv_belnr.

  DATA : lv_tabix  TYPE sy-tabix,
         lt_open_s TYPE TABLE OF zc102fit0010.

  LOOP AT gt_open INTO gs_open.

<font color ="#0000FF">*    lv_tabix = sy-tabix.</font>

<font color ="#0000FF">*    gs_open-augbl = pv_belnr.</font>
<font color ="#0000FF">*    gs_open-augdt = sy-datum.</font>
<font color ="#0000FF">*    gs_open-aedat = sy-datum.</font>
<font color ="#0000FF">*    gs_open-aenam = sy-uname.</font>
<font color ="#0000FF">*    gs_open-aezet = sy-uzeit.</font>

    UPDATE zc102fit0010 SET augbl = pv_belnr
                            augdt = sy-datum
                            aedat = sy-datum
                            aenam = sy-uname
                            aezet = sy-uzeit
                        WHERE bukrs = gs_open-bukrs
                          AND belnr = gs_open-belnr
                          AND gjahr = gs_open-gjahr.


  ENDLOOP.

<font color ="#0000FF">*  CLEAR lt_open_s.</font>
<font color ="#0000FF">*  MOVE-CORRESPONDING gt_open TO lt_open_s.</font>


<font color ="#0000FF">*  MODIFY zc102fit0010 FROM TABLE lt_open_s.</font>
  IF sy-subrc = 0.
    COMMIT WORK AND WAIT.
  ELSE.
    MESSAGE i008 DISPLAY LIKE 'E'.
    ROLLBACK WORK.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_blart.

<font color ="#0000FF">*-- Screen 110 Data 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

<font color ="#0000FF">*-- 소스 코드 구현 위한 Function 호출 (Screen 110 Data 추출)</font>
  CALL FUNCTION 'DYNP_VALUES_READ'
    EXPORTING
      dyname     = sy-repid
      dynumb     = sy-dynnr
      request    = 'A'
    TABLES
      dynpfields = dynpfields
    EXCEPTIONS
      OTHERS     = 01.

<font color ="#0000FF">**-- Search Help 데이터 추출</font>
<font color ="#0000FF">**  SELECT blart, ltext FROM zc102fit0005</font>
<font color ="#0000FF">**    WHERE spras = @sy-langu</font>
<font color ="#0000FF">**    INTO TABLE @DATA(lt_blart).</font>

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'BLART'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_BLART-BLART'
      window_title = '전표 유형'
      value_org    = 'S'
    TABLES
      value_tab    = gt_blart
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_partner</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_partner .

<font color ="#0000FF">*-- Screen 110 Data 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'PARTNER'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_PARTNER-PARTNER'
      window_title = 'Business Partner'
      value_org    = 'S'
    TABLES
      value_tab    = gt_partner
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_partner_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_partner_data .

  CLEAR gt_partner.
  SELECT partner name1 bp_role bp_type
    INTO CORRESPONDING FIELDS OF TABLE gt_partner
    FROM zc102bpt0001.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_saknr</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_saknr .

<font color ="#0000FF">*-- Screen 110 Data 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : lv_shkzg TYPE zc102fit0016-shkzg,
         lv_koart TYPE zc102fit0016-koart,
         lv_ktoks TYPE zc102fit0002-ktoks,
         lv_saknr TYPE string.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

<font color ="#0000FF">*-- 계정 마스터 데이터, 조정계정 마스터 데이터 비교해서 차/대변에 맞는 계정 필터</font>
  CLEAR : gs_bschl, gt_saknr_sh.
  READ TABLE gt_bschl INTO gs_bschl WITH KEY gs_clear_item-bschl
                                    BINARY SEARCH.

<font color ="#0000FF">*-- 전표 유형이 DZ(매출)이면 대변에 조정 계정, KZ(매입)이면 차변에 조정 계정 세팅</font>
  CASE gs_clear_header-blart.
    WHEN 'DZ'.
      lv_shkzg = 'S'.
      lv_koart = 'D'.
      lv_ktoks = 'D'.
      lv_saknr = '6%'.
    WHEN 'KZ'.
      lv_shkzg = 'H'.
      lv_koart = 'K'.
      lv_ktoks = 'K'.
      lv_saknr = '7%'.
    WHEN OTHERS.
      CLEAR : lv_shkzg, lv_koart.
  ENDCASE.

<font color ="#0000FF">*-- 전표 유형이 D나 K일 경우</font>
  IF ( lv_ktoks = 'D' ) OR
     ( lv_ktoks = 'K' ).
    IF gs_bschl-shkzg = lv_shkzg.
      SELECT a~saknr, a~txt20
        FROM @gt_saknr AS a
        WHERE a~bpact = ''
        INTO CORRESPONDING FIELDS OF TABLE @gt_saknr_sh.
    ELSE.
      SELECT a~saknr AS saknr, a~txt20
        FROM @gt_saknr AS a LEFT JOIN @gt_bpact AS b
          ON a~saknr = b~saknr
        WHERE b~bpact NE ''
          AND a~saknr LIKE @lv_saknr
        INTO CORRESPONDING FIELDS OF TABLE @gt_saknr_sh.
    ENDIF.
  ELSE.
    SELECT a~saknr, a~txt20
      FROM @gt_saknr AS a
      WHERE ktoks NOT IN ( 'D', 'K' )
      INTO CORRESPONDING FIELDS OF TABLE @gt_saknr_sh.
  ENDIF.



  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'SAKNR'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_SAKNR-SAKNR'
      window_title = '계정과목'
      value_org    = 'S'
    TABLES
      value_tab    = gt_saknr_sh
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_saknr_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_saknr_data .

  CLEAR gt_saknr.
  SELECT a~saknr ktoks txt20 bpact
    INTO CORRESPONDING FIELDS OF TABLE gt_saknr
    FROM zc102fit0002 AS a LEFT JOIN zc102bpt0002 AS b
      ON a~saknr = b~saknr.

  SORT gt_saknr ASCENDING BY saknr.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_screen_0120</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_screen_0120 .

  IF go_pop_acc_cont IS NOT BOUND.

    CLEAR : gt_fcat_account, gs_fcat_account.
    PERFORM set_fcat_account USING :
                              'X' 'SERNO'   'ZC102FIT0014' 'C' ' ',
<font color ="#0000FF">*                              'X' 'ACCNO'   'ZC102FIT0014' 'C' ' ',</font>
<font color ="#0000FF">*                              'X' 'PARTNER' 'ZC102FIT0014' 'C' ' ',</font>
                              'X' 'NAME1'   'ZC102BPT0001' ' ' 'X',
                              'X' 'DWDATE'  'ZC102FIT0014' 'C' ' ',
                              ' ' 'WRBTR'   'ZC102FIT0014' ' ' 'X',
                              ' ' 'WAERS'   'ZC102FIT0014' 'C' ' ',
                              ' ' 'HISTORY' 'ZC102FIT0014' ' ' 'X',
<font color ="#0000FF">*                              ' ' 'TTYPE'   'ZC102FIT0014' 'C' ' ',</font>
                              ' ' 'TTEXT'   ' '            'C' 'X'.


    PERFORM set_layout_account.
    PERFORM create_object_account.

    SET HANDLER lcl_event_handler_acc=&gt;double_click
                FOR go_pop_acc_grid.
    CALL METHOD go_pop_acc_grid-&gt;set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout_account
      CHANGING
        it_outtab       = gt_history
        it_fieldcatalog = gt_fcat_account.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_fcat_account</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_fcat_account USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat_account-key       = pv_key.
  gs_fcat_account-fieldname = pv_field.
  gs_fcat_account-ref_table = pv_table.
  gs_fcat_account-just      = pv_just.
  gs_fcat_account-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'WRBTR'.
      gs_fcat_account-cfieldname = 'WAERS'.
    WHEN 'TTEXT'.
      gs_fcat_account-coltext = '입/출금'.
  ENDCASE.

  APPEND gs_fcat_account TO gt_fcat_account.
  CLEAR gs_fcat_account.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_layout_account</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_layout_account .

  gs_layout_account-zebra      = abap_true.
  gs_layout_account-cwidth_opt = 'A'.
  gs_layout_account-sel_mode   = ' '.
  gs_layout_account-grid_title = '계좌 내역'.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_object_account</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_object_account .

  CREATE OBJECT go_pop_acc_cont
    EXPORTING
      container_name = 'ACC_CONT'.

  CREATE OBJECT go_pop_acc_grid
    EXPORTING
      i_parent = go_pop_acc_cont.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_account_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_history_data .

  DATA : lv_tabix TYPE sy-tabix.

  PERFORM set_search_condition. " 검색 조건 생성

  CLEAR gt_history.
  SELECT serno a~accno dwdate wrbtr a~waers history ttype a~partner
    INTO CORRESPONDING FIELDS OF TABLE gt_history
    FROM zc102fit0014 AS a INNER JOIN zc102fit0013 AS b
      ON a~accno = b~accno
    WHERE bank IN gr_bank
      AND a~accno IN gr_accno
      AND a~partner = gs_account-partner
      AND dwdate IN gr_dwdate.

<font color ="#0000FF">*-- Partner 이름 세팅, 거래 타입 세팅</font>
  LOOP AT gt_history INTO gs_history.

    lv_tabix = sy-tabix.

<font color ="#0000FF">*-- 거래 타입</font>
    CASE gs_history-ttype.
      WHEN 'D'.
        gs_history-ttext = '입금'.
      WHEN 'W'.
        gs_history-ttext = '출금'.
    ENDCASE.

<font color ="#0000FF">*-- Partner 이름 세팅</font>
    CLEAR gs_partner.
    gs_history-name1 = gt_partner[ partner = gs_history-partner ]-name1.

    MODIFY gt_history FROM gs_history INDEX lv_tabix
                                      TRANSPORTING ttext name1.

  ENDLOOP.

  MESSAGE s010 WITH sy-dbcnt.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_double_click</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_COLUMN</font>
<font color ="#0000FF">*&      --&gt; E_ROW</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_double_click USING pv_column pv_row.

  READ TABLE gt_history INTO gs_history INDEX pv_row.
  IF sy-subrc = 0.

    gs_clear_item-partner = gs_history-partner.
    gs_clear_item-wrbtr = gs_history-wrbtr.
    gs_clear_item-sgtxt = gs_history-history.
    PERFORM exit_screen_0120.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form exit_screen_0120</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM exit_screen_0120 .

  CLEAR : gs_account.

  CALL METHOD : go_pop_acc_grid-&gt;free, go_pop_acc_cont-&gt;free.

  FREE : go_pop_acc_grid, go_pop_acc_cont.

  LEAVE TO SCREEN 0.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_condition</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_condition .

  _init gr_accno.
  _init gr_partner.
  _init gr_dwdate.

<font color ="#0000FF">*-- 은행 세팅</font>
  PERFORM set_bank_condition.

<font color ="#0000FF">*-- 계좌번호 세팅</font>
  IF gs_account-accno IS NOT INITIAL.
    gr_accno-sign   = 'I'.
    gr_accno-option = 'EQ'.
    gr_accno-low    = gs_account-accno.
    APPEND gr_accno.
  ENDIF.

<font color ="#0000FF">*-- BP 세팅</font>
  IF gs_clear_item-partner IS NOT INITIAL.
    gr_partner-sign   = 'I'.
    gr_partner-option = 'EQ'.
    gr_partner-low    = gs_clear_item-partner.
    APPEND gr_partner.
  ENDIF.

<font color ="#0000FF">*-- 기간 조건 세팅</font>
  IF ( gs_account-dwdate_fr IS NOT INITIAL ) AND
     ( gs_account-dwdate_to IS NOT INITIAL ).
    PERFORM set_date_value
      USING 'I' 'BT' gs_account-dwdate_fr gs_account-dwdate_to.
  ELSEIF ( gs_account-dwdate_fr IS NOT INITIAL ).
    PERFORM set_date_value
      USING 'I' 'EQ' gs_account-dwdate_fr gs_account-dwdate_to.
  ELSEIF ( gs_account-dwdate_to IS NOT INITIAL ).
    PERFORM set_date_value
      USING 'I' 'BT' gs_account-dwdate_fr gs_account-dwdate_to.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_date_value</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; GV_BUDAT_FR</font>
<font color ="#0000FF">*&      --&gt; GV_BUDAT_TO</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_date_value USING pv_sign pv_option pv_from pv_to.

  gr_dwdate-sign   = pv_sign.
  gr_dwdate-option = pv_option.
  gr_dwdate-low    = pv_from.
  gr_dwdate-high   = pv_to.
  APPEND gr_dwdate.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_account_grid</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM refresh_account_grid .

  go_pop_acc_grid-&gt;refresh_table_display( ).

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_bank</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_bank .

<font color ="#0000FF">*-- Screen 120 Data 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

<font color ="#0000FF">*-- 입력한 BP에 맞게 데이터 추출</font>

<font color ="#0000FF">*-- 소스 코드 구현 위한 Function 호출 (Screen 110 Data 추출)</font>
  CALL FUNCTION 'DYNP_VALUES_READ'
    EXPORTING
      dyname     = sy-repid
      dynumb     = sy-dynnr
      request    = 'A'
    TABLES
      dynpfields = dynpfields
    EXCEPTIONS
      OTHERS     = 01.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'bank'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GV_BANK'
      window_title = '은행'
      value_org    = 'S'
    TABLES
      value_tab    = gt_account
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_accno</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_accno .

<font color ="#0000FF">*-- Screen 120 Data 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

<font color ="#0000FF">*-- 소스 코드 구현 위한 Function 호출 (Screen 110 Data 추출)</font>
  CALL FUNCTION 'DYNP_VALUES_READ'
    EXPORTING
      dyname     = sy-repid
      dynumb     = sy-dynnr
      request    = 'A'
    TABLES
      dynpfields = dynpfields
    EXCEPTIONS
      OTHERS     = 01.

<font color ="#0000FF">*-- Search Help 데이터 추출</font>
  PERFORM set_bank_condition.
  PERFORM set_partner_condition.
  SELECT accno, accnum, bank FROM zc102fit0013
    WHERE bank IN @gr_bank
      AND partner IN @gr_partner
    INTO TABLE @DATA(lt_account).

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'accno'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GV_ACCNO'
      window_title = '계좌'
      value_org    = 'S'
    TABLES
      value_tab    = lt_account
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
    " 🔥 여기서 강제로 OK_CODE 설정
    CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
      EXPORTING
        new_code = 'ENTER'.  " 또는 네가 정의한 OK_CODE (예: 'EXEC')
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_screen_data_0120</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_screen_data_0120 .

  CLEAR gv_flag.
<font color ="#0000FF">*-- Bank 입력 값이 유효한지 체크</font>
<font color ="#0000FF">*  IF gs_account-bank IS NOT INITIAL.</font>
<font color ="#0000FF">*    CLEAR gs_account_read.</font>
<font color ="#0000FF">*    READ TABLE gt_account INTO gs_account_read</font>
<font color ="#0000FF">*                          WITH KEY bank = gs_account-bank.</font>
<font color ="#0000FF">*    IF gs_account_read IS INITIAL.</font>
<font color ="#0000FF">*      gv_flag = abap_true.</font>
<font color ="#0000FF">*      EXIT.</font>
<font color ="#0000FF">*    ENDIF.</font>
<font color ="#0000FF">*  ENDIF.</font>

<font color ="#0000FF">*-- 계좌코드 값이 유효한지 체크</font>
  IF gs_account-accno IS NOT INITIAL.
    CLEAR gs_account_read.
    READ TABLE gt_account INTO gs_account_read
                          WITH KEY accno = gs_account-accno.
    IF gs_account_read IS INITIAL.
      gv_flag = abap_true.
      EXIT.
    ELSE.
<font color ="#0000FF">*-- 계좌 코드에 따른 계좌번호 조회 후 출력</font>
      gs_account-accnum = gs_account_read-accnum.
      gs_account-bank = gs_account_read-bank.
      gs_account-bank_name = gs_account_read-bank_name.
    ENDIF.
  ELSE.
    CLEAR : gs_account-accnum, gs_account-bank, gs_account-bank_name.
  ENDIF.

<font color ="#0000FF">*-- BP 값이 유효한지 체크</font>
  IF gs_account-partner IS NOT INITIAL.
    CLEAR gs_partner.
    READ TABLE gt_partner INTO gs_partner
                          WITH KEY partner = gs_account-partner.
    IF gs_partner IS INITIAL.
      gv_flag = abap_true.
      EXIT.
    ELSE.
      gs_account-name1 = gs_partner-name1.
    ENDIF.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_account_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_account_data .

  DATA : lv_tabix TYPE sy-tabix.

  CLEAR gt_account.
  SELECT accno accnum bank ddtext AS bank_name partner
    INTO CORRESPONDING FIELDS OF TABLE gt_account
    FROM zc102fit0013 AS a INNER JOIN dd07t AS b
      ON a~bank = b~domvalue_l
    WHERE b~domname = 'ZC102D_FI_BANK'.

<font color ="#0000FF">*-- Partner 이름 세팅</font>
  LOOP AT gt_account INTO gs_account_read.

    lv_tabix = sy-tabix.

    CLEAR gs_partner.
    READ TABLE gt_partner INTO gs_partner
                          WITH KEY partner = gs_account_read-partner
                          BINARY SEARCH.
    IF sy-subrc = 0.
      gs_account_read-name1 = gs_partner-name1.
      MODIFY gt_account FROM gs_account_read INDEX lv_tabix
                                             TRANSPORTING name1.
    ENDIF.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_bank_condition</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_bank_condition .

  _init gr_bank.
  IF gs_account-bank IS NOT INITIAL.
    gr_bank-sign   = 'I'.
    gr_bank-option = 'EQ'.
    gr_bank-low    = gs_account-bank.
    APPEND gr_bank.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_empty</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_empty .

  IF gs_header IS INITIAL.

    gv_pop_flag = abap_true.
    CALL SCREEN 130 STARTING AT 05 05.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_item_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_item_data .

  CLEAR gs_header_sh.
  SELECT SINGLE bukrs belnr gjahr blart bldat budat bktxt
         stblg stodt stgrd waers
    INTO CORRESPONDING FIELDS OF gs_header_sh
    FROM zc102fit0009
    WHERE bukrs = zc102fit0009-bukrs
      AND belnr = zc102fit0009-belnr
      AND gjahr = zc102fit0009-gjahr.

  IF gs_header_sh IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  MOVE-CORRESPONDING gs_header_sh TO gs_header.
  CLEAR : zc102fit0009-bukrs, zc102fit0009-belnr, zc102fit0009-gjahr.
<font color ="#0000FF">*-- 조회했으면 gv_flag true로 리프레시 설정</font>
  gv_flag = abap_true.
  MESSAGE s005.
  LEAVE TO SCREEN 0.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM refresh_screen .

  " 미결 가져오기
  PERFORM get_open_data.
  " 반제 가져오기
  PERFORM get_clear_data.
<font color ="#0000FF">*-- 계정 과목 텍스트 세팅</font>
  PERFORM set_screen_item.
  " 미결금액 계산
  PERFORM set_open_credit.
  " 반제금액 계산
  PERFORM set_clear_credit.
  " 잔액 계산
  PERFORM set_remain_credit.
  " 기본 틀 세팅
  PERFORM set_basic_color_data.
  " ALV 갱신
  PERFORM refresh_alv_grid.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_bpact</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_bpact .

<font color ="#0000FF">*-- Screen 110 DATA 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

<font color ="#0000FF">*-- 소스 코드 구현 위한 Function 호출 (Screen 110 Data 추출)</font>
  CALL FUNCTION 'DYNP_VALUES_READ'
    EXPORTING
      dyname     = sy-repid
      dynumb     = sy-dynnr
      request    = 'A'
    TABLES
      dynpfields = dynpfields
    EXCEPTIONS
      OTHERS     = 01.

<font color ="#0000FF">**-- Search Help 데이터 추출</font>
<font color ="#0000FF">**  SELECT blart, ltext FROM zc102fit0005</font>
<font color ="#0000FF">**    WHERE spras = @sy-langu</font>
<font color ="#0000FF">**    INTO TABLE @DATA(lt_blart).</font>

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'BLART'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_BLART-BLART'
      window_title = '전표 유형'
      value_org    = 'S'
    TABLES
      value_tab    = gt_blart
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_bschl</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_bschl .

<font color ="#0000FF">*-- Screen 110 DATA 추출</font>
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  DATA : lt_search LIKE gt_bschl,
         lv_koart  TYPE zc102fit0016-koart.

<font color ="#0000FF">*-- 소스 코드 구현 위한 Function 호출 (Screen 110 Data 추출)</font>
  CALL FUNCTION 'DYNP_VALUES_READ'
    EXPORTING
      dyname     = sy-repid
      dynumb     = sy-dynnr
      request    = 'A'
    TABLES
      dynpfields = dynpfields
    EXCEPTIONS
      OTHERS     = 01.

<font color ="#0000FF">*-- Search Help 데이터 추출</font>
  IF gs_clear_header-blart = 'DZ'.
    lv_koart = 'K'.
  ELSEIF gs_clear_header-blart = 'KZ'.
    lv_koart = 'D'.
  ELSE.
<font color ="#0000FF">*    lv_koart = 'S'.</font>
  ENDIF.

  SELECT *
    FROM @gt_bschl AS a
    WHERE a~koart NE @lv_koart
    INTO CORRESPONDING FIELDS OF TABLE @lt_search.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'BSCHL'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_BLART-BSCHL'
      window_title = '전기키'
      value_org    = 'S'
    TABLES
      value_tab    = lt_search
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_bpact_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_bpact_data .

  CLEAR : gt_bpact.
  SELECT bpact saknr partner
    INTO CORRESPONDING FIELDS OF TABLE gt_bpact
    FROM zc102bpt0002
    WHERE partner = gv_partner
    ORDER BY saknr ASCENDING.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_saknr_text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_screen_item .

  DATA : lv_tabix TYPE sy-tabix.

<font color ="#0000FF">*-- 미결 아이템 텍스트 세팅</font>
  LOOP AT gt_open INTO gs_open.

    lv_tabix = sy-tabix.

<font color ="#0000FF">*-- 대변금액 음수로 세팅</font>
    IF gs_open-shkzg = 'H'.
      gs_open-wrbtr *= -1.
    ENDIF.

<font color ="#0000FF">*-- BSCHL 데이터 세팅</font>
    CLEAR gs_bschl.
    READ TABLE gt_bschl INTO gs_bschl WITH KEY gs_open-bschl
                                      BINARY SEARCH.
    IF sy-subrc = 0.
      gs_open-ltext = gs_bschl-ltext.
    ENDIF.

<font color ="#0000FF">*-- SAKNR_TEXT 세팅</font>
    CLEAR gs_saknr.
    READ TABLE gt_saknr INTO gs_saknr WITH KEY saknr = gs_open-saknr
                                      BINARY SEARCH.

    IF sy-subrc = 0.
      gs_open-txt20 = gs_saknr-txt20.
    ENDIF.

    MODIFY gt_open FROM gs_open INDEX lv_tabix
                                TRANSPORTING txt20 wrbtr ltext.

  ENDLOOP.

<font color ="#0000FF">*-- 반제 아이템 텍스트 세팅</font>
  LOOP AT gt_clear INTO gs_clear.

    lv_tabix = sy-tabix.

<font color ="#0000FF">*-- 대변금액 음수로 세팅</font>
    IF gs_clear-shkzg = 'H'.
      gs_clear-wrbtr *= -1.
    ENDIF.

<font color ="#0000FF">*-- BSCHL 데이터 세팅</font>
    CLEAR gs_bschl.
    READ TABLE gt_bschl INTO gs_bschl WITH KEY gs_clear-bschl
                                      BINARY SEARCH.
    IF sy-subrc = 0.
      gs_clear-ltext = gs_bschl-ltext.
    ENDIF.

<font color ="#0000FF">*-- 계정과목 텍스트 세팅</font>
    CLEAR gs_saknr.
    READ TABLE gt_saknr INTO gs_saknr WITH KEY saknr = gs_clear-saknr
                                      BINARY SEARCH.

    IF sy-subrc = 0.
      gs_clear-txt20 = gs_saknr-txt20.
    ENDIF.

    MODIFY gt_clear FROM gs_clear INDEX lv_tabix
                              TRANSPORTING txt20 wrbtr ltext.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_bpact_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_bpact_data .

<font color ="#0000FF">*-- 계정과목에 따라 bpact 값 입력</font>
<font color ="#0000FF">*-- 계정과목에 해당하는 조정계정이 없으면 EXIT</font>
  CLEAR gs_bpact.
  READ TABLE gt_bpact INTO gs_bpact WITH KEY saknr = gs_clear_item-saknr
                                    BINARY SEARCH.
  IF gs_bpact IS INITIAL.
    CLEAR gs_clear_item-bpact.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- 조정계정 세팅</font>
  gs_clear_item-bpact   = gs_bpact-bpact.
  gs_clear_item-partner = gs_bpact-partner.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_screen .

  zc102fit0009-bukrs = '1000'.
  zc102fit0009-gjahr = sy-datum(4).

  gv_okcode = 'CHCK'.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_base_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_base_data .

<font color ="#0000FF">*-- Partner 세팅</font>
  CLEAR gs_open.
  LOOP AT gt_open INTO gs_open WHERE partner IS NOT INITIAL.
    gs_account-partner = gs_open-partner.
  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_partner_condition</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_partner_condition .

  _init gr_partner.
  IF gs_account-partner IS NOT INITIAL.
    gr_partner-sign   = 'I'.
    gr_partner-option = 'EQ'.
    gr_partner-low    = gs_account-partner.
    APPEND gr_partner.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_accno_validation</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_accno_validation .

<font color ="#0000FF">*-- 계좌코드 값이 유효한지 체크</font>
  IF gs_account-accno IS NOT INITIAL.
    CLEAR gs_account_read.
    READ TABLE gt_account INTO gs_account_read
                          WITH KEY accno = gs_account-accno.
    IF gs_account_read IS INITIAL.
      gv_flag = abap_true.
      EXIT.
    ELSE.
<font color ="#0000FF">*-- 계좌 코드에 따른 계좌번호 조회 후 출력</font>
      gs_account-accnum = gs_account_read-accnum.
      gs_account-bank = gs_account_read-bank.
      gs_account-bank_name = gs_account_read-bank_name.
    ENDIF.
  ELSE.
    CLEAR : gs_account-accnum, gs_account-bank, gs_account-bank_name.
  ENDIF.

ENDFORM.
</pre>
<hr>
<font size="2" face = "Sans Serif">Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 758
</font>
</body>
</html>
