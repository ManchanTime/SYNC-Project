<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>ZC102MMR0004F01</title>
</head>
<body bgcolor="#FFFFE0">
<font size="3" face = "Arial" color="#000000"><b>Code listing for: ZC102MMR0004F01</b></font>
<br>
<font size="3" face = "Arial" color="#000000"><b>Description:  Include ZC102MMR0004F01</b></font>
<hr>
<pre width="100">
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Include          ZC102MMR0004F01</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_screen .

  IF ( go_left_cont IS NOT BOUND ) AND
     ( go_right_cont IS NOT BOUND ) AND
     ( go_bottom_cont IS NOT BOUND ).


    CLEAR : gt_left_fcat, gs_left_fcat,
            gt_right_fcat, gs_right_fcat,
            gs_bottom_fcat, gt_bottom_fcat.

    PERFORM set_left_fcat USING :
                                  'X' 'STATUS'          '            ' ' ' ' ',
                                  'X' 'VBELN_BIL'       'ZC102MMT0015' 'C' ' ',
                                  'X' 'EBELN'           'ZC102MMT0015' 'C' ' ',
                                  ' ' 'MATNR'           'ZC102MMT0015' 'C' ' ',
                                  ' ' 'ODRQU'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'GRQTY'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'MEINS'           'ZC102MMT0015' 'C' 'X',
<font color ="#0000FF">*                                  ' ' 'QCHECK'          'ZC102MMT0015' ' ' ' ',</font>
                                  ' ' 'WRBTR'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'WAERS'           'ZC102MMT0015' 'C' 'X',
                                  ' ' 'GREDAT'           'ZC102MMT0015' 'C' ' ',
                                  ' ' 'NAME1'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'SORT_KEY'         ' '            ' ' ' '.



    PERFORM set_right_fcat USING :'X' 'VBELN_BIL'       'ZC102MMT0015' 'C' ' ',
                                  'X' 'PARTNER'         'ZC102MMT0015' 'C' ' ',
                                  ' ' 'MATNR'           'ZC102MMT0015' 'C' ' ',
                                  ' ' 'ODRQU'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'GRQTY'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'MEINS'           'ZC102MMT0015' 'C' 'X',
                                  ' ' 'WRBTR'           'ZC102MMT0015' ' ' ' ',
                                  ' ' 'WAERS'           'ZC102MMT0015' 'C' 'X',
                                  ' ' 'CKDAT'           'ZC102MMT0015' 'C' ' ',
                                  ' ' 'PERCENT'         'ZC102MMT0015' ' ' 'X',
<font color ="#0000FF">*                                  ' ' 'REORDER'         'ZC102MMT0015' ' ' 'X',</font>
                                  ' ' 'REORDER_ICON'    '            ' 'C' ' '.


    PERFORM set_bottom_fcat USING :  'X' 'STATUS'          '            ' ' ' ' ',
                                    'X' 'VBELN_BIL'       'ZC102MMT0015' 'C' ' ',
                                    'X' 'EBELN'           'ZC102MMT0015' 'C' ' ',
                                    ' ' 'MATNR'           'ZC102MMT0015' 'C' ' ',
                                    ' ' 'ODRQU'           'ZC102MMT0015' ' ' ' ',
                                    ' ' 'GRQTY'           'ZC102MMT0015' ' ' ' ',
                                    ' ' 'MEINS'           'ZC102MMT0015' 'C' 'X',
                                    ' ' 'WRBTR'           'ZC102MMT0015' ' ' ' ',
                                    ' ' 'WAERS'           'ZC102MMT0015' 'C' 'X',
                                    ' ' 'CKDAT'           'ZC102MMT0015' 'C' ' ',
<font color ="#0000FF">*                                    ' ' 'ERNAM'           'ZC102MMT0015' 'C' ' ',</font>
                                    ' ' 'NAME1'           'ZC102MMT0015' ' ' ' '.
    PERFORM set_layout.
<font color ="#0000FF">*    PERFORM set_sort.</font>
    PERFORM create_object.
    SET HANDLER :
                  lcl_event_handler=&gt;edit_toolbar FOR go_left_grid,
                  lcl_event_handler=&gt;user_command FOR go_left_grid,
                  lcl_event_handler=&gt;user_command FOR go_right_grid,
                  lcl_event_handler=&gt;edit_toolbar2 FOR go_right_grid,
                  lcl_event_handler=&gt;user_command FOR go_bottom_grid.


<font color ="#0000FF">*--새로 생긴 아이템 줄에 색 주기</font>
<font color ="#0000FF">*    PERFORM set_new_line_color.</font>
    PERFORM display_left_screen.
    PERFORM display_right_screen.
    PERFORM display_bottom_screen.
    PERFORM refresh_table.
  ENDIF.





ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_layout</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_layout.

<font color ="#0000FF">*-- Set Left layout</font>
  gs_left_layout-zebra       = abap_true.
  gs_left_layout-cwidth_opt  = 'A'.
  gs_left_layout-sel_mode    = 'D'.
  gs_left_layout-ctab_fname = 'COLOR'.         "컬러속성 주기
  gs_left_layout-grid_title = '송장 미처리 목록'.

  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV1'.

<font color ="#0000FF">*-- 새로 생긴 아이템 맨 위로</font>
  CLEAR : gt_sort_clear, gs_sort_clear.
  gs_sort_clear-spos = 1.
  gs_sort_clear-fieldname = 'SORT_KEY'.
  gs_sort_clear-up = abap_false.
  APPEND gs_sort_clear TO gt_sort_clear.

<font color ="#0000FF">*</font>
<font color ="#0000FF">**--새로 생긴 아이템 줄에 색 주기</font>
<font color ="#0000FF">*  PERFORM set_new_line_color.</font>


<font color ="#0000FF">*-- Set Right layout</font>
  gs_right_layout-zebra       = abap_true.
  gs_right_layout-cwidth_opt  = 'A'.
  gs_right_layout-sel_mode    = 'D'.
  gs_right_layout-grid_title = '확정 보류 목록'.
  gs_right_layout-ctab_fname = 'COLOR'.


  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV2'.



<font color ="#0000FF">*-- Set Bottom layout</font>
  gs_bottom_layout-zebra       = abap_true.
  gs_bottom_layout-cwidth_opt  = 'A'.
  gs_bottom_layout-sel_mode    = 'D'.
  gs_bottom_layout-grid_title = '송장 검수완료 목록'.

  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV3'.



ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_object</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_object .

<font color ="#0000FF">*-- Main Container</font>
  CREATE OBJECT go_container
    EXPORTING
      container_name = 'MAIN_CONT'.

<font color ="#0000FF">*-- Split screen</font>
  CREATE OBJECT go_split_cont
    EXPORTING
      parent  = go_container
      rows    = 2
      columns = 1.           " ★ 열 2개로 분리 =&gt; 옆으로 나눔



  " left
  CALL METHOD go_split_cont-&gt;get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_top_cont.


<font color ="#0000FF">*-- Split screen2</font>
  CREATE OBJECT go_split_cont2
    EXPORTING
      parent  = go_top_cont
      rows    = 1
      columns = 2.


  CALL METHOD go_split_cont2-&gt;get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_left_cont.

  CALL METHOD go_split_cont2-&gt;get_container
    EXPORTING
      row       = 1
      column    = 2
    RECEIVING
      container = go_right_cont.

  CALL METHOD go_split_cont-&gt;get_container
    EXPORTING
      row       = 2
      column    = 1
    RECEIVING
      container = go_bottom_cont.

  CREATE OBJECT go_left_grid
    EXPORTING
      i_parent = go_left_cont.


  CREATE OBJECT go_right_grid
    EXPORTING
      i_parent = go_right_cont.

  CREATE OBJECT go_bottom_grid
    EXPORTING
      i_parent = go_bottom_cont.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_screen .
  READ TABLE gt_empno INTO gs_empno WITH KEY empno = zc102hrt0002-empno.
  zc102hrt0002-empnam = gs_empno-empnam.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_variant</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_variant  USING pv_handle.
  gs_variant-report = sy-repid.
  gs_variant-handle = pv_handle.

ENDFORM.

<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_table</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM refresh_table .
  CALL METHOD go_left_grid-&gt;refresh_table_display.
  CALL METHOD go_right_grid-&gt;refresh_table_display.
  CALL METHOD go_bottom_grid-&gt;refresh_table_display.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_top_field_catalog</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_left_fcat  USING pv_key pv_field pv_table pv_just pv_emph.

  gs_left_fcat-key        = pv_key.
  gs_left_fcat-fieldname  = pv_field.
  gs_left_fcat-ref_table  = pv_table.
  gs_left_fcat-just       = pv_just.
  gs_left_fcat-emphasize  = pv_emph.

  CASE pv_field.
    WHEN 'ODRQU'.
      gs_left_fcat-qfieldname = 'MEINS'.
    WHEN 'GRQTY'.
      gs_left_fcat-qfieldname = 'MEINS'.
    WHEN 'MEINS'.
      gs_left_fcat-coltext      = '단위'.
    WHEN 'WRBTR'.
      gs_left_fcat-cfieldname = 'WAERS'.      " 금액단위
      gs_left_fcat-coltext    = '금액'.
    WHEN 'WAERS'.
      gs_left_fcat-fieldname    = 'WAERS'.
      gs_left_fcat-coltext      = '통화키'.
      gs_left_fcat-outputlen    = 5.          " 출력 길이 설정 필수
      gs_left_fcat-no_out       = abap_false. " 숨김 방지
    WHEN 'STATUS'.
      gs_left_fcat-coltext = '송장검증상태'.
      gs_left_fcat-icon = 'X'.
    WHEN 'SORT_KEY'.
      gs_left_fcat-no_out = abap_true.
  ENDCASE.

  APPEND gs_left_fcat TO gt_left_fcat.
  CLEAR gs_left_fcat.

ENDFORM.

<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_data .
  CLEAR : gt_iv, gt_iv2, gt_check, gt_po.

  SELECT vbeln_bil ebeln matnr qcheck waers partner state               "왼쪽 상단 alv
         odrqu grqty meins wrbtr ckdat name1 gredat
         erdat ernam erzet belnr
    INTO CORRESPONDING FIELDS OF TABLE gt_iv
    FROM zc102mmt0015
        WHERE state = ' '
    ORDER BY vbeln_bil.

  SELECT vbeln_bil ebeln matnr qcheck waers partner state               "맨아래 alv
         odrqu grqty meins wrbtr ckdat name1 gredat
         erdat ernam erzet belnr
    INTO CORRESPONDING FIELDS OF TABLE gt_iv2
    FROM zc102mmt0015
        WHERE state = 'O'
    ORDER BY vbeln_bil.


  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE gt_check
    FROM zc102mmt0015
    WHERE state = 'X'
    ORDER BY vbeln_bil.

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE gt_po
    FROM zc102mmt0011.

  PERFORM set_icon_new_reorder.

  IF sy-dbcnt IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
  ELSE.
<font color ="#0000FF">*    MESSAGE s010 WITH sy-dbcnt.</font>
    DATA(lv_total_count) = lines( gt_iv ) + lines( gt_iv2 ) + lines( gt_check ).
    MESSAGE s010 WITH lv_total_count.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_tab1_fcat</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_right_fcat  USING   pv_key pv_field pv_table pv_just pv_emph.

  gs_right_fcat-key        = pv_key.
  gs_right_fcat-fieldname  = pv_field.
  gs_right_fcat-ref_table  = pv_table.
  gs_right_fcat-just       = pv_just.
  gs_right_fcat-emphasize  = pv_emph.

  CASE pv_field.
    WHEN 'ODRQU'.
      gs_right_fcat-qfieldname = 'MEINS'.
    WHEN 'GRQTY'.
      gs_right_fcat-qfieldname = 'MEINS'.
    WHEN 'MEINS'.
      gs_right_fcat-coltext      = '단위'.
    WHEN 'WRBTR'.
      gs_right_fcat-cfieldname = 'WAERS'.
      gs_right_fcat-coltext    = '금액'.
    WHEN 'STATUS'.
      gs_right_fcat-coltext = '송장검증상태'.
      gs_right_fcat-icon = 'X'.
    WHEN 'GRQTY'.
      gs_right_fcat-edit      = 'X'.          " 실입고 수량 편집할 수 있게 열어주기
    WHEN 'WAERS'.
      gs_right_fcat-fieldname    = 'WAERS'.
      gs_right_fcat-coltext      = '통화키'.
      gs_right_fcat-outputlen    = 5.      " 출력 길이 설정 필수
      gs_right_fcat-no_out       = abap_false. " 숨김 방지
    WHEN 'PERCENT'.
      gs_right_fcat-coltext = '일치율(%)'.
      gs_right_fcat-outputlen = 8.           " 화면 출력 길이
      gs_right_fcat-just = 'R'.              " 우측 정렬
      gs_right_fcat-decimals_o = 1.        " 소수 첫째 자리까지 표시
      gs_right_fcat-tooltip   = '일치율 = (실입고 수량 ÷ 주문 수량) × 100'.
    WHEN 'REORDER_ICON'.
      gs_right_fcat-coltext = '구매오더여부'.
      gs_right_fcat-icon = 'X'.
  ENDCASE.

  APPEND gs_right_fcat TO gt_right_fcat.
  CLEAR gs_right_fcat.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_top_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_left_screen .

  PERFORM set_variant USING 'ALV1'.
  CALL METHOD go_left_grid-&gt;set_table_for_first_display
    EXPORTING
      is_variant      = gs_variant
      i_save          = 'A'
      i_default       = 'X'
      is_layout       = gs_left_layout
    CHANGING
      it_outtab       = gt_iv
      it_fieldcatalog = gt_left_fcat
      it_sort         = gt_sort_clear.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_tab1_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_right_screen .

  PERFORM set_variant USING 'ALV2'.
  CALL METHOD go_right_grid-&gt;set_table_for_first_display
    EXPORTING
      is_variant      = gs_variant
      i_save          = 'A'
      i_default       = 'X'
      is_layout       = gs_right_layout
    CHANGING
      it_outtab       = gt_check
      it_fieldcatalog = gt_right_fcat.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form button_control</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM button_control .

<font color ="#0000FF">*</font>
<font color ="#0000FF">*  CASE sscrfields-ucomm.</font>
<font color ="#0000FF">*    WHEN 'FC01'.</font>
<font color ="#0000FF">*      PERFORM form_download.</font>
<font color ="#0000FF">*  ENDCASE.</font>


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form form_download</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM form_download .
<font color ="#0000FF">**********************************************************************</font>
<font color ="#0000FF">* Create excel upload application form</font>
<font color ="#0000FF">**********************************************************************</font>
  DATA : lv_filename LIKE rlgrap-filename,
         lv_msg(100).

<font color ="#0000FF">*-- Call windows browser</font>
  CLEAR w_pfolder.
  PERFORM get_browser_info.

  IF w_pfolder IS INITIAL.
    EXIT.
  ENDIF.

  CLEAR lv_filename.
  CONCATENATE w_pfolder '\' 'Data_Upload' '.XLS' INTO lv_filename.

  PERFORM download_template USING lv_filename.
ENDFORM.

<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_status</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_status .
  LOOP AT gt_iv INTO gs_iv.

    IF gs_iv-grqty IS INITIAL.
      " 미처리 로직
      gs_iv-status = icon_red_light.
    ELSE.
      " 처리완료 로직
      gs_iv-icon_status = icon_green_light.
    ENDIF.

    MODIFY gt_iv FROM gs_iv.

  ENDLOOP.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form excel_upload</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM excel_upload .


  TYPES: truxs_t_text_data(4096)   TYPE c OCCURS 0.

  DATA: lt_raw_data  TYPE truxs_t_text_data,
        lt_excel     LIKE TABLE OF alsmex_tabline WITH HEADER LINE,
        lv_index     LIKE sy-tabix,
        lv_waers     TYPE bkpf-waers,
        lv_dmbtr(20).

  FIELD-SYMBOLS:  &lt;field&gt;.

  IF p_path IS INITIAL.
    MESSAGE s001 WITH 'Upload 할 파일을 선택하세요' DISPLAY LIKE 'E'.
    STOP.
  ENDIF.

  CLEAR : gt_excel, gs_excel, lv_index.

  CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE'
    EXPORTING
      filename                = p_path   "엑셀 파일 경로
      i_begin_col             = 1
      i_begin_row             = 3
      i_end_col               = 100
      i_end_row               = 50000
    TABLES
      intern                  = lt_excel  "엑셀로 부터 값을 받아올 테이블
    EXCEPTIONS
      inconsistent_parameters = 1
      upload_ole              = 2
      OTHERS                  = 3.

  IF sy-subrc = 1.
    MESSAGE s001(k5) WITH TEXT-e01.
    STOP.
  ELSEIF sy-subrc &lt;&gt; 0.
    MESSAGE s001(k5) WITH TEXT-e02.
    STOP.
  ENDIF.

  CHECK NOT ( lt_excel[] IS INITIAL ).

  SORT lt_excel BY row col.   "1열1행 순 부터 정렬

  LOOP AT lt_excel.   "엑셀 데이터는 1열로 저장됨

    " 첫 번째 줄(ROW = 1)은 스킵
    IF lt_excel-row = 1 OR lt_excel-row = 2.
      CONTINUE.
    ENDIF.

    lv_index = lt_excel-col.   "COL순으로 인덱스 지정
    ASSIGN COMPONENT lv_index OF STRUCTURE gs_excel TO &lt;field&gt;. "COL순으로 필드 심볼에 컴럼들을 넣어줌
    &lt;field&gt; = lt_excel-value.
    "&lt;FS&gt; 에 GS_EXCEL-XXX 형태로 값이 담김 값이 GS_EXCEL에 저장이 되는 거임
    AT END OF row.    "인터널테이블에서 명시한 필드의 변경된 값이 끝나는 행
      "ROW가 바뀌기 직전에 실행되는 로직
      IF gs_excel IS NOT INITIAL.    " 최소한 하나의 필드에 값이 있어야 append
        APPEND gs_excel TO gt_excel. "GT_EXCEL이랑 GS_EXCEL이 엑셀로 값을 받아서
        "내가 테이블에 저장할 테이블
      ENDIF.
      CLEAR gs_excel.
    ENDAT.

  ENDLOOP.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form excel_job</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM excel_job .

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form button_ctrl</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM button_ctrl .

  CASE sscrfields-ucomm.
    WHEN 'FC01'.
      PERFORM form_download.
  ENDCASE.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form download_template</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; LV_FILENAME</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM download_template  USING  pv_filename.
  DATA : wwwdata_item LIKE wwwdatatab,
         rc           TYPE i.

  gv_file = pv_filename.

  CALL FUNCTION 'WS_FILE_DELETE'
    EXPORTING
      file   = gv_file
    IMPORTING
      return = rc.

  SELECT SINGLE * FROM wwwdata
    INTO CORRESPONDING FIELDS OF wwwdata_item
   WHERE objid = 'ZEXCEL_UPLOAD'. " Form name

  CALL FUNCTION 'DOWNLOAD_WEB_OBJECT'
    EXPORTING
      key         = wwwdata_item
      destination = gv_file.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_browser_info</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_browser_info .

  IF w_pfolder IS NOT INITIAL.
    w_initialfolder = w_pfolder.
  ELSE.
    CALL METHOD cl_gui_frontend_services=&gt;get_temp_directory
      CHANGING
        temp_dir = w_initialfolder.
  ENDIF.

  CALL METHOD cl_gui_frontend_services=&gt;directory_browse
    EXPORTING
      window_title    = 'Download path'
      initial_folder  = w_initialfolder
    CHANGING
      selected_folder = w_pickedfolder.

  IF sy-subrc = 0.
    w_pfolder = w_pickedfolder.
  ELSE.
    MESSAGE i001 WITH TEXT-e05 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form f4_filename</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM f4_filename .

<font color ="#0000FF">*********************************************************************</font>
<font color ="#0000FF">* Upload 할 파일을 찾는다</font>
<font color ="#0000FF">**********************************************************************</font>
  DATA : lt_files  TYPE filetable,
         ls_files  LIKE LINE OF lt_files,
         lv_filter TYPE string,
         lv_path   TYPE string,
         lv_rc     TYPE i.

  CONCATENATE cl_gui_frontend_services=&gt;filetype_excel
              'Excel 통합 문서(*.XLSX)|*.XLSX|'
              INTO lv_filter.

  CALL METHOD cl_gui_frontend_services=&gt;file_open_dialog
    EXPORTING
      window_title            = 'File open'
      file_filter             = lv_filter
      initial_directory       = lv_path
    CHANGING
      file_table              = lt_files
      rc                      = lv_rc
    EXCEPTIONS
      file_open_dialog_failed = 1
      cntl_error              = 2
      error_no_gui            = 3
      not_supported_by_gui    = 4
      OTHERS                  = 5.

  CHECK sy-subrc EQ 0.
  ls_files = VALUE #( lt_files[ 1 ] OPTIONAL ).

  CLEAR p_path.
  p_path = ls_files-filename.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_init_value</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_init_value .

<font color ="#0000FF">*-- For fuction key</font>
  MOVE : 'Template'   TO w_functxt-quickinfo,
         icon_xls     TO w_functxt-icon_id,
         'Excel form' TO w_functxt-icon_text,
         w_functxt    TO sscrfields-functxt_01.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form upload_logic</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM upload_logic .

  " 엑셀 데이터 타입 정의
  TYPES: truxs_t_text_data(4096) TYPE c OCCURS 0.

  " 파일 다이얼로그용 변수
  DATA: lt_files  TYPE filetable,
        ls_files  LIKE LINE OF lt_files,
        lv_filter TYPE string,
        lv_path   TYPE rlgrap-filename,
        lv_rc     TYPE i.

  " 엑셀 읽기용 변수
  DATA: lt_excel TYPE TABLE OF alsmex_tabline WITH HEADER LINE,
        lv_index TYPE sy-tabix.

  " 필드 매핑용 필드심볼
  FIELD-SYMBOLS: &lt;field&gt;.

  " 초기화
  CLEAR: gt_excel, gs_excel, lv_index.

<font color ="#0000FF">*-----------------------------------------------------------------------</font>
<font color ="#0000FF">* 1. 파일 다이얼로그</font>
<font color ="#0000FF">*-----------------------------------------------------------------------</font>
  CONCATENATE cl_gui_frontend_services=&gt;filetype_excel
              'Excel 문서 (*.XLS)|*.XLS|'
              INTO lv_filter.

  CALL METHOD cl_gui_frontend_services=&gt;file_open_dialog
    EXPORTING
      window_title            = '파일 열기'
      file_filter             = lv_filter
    CHANGING
      file_table              = lt_files
      rc                      = lv_rc
    EXCEPTIONS
      file_open_dialog_failed = 1
      cntl_error              = 2
      error_no_gui            = 3
      not_supported_by_gui    = 4
      OTHERS                  = 5.

  IF sy-subrc &lt;&gt; 0 OR lt_files IS INITIAL.
    MESSAGE '파일을 선택하지 않았습니다.' TYPE 'I'.
    RETURN.
  ENDIF.

  ls_files = lt_files[ 1 ].
  lv_path  = ls_files-filename.

<font color ="#0000FF">*-----------------------------------------------------------------------</font>
<font color ="#0000FF">* 2. 엑셀 읽기</font>
<font color ="#0000FF">*-----------------------------------------------------------------------</font>
  CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE'
    EXPORTING
      filename                = lv_path
      i_begin_col             = 1
      i_begin_row             = 3
      i_end_col               = 100
      i_end_row               = 50000
    TABLES
      intern                  = lt_excel
    EXCEPTIONS
      inconsistent_parameters = 1
      upload_ole              = 2
      OTHERS                  = 3.

  IF sy-subrc &lt;&gt; 0 OR lt_excel[] IS INITIAL.
    MESSAGE '엑셀 업로드 중 오류가 발생했습니다.' TYPE 'E'.
    RETURN.
  ENDIF.

  SORT lt_excel BY row col.

<font color ="#0000FF">*-----------------------------------------------------------------------</font>
<font color ="#0000FF">* 3. 엑셀 → 내부 구조 매핑</font>
<font color ="#0000FF">*-----------------------------------------------------------------------</font>
  LOOP AT lt_excel.

    lv_index = lt_excel-col.
    ASSIGN COMPONENT lv_index OF STRUCTURE gs_excel TO &lt;field&gt;.
    IF sy-subrc = 0.
      &lt;field&gt; = lt_excel-value.
    ENDIF.

    AT END OF row.
      APPEND gs_excel TO gt_excel.
      CLEAR gs_excel.
    ENDAT.

  ENDLOOP.
<font color ="#0000FF">*-----------------------------------------------------------------------</font>
<font color ="#0000FF">* 4. 결과 적용</font>
<font color ="#0000FF">*-----------------------------------------------------------------------</font>

  LOOP AT gt_excel INTO gs_excel.
    CLEAR : gs_iv, gv_vbeln.

    " 송장 번호 채번 (엑셀 송장번호가 비어있다면)
    IF gs_excel-vbeln_bil IS INITIAL AND gs_excel-ebeln IS NOT INITIAL.
      PERFORM create_vbeln_bil.
    ENDIF.

    " 중복 송장번호 확인
    IF gv_vbeln IS INITIAL.
      MESSAGE s000 WITH '중복된 송장 번호입니다' DISPLAY LIKE 'E'.
      CONTINUE.
    ENDIF.

    " 엑셀 데이터 -&gt; 내부 구조 복사
    MOVE-CORRESPONDING gs_excel TO gs_iv.

    " ✅ 금액 필드 보정 (SAP CURR 필드는 Decimal = 2이므로 / 100)
    IF gs_iv-wrbtr IS NOT INITIAL.
      gs_iv-wrbtr = gs_iv-wrbtr / 100.
    ENDIF.

    gs_iv-vbeln_bil = gv_vbeln. " 반드시 복사
    gs_iv-sort_key  = 'A'.
    gv_save_flag    = 'X'.

    MOVE-CORRESPONDING gs_iv TO gs_excel_save.

    " 결과 테이블에 추가
    APPEND gs_iv TO gt_iv.
    APPEND gs_excel_save TO gt_excel_save.

  ENDLOOP.

  PERFORM set_color_new.
  PERFORM set_color_point.      "새로 업로드된 것에 대한 색상 주기
  PERFORM refresh_table.

  MESSAGE |총 { lines( gt_excel_save ) }건의 데이터를 업로드했습니다.| TYPE 'S'.

ENDFORM.

<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_edit_toolbar</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_OBJECT</font>
<font color ="#0000FF">*&      --&gt; E_INTERACTIVE</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_edit_toolbar  USING   po_object TYPE REF TO cl_alv_event_toolbar_set
                                  pv_interactive.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object-&gt;mt_toolbar.

  CLEAR gs_button.
  gs_button-function = 'DROW'.
  gs_button-icon     = 	icon_delete_row .
  gs_button-quickinfo = '송장 삭제'.
  gs_button-text = TEXT-i05.
  APPEND gs_button TO po_object-&gt;mt_toolbar.

  CLEAR gs_button.
  gs_button-function = 'CHCK'.
  gs_button-icon     = 	icon_checked .
  gs_button-quickinfo = '송장검증'.
  gs_button-text = TEXT-i01.
  APPEND gs_button TO po_object-&gt;mt_toolbar.



ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_user_command</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_UCOMM</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_user_command  USING    pv_ucomm.

  CASE pv_ucomm.
    WHEN 'DROW'. " Delete row
      PERFORM delete_row.
      PERFORM count_now_data.
    WHEN 'CHCK'.            " 송장검증
      PERFORM check_iv.
      PERFORM count_now_data.
      PERFORM set_color_not100.       "100%아닌 인것에만 색상주기
      PERFORM refresh_table.
    WHEN 'DONE'.            " 검증확정
      PERFORM done_check.
      PERFORM count_now_data.
      PERFORM refresh_table.
    WHEN 'ORDR'.            " 구매오더생성
      PERFORM make_order.
      PERFORM count_now_data.
      PERFORM set_color_not100.       "100%아닌 인것에만 색상주기
      PERFORM refresh_table.

      CLEAR pv_ucomm.
  ENDCASE .
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_iv</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_iv .
  DATA: lt_roid       TYPE lvc_t_roid,
        ls_roid       TYPE lvc_s_roid,
        ls_save       TYPE zc102mmt0015,
        lt_save       TYPE TABLE OF zc102mmt0015,
        lt_delete_idx TYPE STANDARD TABLE OF i WITH DEFAULT KEY,
        lt_vbeln_bil  TYPE STANDARD TABLE OF zc102mmt0015-vbeln_bil  WITH DEFAULT KEY,
        lv_index      TYPE sy-tabix,
        lv_tabix      TYPE sy-tabix,
        lv_error      TYPE abap_bool VALUE abap_false,
        lv_valid      TYPE abap_bool,
        lt_color      TYPE lvc_t_scol.

  " 선택한 행 가져오기
  CALL METHOD go_left_grid-&gt;get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

  IF lt_roid IS INITIAL.
    MESSAGE s000 WITH '선택된 항목이 없습니다.' DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- 유효성 검사(사원 이름 입력)</font>
  PERFORM check_so_input_validity CHANGING lv_valid.
  IF lv_valid = abap_false.
    RETURN.
  ENDIF.

<font color ="#0000FF">*--사용자에게 검증 진행할거냐고 확인받기</font>
  PERFORM confirm_chck CHANGING gv_answer.
  CHECK gv_answer EQ '1'.

<font color ="#0000FF">*-- 유효성 검사(검증 불가 항목  메세지 띄우기)</font>
  LOOP AT lt_roid INTO ls_roid.

    READ TABLE gt_iv INTO gs_iv INDEX ls_roid-row_id.
    IF gs_iv-qcheck = 'N'.
      MESSAGE s000 WITH '품질검수가 완료된 항목에 대해서만 검수할 수 있습니다.' DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.


    "2. 입고예정일이 과거인지 확인
    IF gs_iv-gredat IS NOT INITIAL AND gs_iv-gredat &lt; sy-datum.
      MESSAGE s000 WITH '입고예정일이 과거인 항목은 검수할 수 없습니다.' DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    CLEAR gs_check.

    MOVE-CORRESPONDING gs_iv TO gs_check.

    gs_check-percent = ( gs_check-grqty / gs_check-odrqu ) * 100.
    gs_check-percent_txt = |{ gs_check-percent DECIMALS = 2 }%|.
    gs_check-ckdat   = sy-datum.
    gs_check-partner = gs_iv-partner.
    gs_check-color = lt_color.
    gs_check-state = 'X'.       "상태 표시해주기 (송장검증 버튼 눌러서 넘어갈때)

    MOVE-CORRESPONDING gs_check TO ls_save.
    APPEND ls_save TO lt_save.
    APPEND gs_check TO gt_check.
    APPEND gs_iv TO gt_delete.

<font color ="#0000FF">*-- 전표 생성</font>
    call function <a href ="zfm_cl102_fi_01/zfm_cl102_fi_01.html">'ZFM_CL102_FI_01'</a>
      EXPORTING
        iv_bktxt   = '매입 전표'
        iv_waers   = gs_iv-waers
        iv_wrbtr   = gs_iv-wrbtr
        iv_ebeln   = gs_iv-ebeln
        iv_partner = gs_iv-partner
        iv_blart   = 'KI'.
  ENDLOOP.

  CLEAR : gs_delete, gs_iv.

  LOOP AT gt_delete INTO gs_delete.
    DELETE gt_iv WHERE ebeln = gs_delete-ebeln
                   AND partner = gs_delete-partner
                   AND vbeln_bil = gs_delete-vbeln_bil.
  ENDLOOP.

  MODIFY zc102mmt0015 FROM TABLE lt_save.

<font color ="#0000FF">*--강제 pbo</font>
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.


  PERFORM refresh_table.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form confirm_delete</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- GV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM confirm_delete  CHANGING pv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = '삭제 확인'
      text_question         = '선택한 업로드 송장을 정말 삭제하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer. " Yes

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_status_icon</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_status_icon .



ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form save_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM usave_data .
  DATA : lt_save  TYPE TABLE OF zc102mmt0015,
         ls_save  TYPE zc102mmt0015,
         lv_tabix TYPE sy-tabix,
         lv_flag,
         lv_valid TYPE abap_bool,
         lv_msg   TYPE string.

  CALL METHOD go_left_grid-&gt;check_changed_data.
  CALL METHOD go_right_grid-&gt;check_changed_data.

<font color ="#0000FF">*-- 유효성 검사</font>
  PERFORM check_so_input_validity CHANGING lv_valid.
  IF lv_valid = abap_false.
    RETURN.
  ENDIF.

<font color ="#0000FF">*--데이터 저장 전 사용자에게 확인</font>
  PERFORM confirm_usave CHANGING gv_answer.

  CHECK gv_answer EQ '1'.

<font color ="#0000FF">*-- Set Time stamp</font>
  LOOP AT gt_iv2 INTO gs_iv2 WHERE modi_yn EQ abap_true.

    lv_tabix  = sy-tabix.

    IF gs_iv-ckdat  IS INITIAL.
      gs_iv2-ckdat = sy-datum.
    ENDIF.


    CLEAR  gs_iv2-modi_yn.

    MODIFY  gt_iv2 FROM gs_iv2 INDEX lv_tabix
                                TRANSPORTING ckdat.

  ENDLOOP.
<font color ="#0000FF">*--송장 업로드 된 부분 넘겨주기</font>
  CLEAR lt_save.

  LOOP AT gt_excel_save INTO gs_excel_save.
    MOVE-CORRESPONDING gs_excel_save TO ls_save.

    IF ls_save-erdat IS INITIAL.
      ls_save-erdat = sy-datum.
      ls_save-erzet = sy-uzeit.
      ls_save-ernam = sy-uname.
    ENDIF.


    APPEND ls_save TO lt_save.
  ENDLOOP.

  LOOP AT gt_iv INTO gs_iv.
    MOVE-CORRESPONDING gs_iv TO ls_save.

    IF ls_save-erdat IS INITIAL.
      ls_save-erdat = sy-datum.
      ls_save-erzet = sy-uzeit.
      ls_save-ernam = sy-uname.
    ENDIF.

    APPEND ls_save TO lt_save.
  ENDLOOP.

  MODIFY zc102mmt0015 FROM TABLE lt_save.


<font color ="#0000FF">*--강제 pbo</font>
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.


  IF sy-subrc = 0.
    MESSAGE s085.
    COMMIT WORK.

  ENDIF.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form confirm_save</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- GV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM confirm_usave  CHANGING pv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Data save dialog'
      text_question         = '업로드된 송장 정보는 확정 후에는 수정이 어렵습니다.그래도 확정하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer. " Yes

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form popup_to_confirm_back</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- GV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM popup_to_confirm_back  CHANGING pv_answer.


  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Data save'
      text_question         = TEXT-q01
      text_button_1         = 'Yes'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = 'No'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color_new</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_color_new .

  DATA : lv_tabix TYPE sy-tabix,
         ls_style TYPE lvc_s_styl,
         lv_icon  TYPE icon_d,
         lt_roid  TYPE lvc_t_roid,
         ls_roid  TYPE lvc_s_roid.

  LOOP AT gt_iv INTO gs_iv.


    lv_tabix = sy-tabix.
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    " 수량 불일치 시 빨간불 처리</font>
<font color ="#0000FF">*    IF gs_iv-odrqu &lt;&gt; gs_iv-grqty.</font>
<font color ="#0000FF">*      gs_iv-status = icon_led_red.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    ELSE.</font>
    " 수량 같을 경우 품질검수 상태에 따라 색상 처리
    CASE gs_iv-qcheck.
      WHEN 'Y'.
        gs_iv-status = icon_led_yellow.  " (green spelling correction)
        gv_cnt1 = gv_cnt1 + 1. " 카운트 증가
      WHEN 'N'.
        gs_iv-status = icon_led_red.
        gv_cnt2 = gv_cnt2 + 1. " 카운트 증가
    ENDCASE.
<font color ="#0000FF">*    ENDIF.</font>

    MODIFY gt_iv FROM gs_iv INDEX lv_tabix TRANSPORTING status.

  ENDLOOP.




ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_bottom_fcat</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_bottom_fcat  USING  pv_key pv_field pv_table pv_just pv_emph.

  gs_bottom_fcat-key        = pv_key.
  gs_bottom_fcat-fieldname  = pv_field.
  gs_bottom_fcat-ref_table  = pv_table.
  gs_bottom_fcat-just       = pv_just.
  gs_bottom_fcat-emphasize  = pv_emph.

  CASE pv_field.
    WHEN 'GRQTY'.
      gs_bottom_fcat-qfieldname = 'MEINS'.
    WHEN 'WRBTR'.
      gs_bottom_fcat-cfieldname = 'WAERS'.
      gs_bottom_fcat-coltext    = '금액'.
    WHEN 'STATUS'.
      gs_bottom_fcat-coltext = '송장검증상태'.
      gs_bottom_fcat-icon = 'X'.
    WHEN 'MEINS'.
      gs_bottom_fcat-coltext      = '단위'.
    WHEN 'WRBTR'.
      gs_bottom_fcat-cfieldname = 'WAERS'.   "금액단위
      gs_bottom_fcat-coltext    = '금액'.
    WHEN 'WAERS'.
      gs_bottom_fcat-fieldname    = 'WAERS'.
      gs_bottom_fcat-coltext      = '통화키'.
      gs_bottom_fcat-outputlen    = 5.      " 출력 길이 설정 필수
      gs_bottom_fcat-no_out       = abap_false. " 숨김 방지
    WHEN 'ERNAM'.
      gs_bottom_fcat-coltext    = '처리자'.
  ENDCASE.

  APPEND gs_bottom_fcat TO gt_bottom_fcat.
  CLEAR gs_bottom_fcat.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_bottom_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_bottom_screen .

  PERFORM set_variant USING 'ALV3'.
  CALL METHOD go_bottom_grid-&gt;set_table_for_first_display
    EXPORTING
      is_variant      = gs_variant
      i_save          = 'A'
      i_default       = 'X'
      is_layout       = gs_bottom_layout
    CHANGING
      it_outtab       = gt_iv2
      it_fieldcatalog = gt_bottom_fcat.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form done_check</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM done_check .
  DATA: lt_save       TYPE TABLE OF zc102mmt0015,
        ls_save       TYPE zc102mmt0015,lt_roid       TYPE lvc_t_roid,
        ls_roid       TYPE lvc_s_roid,
        lt_delete_idx TYPE STANDARD TABLE OF i WITH DEFAULT KEY,
        lv_valid      TYPE abap_bool,
        lv_tabix      TYPE sy-tabix.

  " 선택한 행 가져오기
  CALL METHOD go_right_grid-&gt;get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

  IF lt_roid IS INITIAL.
    MESSAGE s000 WITH '선택된 항목이 없습니다.' DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  LOOP AT lt_roid INTO ls_roid.
    READ TABLE gt_check INTO gs_check INDEX ls_roid-row_id.
    IF sy-subrc = 0 AND gs_check-percent &lt;&gt; 100.
      IF gs_check-reorder IS INITIAL.
        MESSAGE s000 WITH '검증 확정은 100% 완료된 항목/ 재구매오더가 생성된 항목에 대해서만 가능합니다.' DISPLAY LIKE 'E'.
        RETURN.
      ENDIF.
    ENDIF.
  ENDLOOP.

<font color ="#0000FF">*-- 유효성 검사</font>
  PERFORM check_so_input_validity CHANGING lv_valid.
  IF lv_valid = abap_false.
    RETURN.
  ENDIF.


<font color ="#0000FF">*--사용자에게 검증 진행할거냐고 확인받기</font>
  PERFORM confirm_done_chck CHANGING gv_answer.
  CHECK gv_answer EQ '1'.

  LOOP AT lt_roid INTO ls_roid.

    READ TABLE gt_check INTO gs_check INDEX ls_roid-row_id.
    IF sy-subrc = 0.

<font color ="#0000FF">*-- 전표 번호 생성</font>
      PERFORM get_belnr.
<font color ="#0000FF">*-- 인터널 테이블 수정</font>
      CLEAR gs_iv2.
      MOVE-CORRESPONDING gs_check TO gs_iv2.

      gs_iv2-status = icon_led_green.
      gs_iv2-erdat = sy-datum.
      gs_iv2-erzet = sy-uzeit.
      gs_iv2-ernam = sy-uname.
      gs_iv2-belnr = gv_belnr.
      gs_iv2-state = 'O'.
      gs_iv2-check_iv = 'X'.


      INSERT gs_iv2 INTO gt_iv2 INDEX 1.  "맨위롷 쌓기
<font color ="#0000FF">*      APPEND gs_iv2 TO gt_iv2.</font>
      APPEND gs_check TO gt_check_del.
      MOVE-CORRESPONDING gs_iv2 TO ls_save.
      APPEND ls_save TO lt_save.

    ENDIF.

  ENDLOOP.

  CLEAR gs_check.
<font color ="#0000FF">**********************************************************************</font>

  LOOP AT lt_roid INTO ls_roid.
    CLEAR : gs_check, gs_po.
    READ TABLE gt_check INTO gs_check INDEX ls_roid-row_id.
    IF sy-subrc = 0.
      READ TABLE gt_po INTO gs_po WITH KEY ebeln = gs_check-ebeln.
      IF sy-subrc = 0.
        UPDATE zc102mmt0011 SET check_iv = 'X'
                                              WHERE ebeln = gs_po-ebeln
                                                AND prno  = gs_po-prno
                                                AND stlno = gs_po-stlno.
      ENDIF.
    ENDIF.
  ENDLOOP.

  MODIFY zc102mmt0015 FROM TABLE lt_save.

  LOOP AT gt_check_del INTO gs_check_del.
    DELETE gt_check WHERE ebeln = gs_check_del-ebeln
                      AND partner = gs_check_del-partner
                      AND vbeln_bil = gs_check_del-vbeln_bil.
  ENDLOOP.

  IF sy-subrc = 0.
    MESSAGE s085.
    CLEAR : lt_save, gt_check_del.
    COMMIT WORK AND WAIT.

  ENDIF.

  MESSAGE s000 WITH '송장 검증이 완료되었습니다.' DISPLAY LIKE 'S'.


<font color ="#0000FF">*--강제 pbo</font>
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form handle_edit_toolbar2</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_OBJECT</font>
<font color ="#0000FF">*&      --&gt; E_INTERACTIVE</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM handle_edit_toolbar2  USING     po_object TYPE REF TO cl_alv_event_toolbar_set
                                     pv_interactive.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object-&gt;mt_toolbar.

  CLEAR gs_button.
  gs_button-function = 'DONE'.
  gs_button-icon     = icon_complete .
  gs_button-quickinfo = '검증확정'.
  gs_button-text = TEXT-i02.
  APPEND gs_button TO po_object-&gt;mt_toolbar.


  CLEAR gs_button.
  gs_button-function = 'ORDR'.
  gs_button-icon     = 	icon_create  .
  gs_button-quickinfo = '재구매오더생성'.
  gs_button-text = TEXT-i04.
  APPEND gs_button TO po_object-&gt;mt_toolbar.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_percent</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_percent .

  DATA: lv_percent TYPE p DECIMALS 1.

  LOOP AT gt_check INTO DATA(ls_check).
    IF ls_check-odrqu &gt; 0.
      lv_percent = ( ls_check-grqty * 100 ) / ls_check-odrqu.
    ELSE.
      lv_percent = 0.
    ENDIF.

    ls_check-percent = lv_percent.  " ← percent는 새로 추가한 필드라고 가정
    MODIFY gt_check FROM ls_check.
  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_sort_b</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_sort_b.

  DATA : lv_tabix TYPE sy-tabix.

  LOOP AT gt_iv INTO gs_iv.

    lv_tabix = sy-tabix.

    CLEAR gs_iv-color.
    gs_iv-sort_key = 'B'.
    MODIFY gt_iv FROM gs_iv INDEX lv_tabix TRANSPORTING
                                                  sort_key color .

  ENDLOOP.

ENDFORM.

<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form add_row</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; LR_DD_TABLE</font>
<font color ="#0000FF">*&      --&gt; COL_FIELD</font>
<font color ="#0000FF">*&      --&gt; COL_VALUE</font>
<font color ="#0000FF">*&      --&gt; P_</font>
<font color ="#0000FF">*&      --&gt; LV_TEXT</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM add_row  USING  pr_dd_table  TYPE REF TO cl_dd_table_element
                   pv_col_field TYPE REF TO cl_dd_area
                   pv_col_value TYPE REF TO cl_dd_area
                   pv_field
                   pv_text.

  DATA : lv_text TYPE sdydo_text_element.

<font color ="#0000FF">*-- Field.</font>
  lv_text = pv_field.

  CALL METHOD pv_col_field-&gt;add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=&gt;strong
      sap_color    = cl_dd_document=&gt;list_heading_inv.

  CALL METHOD pv_col_field-&gt;add_gap
    EXPORTING
      width = 3.

<font color ="#0000FF">*-- Value.</font>
  lv_text = pv_text.

  CALL METHOD pv_col_value-&gt;add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=&gt;heading
      sap_color    = cl_dd_document=&gt;list_negative_inv.

  CALL METHOD pv_col_value-&gt;add_gap
    EXPORTING
      width = 3.

  CALL METHOD pr_dd_table-&gt;new_row.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form update_check_percent</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; LV_INDEX</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM update_check_percent.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  DATA : ls_good_cells TYPE lvc_s_modi,</font>
<font color ="#0000FF">*         lt_good_cells TYPE lvc_t_modi,</font>
<font color ="#0000FF">*         lv_percent    TYPE p DECIMALS 2.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  LOOP AT lt_good_cells INTO ls_good_cells.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    CLEAR gs_check.</font>
<font color ="#0000FF">*    READ TABLE gt_check INTO gs_check INDEX ls_good_cells-row_id.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    CASE ls_good_cells-fieldname.</font>
<font color ="#0000FF">*      WHEN 'PERCENT'.</font>
<font color ="#0000FF">*        IF gs_check-grqty &lt;&gt; gs_check-odrqu.</font>
<font color ="#0000FF">*          MESSAGE i034 DISPLAY LIKE 'W'.</font>
<font color ="#0000FF">*          MODIFY gt_check FROM gs_check INDEX ls_good_cells-row_id.</font>
<font color ="#0000FF">*        ELSE.</font>
<font color ="#0000FF">*          gs_check-percent =  ( gs_check-grqty / gs_check-odrqu ) * 100.</font>
<font color ="#0000FF">*          gs_check-percent_txt = |{ lv_percent DECIMALS = 2 }%|.</font>
<font color ="#0000FF">*        ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*        gs_check-ckdat = sy-datum.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*        IF gs_check-odrqu IS NOT INITIAL AND gs_check-odrqu &lt;&gt; 0.</font>
<font color ="#0000FF">*          gs_check-percent = ( gs_check-grqty / gs_check-odrqu ) * 100.</font>
<font color ="#0000FF">*          gs_check-percent_txt = |{ gs_check-percent DECIMALS = 2 }%|.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*          MODIFY gt_check FROM gs_check INDEX pv_index TRANSPORTING percent percent_txt ckdat.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form update_check_percent</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM update_check_percent.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_check_percent_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_check_percent_data .

  DATA: lt_roid TYPE lvc_t_roid,
        ls_roid TYPE lvc_s_roid.

  CALL METHOD go_left_grid-&gt;get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

  LOOP AT lt_roid INTO ls_roid.

    READ TABLE gt_check INTO gs_check INDEX ls_roid-row_id.
    IF sy-subrc &lt;&gt; 0.
      CONTINUE.
    ENDIF.

    " 일치율 계산
    IF gs_check-odrqu IS NOT INITIAL AND gs_check-odrqu &lt;&gt; 0.
      gs_check-percent = ( gs_check-grqty / gs_check-odrqu ) * 100.
      gs_check-percent_txt = |{ gs_check-percent DECIMALS = 2 }%|.
    ELSE.
      gs_check-percent = 0.
      gs_check-percent_txt = '0.00%'.
    ENDIF.

    gs_check-ckdat = sy-datum. " 검토일자도 같이 넣기

    MODIFY gt_check FROM gs_check INDEX ls_roid-row_id
                    TRANSPORTING percent percent_txt ckdat.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*FORM set_color .</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  DATA : lv_tabix TYPE sy-tabix,</font>
<font color ="#0000FF">*         ls_scol  TYPE lvc_s_scol.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  LOOP AT gt_check INTO gs_check.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    lv_tabix = sy-tabix.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    CLEAR : ls_scol, gs_check-color. " Clear the Color manager</font>
<font color ="#0000FF">*    CASE percent.</font>
<font color ="#0000FF">*      WHEN 100.</font>
<font color ="#0000FF">*        ls_scol-fname     = 'PERCENT'. " 색을 적용할 필드명</font>
<font color ="#0000FF">*        ls_scol-color-col = 3.         " 초록색 (SAP 표준)</font>
<font color ="#0000FF">*        ls_scol-color-int = 1.         " 강조 표시</font>
<font color ="#0000FF">*        INSERT ls_scol INTO TABLE gs_check-color.</font>
<font color ="#0000FF">*    ENDCASE.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    MODIFY gt_check FROM gs_check INDEX lv_tabix</font>
<font color ="#0000FF">*                          TRANSPORTING color.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  ENDLOOP.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*ENDFORM.</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_qcheck_status</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_qcheck_status .

  CLEAR : gv_cnt1, gv_cnt2.


  DATA : lv_tabix TYPE sy-tabix,
         ls_style TYPE lvc_s_styl,
         lv_icon  TYPE icon_d.

  LOOP AT gt_iv INTO gs_iv.


    lv_tabix = sy-tabix.


    " 수량 같을 경우 품질검수 상태에 따라 색상 처리
    CASE gs_iv-qcheck.
      WHEN 'Y'.
        gs_iv-status = icon_led_yellow.  " (green spelling correction)
        gv_cnt1 += 1.
      WHEN 'N'.
        gs_iv-status = icon_led_red.
        gv_cnt2 += 1.
    ENDCASE.


    MODIFY gt_iv FROM gs_iv INDEX lv_tabix TRANSPORTING status.

  ENDLOOP.

  " Bottom 에 대해서 송장검증완료 항목 다 녹색불로 바꿔주기
  LOOP AT gt_iv2 INTO gs_iv2.

    lv_tabix = sy-tabix.
    gs_iv2-status = icon_led_green.
<font color ="#0000FF">*    gv_cnt3 += 1.</font>
    MODIFY gt_iv2 FROM gs_iv2 INDEX lv_tabix TRANSPORTING status.

  ENDLOOP.



<font color ="#0000FF">*  LOOP AT gt_check INTO gs_check.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    lv_tabix = sy-tabix.</font>
<font color ="#0000FF">*    gv_cnt4 += 1.</font>
<font color ="#0000FF">*    MODIFY  gt_check FROM gs_check INDEX lv_tabix.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  ENDLOOP.</font>

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_qcheck</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_qcheck .
  DATA: lt_roid  TYPE lvc_t_roid,
        ls_roid  TYPE lvc_s_roid,
        lv_tabix TYPE sy-tabix.

  LOOP AT lt_roid INTO ls_roid.
    lv_tabix = ls_roid-row_id.

    READ TABLE gt_iv INTO gs_iv INDEX lv_tabix.
    IF sy-subrc = 0 AND gs_iv-qcheck = 'N'.
      MESSAGE s000 WITH '품질검수가 완료된 항목에 대해서만 검수 가능합니다.' DISPLAY LIKE 'E'.
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form confirm_done_chck</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- GV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM confirm_done_chck  CHANGING pv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Data check dialog'
      text_question         = '선택한 항목에 대한 송장 검증을 확정하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer. " Yes


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_sort</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_sort .

  gs_sort-spos = 1.            " 정렬 우선순서
  gs_sort-fieldname = 'VBELN_BIL'.
  gs_sort-up        = 'X'.     " ASC

  APPEND gs_sort TO gt_sort.
  CLEAR gs_sort.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form pass_item</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM pass_item .

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form cant_message</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM cant_message .

  DATA: lt_roid  TYPE lvc_t_roid,
        ls_roid  TYPE lvc_s_roid,
        lv_tabix TYPE sy-tabix.


  LOOP AT lt_roid INTO ls_roid.
    lv_tabix = ls_roid-row_id.

    READ TABLE gt_iv INTO gs_iv INDEX lv_tabix.
    IF sy-subrc = 0.
      IF gs_iv-qcheck = 'N' AND gs_iv-odrqu &lt;&gt; gs_iv-grqty.
        MESSAGE s000 WITH '검수 불가: 품질검사 미완료 및 수량 불일치 항목입니다.' DISPLAY LIKE 'E'.
        EXIT.

      ELSEIF gs_iv-qcheck = 'N'.
        MESSAGE s000 WITH '품질검수가 완료된 항목에 대해서만 검수할 수 있습니다.' DISPLAY LIKE 'E'.
        EXIT.

      ELSEIF gs_iv-odrqu &lt;&gt; gs_iv-grqty.
        MESSAGE s000 WITH '주문수량과 실입고 수량이 일치할 때만 검수할 수 있습니다.' DISPLAY LIKE 'E'.
        EXIT.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color_point</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_color_point .

  DATA : lv_tabix TYPE sy-tabix,
         ls_scol  TYPE lvc_s_scol.

  LOOP AT gt_iv INTO gs_iv.

    lv_tabix = sy-tabix.

    CLEAR : ls_scol, gs_iv-color. " Clear the Color manager

    IF gs_iv-sort_key = 'A'.
      ls_scol-fname     = ''.
      ls_scol-color-col = 3.
      ls_scol-color-int = 1.
      INSERT ls_scol INTO TABLE gs_iv-color.
    ENDIF.


<font color ="#0000FF">*    gs_iv-sort_key = 'A'.</font>


    MODIFY gt_iv FROM gs_iv INDEX lv_tabix
                                  TRANSPORTING color.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form make_order</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM make_order .

  DATA: lt_roid       TYPE lvc_t_roid,
        ls_roid       TYPE lvc_s_roid,
        lt_delete_idx TYPE STANDARD TABLE OF i WITH DEFAULT KEY,
        lv_tabix      TYPE sy-tabix,
        lt_save       TYPE TABLE OF zc102mmt0011,
        lt_color      TYPE lvc_t_scol,
        lv_valid      TYPE abap_bool,
        lv_ebeln      TYPE zc102mmt0011-ebeln.

  CLEAR : gt_ldtime.

<font color ="#0000FF">*-- 입고리드타임 조회</font>
  SELECT rgtime
    INTO CORRESPONDING FIELDS OF TABLE gt_ldtime
    FROM zc102mmt0004.

<font color ="#0000FF">*--선택한 행 가져오기</font>
  CALL METHOD go_right_grid-&gt;get_selected_rows
    IMPORTING
      et_row_no = lt_roid.


  IF lt_roid IS INITIAL.
    MESSAGE s000 WITH '선택된 항목이 없습니다.' DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

<font color ="#0000FF">*-- 일치율이 100%인 항목은 구매오더를 생성할 수 없음</font>
  LOOP AT lt_roid INTO ls_roid.

    READ TABLE gt_check INTO gs_check INDEX ls_roid-row_id.

<font color ="#0000FF">*-- 유효성 검사(수량 일치 여부)</font>
    IF gs_check-percent = 100.
      MESSAGE s000 WITH '수량이 일치하여 구매오더 생성 대상이 아닙니다.'  DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

<font color ="#0000FF">*--유효성 검사(이미 구매오더 생성된 건에 대해서 확인)</font>
    IF gs_check-reorder = 'X'.
      MESSAGE s000 WITH '해당 건은 이미 구매오더가 생성되어 처리할 수 없습니다.'  DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

  ENDLOOP.

<font color ="#0000FF">*-- 유효성 검사(사원 이름 입력)</font>
  PERFORM check_so_input_validity CHANGING lv_valid.
  IF lv_valid = abap_false.
    RETURN.
  ENDIF.
  CLEAR : lt_save.

<font color ="#0000FF">*--사용자에게 구매오더 생성할거냐고 확인받기 (일치율이 100% 아닌 건에 대하여)</font>
  PERFORM confirm_make_order CHANGING gv_answer.
  CHECK gv_answer EQ '1'.

  LOOP AT lt_roid INTO ls_roid.
    CLEAR gs_check.
    READ TABLE gt_check INTO gs_check INDEX ls_roid-row_id.

<font color ="#0000FF">*-- 구매오더번호 채번</font>
    PERFORM create_ebeln CHANGING lv_ebeln.

<font color ="#0000FF">*-- 재구매오더 필드 매핑</font>
    PERFORM create_po USING lv_ebeln.
<font color ="#0000FF">*-- 송장 인터널 테이블 / DB테이블 변경</font>
    gs_check-reorder = 'X'.
    gs_check-reorder_icon = icon_okay.
    MODIFY gt_check FROM gs_check INDEX ls_roid-row_id
                                  TRANSPORTING reorder reorder_icon odrqu
                                               percent percent_txt stlno.

    UPDATE zc102mmt0015 SET reorder = 'X'
                                      WHERE vbeln_bil  = gs_check-vbeln_bil        "modify 대신에 update써주기 (pk 다 명시해주기
                                        AND partner    = gs_check-partner
                                        AND ebeln      = gs_check-ebeln.
  ENDLOOP.



<font color ="#0000FF">*-- lt save</font>
  MODIFY zc102mmt0011 FROM TABLE gt_save.


<font color ="#0000FF">*--강제 pbo</font>
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.

  IF sy-subrc EQ 0.
    COMMIT WORK.
    MESSAGE s000 WITH '부족 수량에 대한 구매오더가 생성되었습니다.' DISPLAY LIKE 'I'.
  ELSE.
    ROLLBACK WORK.
  ENDIF.

  CLEAR : gt_save.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color_not100</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_color_not100 .


  DATA: lv_tabix TYPE sy-tabix,
        ls_scol  TYPE lvc_s_scol.

  CLEAR lv_tabix.

  LOOP AT gt_check INTO gs_check.

    lv_tabix = sy-tabix.

    CLEAR: ls_scol, gs_check-color.

    " 퍼센트가 100%가 아닌 경우만 색 입히기
    IF ( gs_check-percent &lt; 100 ) AND
      ( gs_check-reorder IS INITIAL ).

      ls_scol-fname     = 'PERCENT'. " 해당 필드명 정확히 써야 함 (대소문자 구분 안 됨)
      ls_scol-color-col = 6.         " 예: 노란색 (기타 컬러는 아래 참고)
      ls_scol-color-int = 1.         " 진하게 표시

      INSERT ls_scol INTO TABLE gs_check-color.
    ENDIF.

    MODIFY gt_check FROM gs_check INDEX lv_tabix TRANSPORTING color.
    CLEAR gs_check.
  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form confirm_make_order</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- GV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM confirm_make_order  CHANGING pv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Check make order'
      text_question         = '선택한 항목에 대한 재구매오더를 생성하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer. " Yes


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_reorderno</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_reorderno .

  DATA: gv_number    TYPE n LENGTH 10,
        gv_prefix(3),
        gv_full_code TYPE string,
        gv_range_nr  TYPE inri-nrrangenr,
        gv_quantity  TYPE inri-quantity.

  DATA: ls_nriv TYPE nriv.

  gv_prefix = 'PO'.
  gv_range_nr = '02'. " 원하는 번호 - 도메인 정의서에 있음!!!
  gv_quantity = 1.    " 원하는 증가량 사용

<font color ="#0000FF">**********************************************************************</font>
<font color ="#0000FF">* 순번 호출</font>
<font color ="#0000FF">**********************************************************************</font>
  CALL METHOD zclc102cm_auto_sequence=&gt;get_next_value
    EXPORTING
      pv_range_nr = gv_range_nr
      pv_prefix   = gv_prefix
      pv_quantity = gv_quantity
    IMPORTING
      pv_result   = gv_full_code.

<font color ="#0000FF">*  gv_pdono = CONV zc102ppt0012-pdono( gv_full_code ).</font>
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_vbeln_bil</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_vbeln_bil .

  DATA: gv_number    TYPE n LENGTH 10,     " 도메인의 길이에 맞게
        gv_prefix(3),  " PPO, PD0 등
        gv_full_code TYPE string,
        gv_range_nr  TYPE inri-nrrangenr,
        gv_quantity  TYPE inri-quantity.

  DATA: ls_nriv TYPE nriv.

  gv_prefix = 'I'.  " 원하는 prefix 사용
  gv_range_nr = '02'. " 원하는 번호
  gv_quantity = 1.    " 원하는 증가량 사용

<font color ="#0000FF">**********************************************************************</font>
<font color ="#0000FF">* 순번 호출</font>
<font color ="#0000FF">**********************************************************************</font>
  CALL METHOD zclc102cm_auto_sequence=&gt;get_next_value
    EXPORTING
      pv_range_nr = gv_range_nr
      pv_prefix   = gv_prefix
      pv_quantity = gv_quantity
    IMPORTING
      pv_result   = gv_full_code.

  gv_vbeln = CONV zc102mmt0015-vbeln_bil( gv_full_code ).


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form download_logic</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM download_logic .


  DATA : wwwdata_item TYPE wwwdatatab,
         lv_filename  TYPE rlgrap-filename,
         lv_rc        TYPE i,
         lv_answer    TYPE c.

<font color ="#0000FF">*-- 사용자에게 폴더 선택 요청</font>
  IF objfile IS INITIAL.
    CREATE OBJECT objfile.
  ENDIF.

  objfile-&gt;get_temp_directory( CHANGING temp_dir = initialfolder ).
  objfile-&gt;directory_browse( EXPORTING initial_folder = initialfolder
                             CHANGING selected_folder = pickedfolder ).
  IF pickedfolder IS INITIAL.
    MESSAGE '폴더 선택이 취소되었습니다.' TYPE 'I'.
    RETURN.
  ENDIF.

<font color ="#0000FF">*-- 파일명 정의</font>
  CONCATENATE pickedfolder '\송장_엑셀업로드양식.XLS' INTO lv_filename.

<font color ="#0000FF">*-- 기존 파일 삭제 (있다면)</font>
  CALL FUNCTION 'WS_FILE_DELETE'
    EXPORTING
      file   = lv_filename
    IMPORTING
      return = lv_rc.

<font color ="#0000FF">*-- wwwdata에서 템플릿 가져오기</font>
  SELECT SINGLE * FROM wwwdata
    INTO CORRESPONDING FIELDS OF wwwdata_item
    WHERE objid = 'ZEXCEL_DOWNLOAD_CL102_MM04'.  " 등록된 템플릿 이름

  IF sy-subrc &lt;&gt; 0.
    MESSAGE '엑셀 템플릿이 시스템에 존재하지 않습니다.' TYPE 'E'.
    RETURN.
  ENDIF.

<font color ="#0000FF">*-- 템플릿 다운로드</font>
  CALL FUNCTION 'DOWNLOAD_WEB_OBJECT'
    EXPORTING
      key         = wwwdata_item
      destination = lv_filename.

  MESSAGE '엑셀 템플릿이 다운로드되었습니다.' TYPE 'S'.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_color_change</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_icon_x_reorder .


  DATA: lv_tabix TYPE sy-tabix,
        lt_color TYPE lvc_t_scol.


  LOOP AT gt_check INTO gs_check.

    lv_tabix = sy-tabix.


    " reorder 값이 'X'인 경우만 아이콘 설정
    IF gs_check-reorder = 'X'.
      gs_check-reorder_icon = icon_okay.


      MODIFY gt_check FROM gs_check INDEX lv_tabix TRANSPORTING reorder_icon .
    ENDIF.
  ENDLOOP.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_f4_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_f4_data .

  CLEAR gt_empno.
  SELECT empno empnam
    INTO CORRESPONDING FIELDS OF TABLE gt_empno
    FROM zc102hrt0002
    ORDER BY empno.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      Module  CUST_F4_EMPNAM  INPUT</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*       text</font>
<font color ="#0000FF">*----------------------------------------------------------------------*</font>
MODULE cust_f4_empno INPUT.



  IF zc102hrt0002-empno IS INITIAL.
    PERFORM set_search_help_empno.
  ENDIF.



ENDMODULE.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_search_help_empnam</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_search_help_empno .

  DATA: lt_return TYPE TABLE OF ddshretval,
        ls_return TYPE ddshretval,
        ls_empno  LIKE gs_empno.

  " F4 도움말 팝업 표시
  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'EMPNO'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_EMPNO-ENPNO'
      window_title = '사원명'
      value_org    = 'S'
    TABLES
      value_tab    = gt_empno
      return_tab   = lt_return.

<font color ="#0000FF">*  " 선택한 사원번호로 내부 테이블에서 사원명 조회</font>
<font color ="#0000FF">*  READ TABLE lt_return INTO ls_return INDEX 1.</font>
<font color ="#0000FF">*  IF sy-subrc = 0 AND ls_return-fieldval IS NOT INITIAL.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    zc102hrt0002-empno = ls_return-fieldval.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*    READ TABLE gt_empno INTO ls_empno WITH KEY empno = zc102hrt0002-empno.</font>
<font color ="#0000FF">*    IF sy-subrc = 0.</font>
<font color ="#0000FF">*      zc102hrt0002-empno = ls_empno-empno.</font>
<font color ="#0000FF">*    ELSE.</font>
<font color ="#0000FF">*      CLEAR zc102hrt0002-empno.</font>
<font color ="#0000FF">*    ENDIF.</font>
<font color ="#0000FF">*</font>
<font color ="#0000FF">*  ENDIF.</font>

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form count_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM count_data .

  gv_cnt1 = lines( gt_excel ).
  gv_cnt2 = lines( gt_iv ).
  gv_cnt3 = lines( gt_iv2 ).
  gv_cnt4 = lines( gt_check ).


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_so_input_validity</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- LV_VALID</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_so_input_validity  CHANGING pv_valid TYPE abap_bool.

  DATA: lv_valid_line TYPE abap_bool VALUE abap_false.

  CLEAR pv_valid.

<font color ="#0000FF">*-- 필수 필드 체크</font>
  IF  zc102hrt0002-empno IS INITIAL OR
     zc102hrt0002-empnam IS INITIAL.
    MESSAGE s081 DISPLAY LIKE 'E'. " 필수 항목이 입력되지 않았습니다.
    RETURN.
  ENDIF.

  pv_valid = abap_true.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form delete_row</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM delete_row .


  DATA: lt_roid        TYPE lvc_t_roid,
        ls_roid        TYPE lvc_s_roid,
        lv_deleted_cnt TYPE i,
        lv_skip_cnt    TYPE i.

  CLEAR: lt_roid, ls_roid, lv_deleted_cnt, lv_skip_cnt.

<font color ="#0000FF">*-- ALV에서 선택한 행 인덱스를 가져오기</font>
  CALL METHOD go_left_grid-&gt;get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

<font color ="#0000FF">*-- 아무것도 선택 안 한 경우</font>
  IF lt_roid IS INITIAL.
    MESSAGE s000 WITH '삭제할 행을 선택하세요.' DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

<font color ="#0000FF">*--사용자에게 검증 진행할거냐고 확인받기</font>
  PERFORM confirm_delete  CHANGING gv_answer.
  CHECK gv_answer EQ '1'.

<font color ="#0000FF">*-- 역순 정렬: 아래쪽 인덱스부터 삭제해야 index 꼬임 방지</font>
  SORT lt_roid BY row_id DESCENDING.

<font color ="#0000FF">*-- 행 삭제 처리</font>
  LOOP AT lt_roid INTO ls_roid.

    " 선택한 인덱스 기준으로 데이터 읽기
    READ TABLE gt_iv INTO gs_iv INDEX ls_roid-row_id.
    IF sy-subrc &lt;&gt; 0.
      CONTINUE.
    ENDIF.

    " 업로드된 데이터인지 확인 (sort_key = 'A')
    IF gs_iv-sort_key &lt;&gt; 'A'.
      lv_skip_cnt = lv_skip_cnt + 1.
      CONTINUE.
    ENDIF.

<font color ="#0000FF">*    " 삭제 백업 (옵션)</font>
<font color ="#0000FF">*    MOVE-CORRESPONDING gs_body TO gs_delt.</font>
<font color ="#0000FF">*    APPEND gs_delt TO gt_delt.</font>
<font color ="#0000FF">*    CLEAR gs_delt.</font>

    " 실제 삭제
    DELETE gt_iv INDEX ls_roid-row_id.
    lv_deleted_cnt = lv_deleted_cnt + 1.

  ENDLOOP.

<font color ="#0000FF">*-- ALV 리프레시</font>
  PERFORM refresh_table.

<font color ="#0000FF">*-- 결과 메시지 출력</font>
  IF lv_deleted_cnt &gt; 0 AND lv_skip_cnt = 0.
    MESSAGE |총 { lv_deleted_cnt }건의 업로드 데이터를 삭제했습니다.| TYPE 'S'.

  ELSEIF lv_deleted_cnt &gt; 0 AND lv_skip_cnt &gt; 0.
    MESSAGE |업로드된 { lv_deleted_cnt }건은 삭제되었고, { lv_skip_cnt }건은 삭제할 수 없습니다.| TYPE 'S'.

  ELSEIF lv_deleted_cnt = 0 AND lv_skip_cnt &gt; 0.
    MESSAGE |선택한 항목은 업로드된 송장 항목이 아니므로 삭제할 수 없습니다.| TYPE 'I'.
  ENDIF.

  " 강제 PBO 메소드
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form confirm_chck</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- GV_ANSWER</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM confirm_chck  CHANGING pv_answer.


  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = '송장 검증 진행 확인'
      text_question         = '선택한 송장을 검증하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer. " Yes

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_ebeln</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- LV_EBELN</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_ebeln  CHANGING pv_result TYPE zc102mmt0011-ebeln.

  DATA: gv_number    TYPE n LENGTH 10,
        gv_prefix(3),
        gv_full_code TYPE string,
        gv_range_nr  TYPE inri-nrrangenr,
        gv_quantity  TYPE inri-quantity.

  DATA: ls_nriv TYPE nriv.

  gv_prefix = 'PO'.   " prefix
  gv_range_nr = '01'. " 번호
  gv_quantity = 1.    " 증가량

<font color ="#0000FF">**********************************************************************</font>
<font color ="#0000FF">* 순번 호출</font>
<font color ="#0000FF">**********************************************************************</font>
  CALL METHOD zclc102cm_auto_sequence=&gt;get_next_value
    EXPORTING
      pv_range_nr = gv_range_nr
      pv_prefix   = gv_prefix
      pv_quantity = gv_quantity
    IMPORTING
      pv_result   = gv_full_code.

  pv_result = CONV zc102mmt0011-ebeln( gv_full_code ). " String -&gt; char

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_po</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      &lt;-- LV_EBELN</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_po USING pv_ebeln TYPE zc102mmt0011-ebeln.

  DATA: ls_save   TYPE zc102mmt0011,
        lv_rgtime TYPE zc102mmt0004-rgtime,
        lv_gredat TYPE sy-datum.
  CLEAR : gs_ldtime, gs_po.

  READ TABLE gt_po INTO gs_po WITH KEY ebeln = gs_check-ebeln.
  READ TABLE gt_ldtime INTO gs_ldtime WITH KEY matnr = gs_check-matnr.

<font color ="#0000FF">*-- 입고예정일 계산: 구매오더일자 + 배송리드타임.</font>
  lv_gredat = sy-datum + lv_rgtime.


<font color ="#0000FF">*--부족 수량 계산</font>
  IF gs_check-odrqu &gt; gs_check-grqty.

    " 신규 구매오더 데이터 생성 처리 (ls_save 세팅 등)
    MOVE-CORRESPONDING gs_check TO ls_save.
    ls_save-ebeln = pv_ebeln.                         " 새 구매오더번호
    ls_save-menge = gs_check-odrqu - gs_check-grqty.  " 부족수량만큼
    ls_save-podat   = sy-datum.                       " 구매오더 일자
    ls_save-partner = gs_check-partner.               " 거래처 번호
    ls_save-prno    = gs_check-vbeln_bil.             " 참조번호 - 송장번호를 구매요청 번호에 넣어줌
    ls_save-matnr   = gs_check-matnr.                 " 자재 번호
    ls_save-stprs   = 0.                              " 단가
    ls_save-waers   = gs_check-waers.                 " 통화키
    ls_save-meins   = gs_check-meins.                 " 단위
    ls_save-stlno   = gs_po-stlno.                    " 창고 번호
    ls_save-empno   = zc102hrt0002-empno.             " 사원번호
    ls_save-dzeit   = gs_ldtime-rgtime.
    ls_save-gredat  = lv_gredat.                      " 입고예정일자
    ls_save-reorder  = 'X'.                           " 재구매오더 표시
    ls_save-erdat = sy-datum.
    ls_save-erzet = sy-uzeit.
    ls_save-ernam = sy-uname.
    " 저장 테이블에 추가
    APPEND ls_save TO gt_save.

  ENDIF.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_belnr</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_belnr .

<font color ="#0000FF">*-- 전표생성</font>
  call function <a href ="zfm_cl102_fi_05/zfm_cl102_fi_05.html">'ZFM_CL102_FI_05'</a>
    EXPORTING
      iv_wrbtr   = gs_check-wrbtr
      iv_ebeln   = gs_check-ebeln
      iv_partner = gs_check-partner
      iv_duedt   = sy-datum
      iv_waers   = gs_check-waers
    IMPORTING
      ev_num     = gv_belnr.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_icon_new_reorder</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_icon_new_reorder .

  LOOP AT gt_check INTO gs_check.

    IF gs_check-reorder = 'X'.
      gs_check-reorder_icon = icon_okay.
      MODIFY gt_check FROM gs_check TRANSPORTING reorder_icon.
    ENDIF.

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_icon_reorder</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_icon_reorder .


  DATA: lv_tabix TYPE sy-tabix,
        lt_color TYPE lvc_t_scol.


  LOOP AT gt_check INTO gs_check.

    lv_tabix = sy-tabix.

    gs_check-reorder_icon = icon_okay.

    MODIFY gt_check FROM gs_check INDEX lv_tabix TRANSPORTING reorder_icon .

  ENDLOOP.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_icon</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_icon .
  CLEAR : gs_check, gv_tabix.

  LOOP AT gt_check INTO gs_check.
    gv_tabix = sy-tabix.
    IF gs_check-reorder = 'X'.
      gs_check-reorder_icon = icon_okay.
    ENDIF.

    MODIFY gt_check FROM gs_check INDEX gv_tabix
                                  TRANSPORTING reorder_icon.
  ENDLOOP.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form count_now_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM count_now_data .

  CLEAR: gv_cnt1, gv_cnt2, gv_cnt3, gv_cnt4.

  " 전체 행 수
  gv_cnt3 = lines( gt_iv2 ).
  gv_cnt4 = lines( gt_check ).

  " gt_iv 상태별 건수 (qcheck 기준으로 분리)
  LOOP AT gt_iv INTO DATA(gs_iv).
    IF gs_iv-qcheck = 'N'.
      ADD 1 TO gv_cnt1.      " 미검수 / 송장 업로드 되는 것도.
    ELSEIF gs_iv-qcheck = 'Y'.
      ADD 1 TO gv_cnt2.      " 검수완료
    ENDIF.
  ENDLOOP.

ENDFORM.
</pre>
<hr>
<font size="2" face = "Sans Serif">Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 758
</font>
</body>
</html>
