*&---------------------------------------------------------------------*
*& Form set_stlno
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_stlno .

  IF zc102mmt0008-werks IS NOT INITIAL.

    CASE 'X'.
      WHEN gv_rcheck.
        gv_stltype = 'R'. " 원자재
      WHEN gv_pcheck.
        gv_stltype = 'P'. " 완제품
      WHEN gv_ccheck.
        gv_stltype = 'C'. " 포장재
    ENDCASE.

    " 창고번호를 조회해 자동 세팅
    SELECT SINGLE stlno INTO gv_stlno
      FROM zc102mmt0008 " 창고 마스터
      WHERE werks = zc102mmt0008-werks
        AND stltype = gv_stltype.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_screen .

  IF go_container IS NOT BOUND.

    CLEAR : gs_fcat, gt_fcat.
    PERFORM set_catalog USING : 'X' 'STATUS'  'ICON'         'C' ' ', " 유통기한 상태
                                'X' 'BATNO'   'ZC102MMT0005' 'C' ' ', " 배치번호
                                'X' 'MATNR'   'ZC102MMT0005' 'C' ' ', " 자재번호
                                ' ' 'MAKTX'   'ZC102MMT0004' ' ' ' ', " 자재명
                                ' ' 'LABST'   'ZC102MMT0005' ' ' ' ', " 가용재고
                                ' ' 'MEINS'   'ZC102MMT0005' 'C' 'X', " 수량 단위
                                ' ' 'LFDAT'   'ZC102MMT0005' 'C' ' ', " 입고일
                                ' ' 'VFDAT'   'ZC102MMT0005' 'C' ' ', " 유통기한
                                ' ' 'LEDAY'   '            ' ' ' ' ',
                                ' ' 'CHECK'   '            ' 'C' ' '.

    gs_variant-report = sy-repid.
    gs_variant-handle = 'ALV1'.

    PERFORM exclude_toolbar.
    PERFORM create_object.
    PERFORM set_display_screen. " set_layout + set_display
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_init_screen_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_init_screen_value .

  PERFORM get_werks_data.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_catalog USING pv_key
                        pv_field
                        pv_table
                        pv_just
                        pv_emph.

  gs_fcat-key       = pv_key.
  gs_fcat-fieldname = pv_field.
  gs_fcat-ref_table = pv_table.
  gs_fcat-just      = pv_just.
  gs_fcat-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'LABST'.
      gs_fcat-qfieldname = 'MEINS'.
*      gs_fcat-do_sum = abap_true.
    WHEN 'MEINS'.
      gs_fcat-coltext    = '단위'.
    WHEN 'LFDAT'.
      gs_fcat-coltext    = '입고일'.
    WHEN 'STATUS'.
      gs_fcat-coltext = '상태'.
    WHEN 'LEDAY'.
      gs_fcat-coltext = '남은 기한'.
    WHEN 'CHECK'.
      IF gv_stltype = 'P'.
        gs_fcat-no_out = 'X'.
      ELSE.
        gs_fcat-coltext = '사료용 자재'.
        gs_fcat-checkbox = 'X'.
        gs_fcat-edit  = 'X'.
      ENDIF.
  ENDCASE.

  APPEND gs_fcat TO gt_fcat.
  CLEAR gs_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_layout .

  DATA : lv_stlname(25).

*-- 창고 지역 GET
  PERFORM get_werks_text.

  lv_stlname = |{ gv_werks }{ '창고' } { '자재 재고' } |.

  gs_layout-zebra      = abap_true.
  gs_layout-cwidth_opt = 'A'.
  gs_layout-sel_mode   = 'D'.
  gs_layout-grid_title = lv_stlname.
  gs_layout-no_totline = abap_true.
  gs_layout-stylefname = 'CELL_TAB'.

*-- Set Sort
  CLEAR : gs_sort, gt_sort.
  gs_sort-spos       = 1.          " 정렬의 우선순위
  gs_sort-fieldname  = 'MATNR'.    " 얘를 기준으로 정
  gs_sort-up         = abap_true.  " 오름차순 (생략시 디폴트 UP)
  gs_sort-subtot     = abap_true.  " 항목별 합

  APPEND gs_sort TO gt_sort.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_object
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_object .

  CREATE OBJECT go_container
    EXPORTING
      container_name = 'MAIN_CONT'.

  CREATE OBJECT go_alv_grid
    EXPORTING
      i_parent = go_container.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form exclude_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM exclude_toolbar .

  DATA : ls_ui_functions TYPE ui_func.

  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_undo.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_cut.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_delete_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_insert_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_append_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_refresh.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_auf.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_average.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_print.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_graph.
  APPEND ls_ui_functions TO gt_ui_functions.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_table .

  DATA : ls_stable TYPE lvc_s_stbl.

  ls_stable-row = abap_true.
  ls_stable-col = abap_true.

  CALL METHOD go_alv_grid->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_matno
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM search_matno .

*-- 자재번호 range 초기화
  _init gr_matnr.
  _init gr_lfdat.

*-- 입력된 값 range에 set
  IF zc102mmt0005-matnr IS NOT INITIAL.
    gr_matnr-sign = 'I'.
    gr_matnr-option = 'EQ'.
    gr_matnr-low = zc102mmt0005-matnr.
    APPEND gr_matnr.
  ENDIF.

  IF gv_date_fr IS NOT INITIAL AND gv_valid_lfdat = abap_true .
    gr_lfdat-sign = 'I'.
    gr_lfdat-option = 'EQ'.
    gr_lfdat-low = gv_date_fr.
    gr_lfdat-high = gv_date_to.
    APPEND gr_lfdat.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_status
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_status .

  DATA: lv_days_left TYPE i,
        lv_tabix     TYPE sy-tabix.

  DATA : ls_style    TYPE lvc_s_styl.

  CLEAR : gv_good_days, gv_soso_days, gv_bad_days.

  LOOP AT gt_storage INTO gs_storage.

    lv_tabix = sy-tabix.

    CLEAR lv_days_left.
    lv_days_left = gs_storage-vfdat - sy-datum.

*-- 유통기한 남은 날짜 표시
    gs_storage-leday = lv_days_left.

*-- lv_threshold 값에 따라 상태 표시
    IF lv_days_left <= 0.
      gs_storage-status = icon_led_red.
      gv_bad_days += 1.
    ELSEIF lv_days_left <= gv_threshold.
      gs_storage-status = icon_led_yellow.
      gv_soso_days += 1.
    ELSE.
      gs_storage-status = icon_led_green.
      gv_good_days += 1.
    ENDIF.

    " 전체 비활성화
    gs_storage-check = ' '.          " 보이긴 하지만 비활성화
    CLEAR ls_style.
    ls_style-fieldname = 'CHECK'.
    ls_style-style     = cl_gui_alv_grid=>mc_style_disabled.
    INSERT ls_style INTO TABLE gs_storage-cell_tab.

*-- 원자재 : 사료용 자재만 체크 박스 활성화
    IF lv_days_left <= gv_threshold AND lv_days_left > 0. " 유통기한 임박
      CASE gs_storage-matnr.
          " 순두부 양파 대파 콩고기 닭고기일 때만 체크박스 활성화
        WHEN 'M0012' OR 'M0013' OR 'M0014' OR 'M0015' OR 'M0020'.
          gs_storage-check = 'X'.
      ENDCASE.
    ENDIF.

    MODIFY gt_storage FROM gs_storage INDEX lv_tabix
                                      TRANSPORTING status leday check cell_tab.

    CLEAR : gs_storage.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_edit_toolbar1
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_OBJECT
*&      --> E_INTERACTIVE
*&---------------------------------------------------------------------*
FORM handle_edit_toolbar USING po_object TYPE REF TO cl_alv_event_toolbar_set
                               pv_interactive.

  IF gv_filter_on = abap_true.
*-- 폐기리스트 버튼
    CLEAR gs_button.
    gs_button-function = 'LIST'.
    gs_button-icon     = icon_led_red.
    gs_button-quickinfo = '폐기리스트'.
    gs_button-text = TEXT-b01.
    APPEND gs_button TO po_object->mt_toolbar.
  ELSE.
*-- 폐기리스트 해제 버튼
    CLEAR gs_button.
    gs_button-function = 'ALLV'.
    gs_button-text     = TEXT-b02.
    gs_button-icon     = icon_cancel.
    APPEND gs_button TO po_object->mt_toolbar.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_user_command
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_UCOMM
*&---------------------------------------------------------------------*
FORM handle_user_command USING pv_ucomm.

  CASE pv_ucomm.
    WHEN 'LIST'.            " 폐기리스트 버튼
      PERFORM list_clicked.
    WHEN 'ALLV'.            " 폐기리스트 해제 버튼
      PERFORM allv_clicked.
    WHEN 'SETA'.            " 전체 유통기한 처리
      PERFORM set_all_clicked.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_werks_text
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_werks_text .

  SELECT SINGLE stlname
    INTO gv_werks
    FROM zc102mmt0008
    WHERE stlno EQ gv_stlno
      AND stltype EQ gv_stltype.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form dispose_item
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM dispose_item .

  DATA : lt_backup LIKE TABLE OF gs_storage.

  CLEAR : gt_select, gs_select, gs_storage.

*-- 사용자가 선택한 행 정보를 받아온다
  CALL METHOD go_alv_grid->get_selected_rows
    IMPORTING
      et_row_no = gt_select.

*-- 행을 선택하지 않고 품질검사 버튼 선택시 알림창
  IF gt_select IS INITIAL.
    MESSAGE s000 WITH TEXT-e05 DISPLAY LIKE 'E'.
    EXIT. " 서브루틴 빠져나감
  ENDIF.

*-- 가져올 행에 대해 품질검사용 인터널 테이블에 담는다
  LOOP AT gt_select INTO gs_select.

    READ TABLE gt_storage INTO gs_storage INDEX gs_select-row_id.

    APPEND gs_storage TO lt_backup.           " 인터널 테이블에 검수할 항목 적재

  ENDLOOP.

  MOVE-CORRESPONDING lt_backup TO gt_dispose.

*-- pop-up 스크린 style 설정
  PERFORM set_pop_screen.

  CALL SCREEN 110 STARTING AT 5 5.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_pop_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_pop_screen .

  DATA : lv_tabix TYPE sy-tabix,
         ls_style TYPE lvc_s_styl.

  LOOP AT gt_dispose INTO gs_dispose.

    lv_tabix = sy-tabix.

    CLEAR : ls_style, gs_dispose-cell_tab.

*-- 스타일
    ls_style-style     = cl_gui_alv_grid=>mc_style_disabled.
    INSERT ls_style INTO TABLE gs_dispose-cell_tab.

    CLEAR ls_style.
    ls_style-fieldname = 'REASOTEXT'.
    ls_style-style     = cl_gui_alv_grid=>mc_style_enabled. " 편집 모드
    INSERT ls_style INTO TABLE gs_dispose-cell_tab.

    IF gs_dispose-reasotext EQ '유통기한 초과'. " 유통기한 폐기시
      gs_dispose-disme = gs_dispose-labst. " 전체 수량 입력
      MODIFY gt_dispose FROM gs_dispose INDEX lv_tabix TRANSPORTING disme.
      CLEAR ls_style.
      ls_style-fieldname = 'DISME'.
      ls_style-style     = cl_gui_alv_grid=>mc_style_disabled. " 편집모드
      INSERT ls_style INTO TABLE gs_dispose-cell_tab.
    ELSE.
      CLEAR ls_style.
      ls_style-fieldname = 'DISME'.
      ls_style-style     = cl_gui_alv_grid=>mc_style_enabled. " 편집모드
      INSERT ls_style INTO TABLE gs_dispose-cell_tab.
    ENDIF.

    MODIFY gt_dispose FROM gs_dispose INDEX lv_tabix TRANSPORTING cell_tab.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_threshold
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_threshold .

  CASE gv_stltype.
*-- 원자재 창고 : red 당일 / yellow 3일 이하 / green 4일 이상
    WHEN 'R'.
      gv_threshold = 3.
    WHEN 'P'.
*-- 신선 완제품 창고 : red 당일 / yellow 3일 이하 / green 4일 이상
      IF zc102mmt0008-werks EQ 'P1000'. " 강원 PLANT
        gv_threshold = 3.
      ELSE.
*-- 가공 완제품 창고 : red 당일 / yellow 3주 이하(21일) / green 3주 초과(22일)
        gv_threshold = 21.
      ENDIF.
    WHEN 'C'.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Module INIT_POP_SCREEN OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE init_pop_screen OUTPUT.

  PERFORM init_screen_value.
  PERFORM display_screen_110.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Form save_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save_data .
***********************************************************************
* SAVE 로직 처리
* 1. 폐기 테이블로 INSERT
* 2. 원자재 창고 테이블에서 MODIFY / DELETE
* 3. 자재 이동 문서 - 폐기문서 생성
* 4. 자재 관리 테이블 가용/전체 재고 감소
***********************************************************************
  DATA : lv_answer, " 저장시 사용자 동의
        lv_tabix TYPE sy-tabix.

  PERFORM get_mat_info.
*-- 변경 데이터 인터널 테이블에 반영
  CALL METHOD go_pop_grid->check_changed_data.

*-- 반품 수량, 사유에 대한 유효값인지 체크
  PERFORM check_valid_data.

  PERFORM check_confirm CHANGING lv_answer.
  IF lv_answer EQ '1'.

    LOOP AT gt_dispose INTO gs_dispose.

      lv_tabix = sy-tabix.

*-- 반품사유 TEXT를 키값으로
      IF gs_dispose-reasotext IS NOT INITIAL.
        READ TABLE gt_ddtext INTO gs_ddtext WITH KEY ddtext = gs_dispose-reasotext.
        IF sy-subrc EQ 0.
          gs_dispose-reaso = gs_ddtext-domvalue_l.
          MODIFY gt_dispose FROM gs_dispose INDEX lv_tabix TRANSPORTING reaso.
        ENDIF.
      ENDIF.

      IF gs_dispose-disme <> 0.
*-- 1. 폐기 인터널 테이블로 append
        PERFORM set_dispose.
      ENDIF.

*-- 2. 원자재 창고 테이블 Update
      gv_menge = gs_dispose-labst - gs_dispose-disme.
      PERFORM update_storage.

*-- 3. 자재 이동 문서 테이블 INSERT
      PERFORM set_md_dis.

*-- 4. 자재 관리 테이블 UPDATE
      READ TABLE gt_mat_info INTO gs_mat_info WITH KEY matnr = gs_dispose-matnr.

      IF sy-subrc EQ 0.
        gs_mat_info-labst = ( gs_mat_info-labst - gs_dispose-disme ).
        gs_mat_info-rabst = ( gs_mat_info-rabst - gs_dispose-disme ).
        gs_mat_info-aedat = sy-datum.
        gs_mat_info-aenam = sy-uname.
        gs_mat_info-aezet = sy-uzeit.

        MODIFY gt_mat_info FROM gs_mat_info INDEX lv_tabix
                           TRANSPORTING labst rabst aedat aenam aezet.
      ENDIF.

    ENDLOOP.

*-- 4-1. 자재관리 테이블 DB반영
    MODIFY zc102mmt0001 FROM TABLE gt_mat_info .
*-- 1-1. 폐기 테이블 DB반영

    INSERT zc102mmt0018 FROM TABLE gt_return ACCEPTING DUPLICATE KEYS.

    IF sy-subrc EQ 0.
      MESSAGE s000 WITH '폐기 처리가 완료되었습니다.'.
      COMMIT WORK.
    ELSE.
      ROLLBACK WORK.
      MESSAGE i000 WITH TEXT-e03.
    ENDIF.

*-- REFRESH
    PERFORM get_stl_data.           " 창고 자재리스트 다시 GET
    PERFORM set_status.           " 상태 다시 표시
    IF gv_filter_on = abap_false.
      PERFORM list_clicked.
    ENDIF.
    PERFORM refresh_table.          " ALV 업데이트
    CLEAR : gt_dispose, gs_dispose. " 폐기 인터널 테이블 초기화

    LEAVE TO SCREEN 0.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form init_screen_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM init_screen_value .

*-- 폐기 관리자, 날짜 자동 세팅
  gv_id   = sy-uname.
  WRITE sy-datum TO gv_date.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_screen_110
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_screen_110 .

  DATA : ls_variant TYPE disvariant,
         ls_layout  TYPE lvc_s_layo.

  IF go_pop_cont IS NOT BOUND.

    CLEAR : gt_pop_fcat, gs_pop_fcat.

*-- 폐기 POP-UP 리스트
    PERFORM set_pop_fcat USING : 'X' 'BATNO'     'ZC102MMT0005' 'C' ' ',
                                 'X' 'MATNR'     'ZC102MMT0005' 'C' ' ',
                                 ' ' 'MAKTX'     'ZC102MMT0004' ' ' ' ',
                                 ' ' 'LABST'     'ZC102MMT0005' ' ' ' ',
                                 ' ' 'DISME'     'ZC102MMT0018' ' ' ' ',
                                 ' ' 'MEINS'     'ZC102MMT0005' 'C' 'X',
                                 ' ' 'LFDAT'     'ZC102MMT0005' 'C' ' ',
                                 ' ' 'VFDAT'     'ZC102MMT0005' 'C' ' ',
                                 ' ' 'REASOTEXT'  '            ' ' ' ' '.

    PERFORM create_popup_object.
    PERFORM exclude_toolbar.
    PERFORM set_alv_listbox.

*-- POP-UP ls_variant 설정
    ls_variant-report = sy-repid.
    ls_variant-handle = 'POP1'.

*-- POP-UP ls_layout 설정
    ls_layout-zebra      = abap_true.
    ls_layout-cwidth_opt = 'A'.
    ls_layout-sel_mode   = 'D'.
    ls_layout-stylefname = 'CELL_TAB'.

    SET HANDLER : lcl_event_handler=>modify_value       FOR go_pop_grid,
                  lcl_event_handler=>handle_toolbar_pop FOR go_pop_grid,
                  lcl_event_handler=>user_command       FOR go_pop_grid.

    CALL METHOD go_pop_grid->set_table_for_first_display
      EXPORTING
        is_variant           = ls_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = ls_layout
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_dispose
        it_fieldcatalog      = gt_pop_fcat.

  ENDIF.

  PERFORM register_event.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_pop_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_pop_fcat USING pv_key pv_field pv_table pv_just pv_emph.

  gs_pop_fcat-key        = pv_key.
  gs_pop_fcat-fieldname  = pv_field.
  gs_pop_fcat-ref_table  = pv_table.
  gs_pop_fcat-just       = pv_just.
  gs_pop_fcat-emphasize  = pv_emph.

  CASE pv_field.
    WHEN 'LABST'.
      gs_pop_fcat-qfieldname = 'MEINS'.
    WHEN 'DISME'.
      gs_pop_fcat-qfieldname = 'MEINS'.
      gs_pop_fcat-coltext    = '폐기 수량'.
    WHEN 'MEINS'.
      gs_pop_fcat-coltext    = '단위'.
    WHEN 'REASOTEXT'.
      gs_pop_fcat-coltext    = '반품 사유'.
      gs_pop_fcat-drdn_field  = 'DROP_DOWN_HANDLE'.
      gs_pop_fcat-drdn_hndl   = '1'.
      gs_pop_fcat-drdn_alias  = 'X'.
      gs_pop_fcat-outputlen   = 20.
      gs_pop_fcat-just        = 'C'.
    WHEN 'LFDAT'.
      gs_pop_fcat-coltext    = '입고일'.
    WHEN 'VFDAT'.
      gs_pop_fcat-coltext    = '유통기한'.
  ENDCASE.

  APPEND gs_pop_fcat TO gt_pop_fcat.
  CLEAR gs_pop_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_popup_object
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_popup_object .

  CREATE OBJECT go_pop_cont
    EXPORTING
      container_name = 'POP_CONT'.

  CREATE OBJECT go_pop_grid
    EXPORTING
      i_parent = go_pop_cont.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form register_event
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM register_event .

  CALL METHOD go_pop_grid->set_ready_for_input
    EXPORTING
      i_ready_for_input = 1. " 1 : EDIT ON, 0 : EDIT OFF

  CALL METHOD go_pop_grid->register_edit_event
    EXPORTING
      i_event_id = cl_gui_alv_grid=>mc_evt_modified.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_modify_values
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_MODIFIED
*&      --> ET_GOOD_CELLS
*&---------------------------------------------------------------------*
FORM handle_modify_values USING pv_modified
                                 pt_good_cells.

  DATA : ls_good_cells TYPE lvc_s_modi.

  CHECK pv_modified IS NOT INITIAL.
  LOOP AT pt_good_cells INTO ls_good_cells.

    CLEAR gs_dispose.
    READ TABLE gt_dispose INTO gs_dispose INDEX ls_good_cells-row_id.

    CASE ls_good_cells-fieldname.
      WHEN 'DISME'.
        IF gs_dispose-disme > gs_dispose-labst. " 폐기수량 =< 현재수량
          MESSAGE i034 DISPLAY LIKE 'W'.
          gs_dispose-disme = 0.
          MODIFY gt_dispose FROM gs_dispose INDEX ls_good_cells-row_id.
          PERFORM refresh_pop_table.
          RETURN.
        ENDIF.
      WHEN 'REASOTEXT'.
        IF gs_dispose-disme EQ 0.    " 반품 수량이 0인데 반품 사유 입력
          MESSAGE i000 WITH TEXT-e06 DISPLAY LIKE 'W'.
          gs_dispose-reasotext = ' '.
          MODIFY gt_dispose FROM gs_dispose INDEX ls_good_cells-row_id
                                            TRANSPORTING reasotext .
          PERFORM refresh_pop_table.
          RETURN.
        ENDIF.
        IF gs_dispose-reasotext = '유통기한 초과' " 반품사유가 초과인데 전량 입력 아닐때
           AND gs_dispose-disme < gs_dispose-labst
           AND  gs_dispose-vfdat =< sy-datum.
          MESSAGE i049 DISPLAY LIKE 'W'.
          PERFORM set_pop_screen.
          PERFORM refresh_pop_table.
          RETURN.
        ENDIF.
        IF gs_dispose-reasotext = '유통기한 초과' AND
           gs_dispose-vfdat > sy-datum.
          MESSAGE i000 WITH '유통기한이 지나지 않은 자재입니다. 다른 사유를 선택해주세요.' DISPLAY LIKE 'W'.
          gs_dispose-reasotext = ' '.
          MODIFY gt_dispose FROM gs_dispose INDEX ls_good_cells-row_id
                                            TRANSPORTING reasotext .
          PERFORM refresh_pop_table.
          RETURN.
        ENDIF.
    ENDCASE.

  ENDLOOP.

  PERFORM set_pop_screen.
  PERFORM refresh_pop_table.
  PERFORM auto_enter.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_pop_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_pop_table .

  DATA : ls_stable TYPE lvc_s_stbl.

  ls_stable-row = abap_true.
  ls_stable-col = abap_true.

  CALL METHOD go_pop_grid->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_valid_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_valid_data .

  DATA : lv_reaso(30).

  lv_reaso = '폐기 수량에 대한 폐기 사유를 입력해주세요'.

  LOOP AT gt_dispose INTO gs_dispose.

*-- 반품 수량에 대해 반품 사유를 입력했는지 확인
    IF gs_dispose-disme > 0 AND gs_dispose-reasotext IS INITIAL.
      MESSAGE e000 WITH lv_reaso DISPLAY LIKE 'I'.
*-- 반품 수량이 0인데 반품 사유가 입력되었을 때
    ELSEIF gs_dispose-disme = 0 AND gs_dispose-reasotext IS NOT INITIAL.
      MESSAGE e000 WITH TEXT-e04 DISPLAY LIKE 'I'.
    ENDIF.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_confirm
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- LV_ANSWER
*&---------------------------------------------------------------------*
FORM check_confirm CHANGING pv_answer.

  CALL FUNCTION 'ZFM_CL102_CM_POP_UP'
    EXPORTING
      iv_titlebar = '처리 결과 저장'
      iv_question = '처리 결과를 저장하시겠습니까?'
    IMPORTING
      ev_answer   = pv_answer.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_dispose
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_dispose .
  PERFORM get_return_no.

  gs_return-disno   = gv_retno.      " 폐기테이블 번호
  gs_return-matnr   = gs_dispose-matnr. " 자재번호
  gs_return-batno   = gs_dispose-batno. " 배치번호
  gs_return-disda   = sy-datum.         " 반품등록일
  gs_return-distype = '03'.             " 유형 - 반품
  gs_return-disme   = gs_dispose-disme. " 반품 수량
  gs_return-meins   = gs_dispose-meins. " 수량 단위
  gs_return-reaso   = gs_dispose-reaso. " 반품 사유
  gs_return-refno   = gs_dispose-stlno. " 참조번호 - 창고번호
  " Time stamp
  gs_return-erdat = sy-datum.
  gs_return-ernam = sy-uname.
  gs_return-erzet = sy-uzeit.

  APPEND gs_return TO gt_return.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_storage
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_storage.

  CASE gv_stltype.
*-- 원자재인 경우 zc102mmt0005
    WHEN 'R'.
      PERFORM update_0005.
    WHEN 'P'.
*-- 완제품인 경우, 강원 plant는 신선완제품 창고, 나머지 plant는 가공 완제품 창고 update
      IF zc102mmt0008-werks EQ 'P1000'. " 강원 PLANT
        PERFORM update_0006.
      ELSE.
        PERFORM update_0003.
      ENDIF.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_mat_info
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_mat_info .

  SELECT * FROM zc102mmt0001
    FOR ALL ENTRIES IN @gt_dispose
    WHERE matnr = @gt_dispose-matnr
      AND stlno = @gv_stlno
   INTO TABLE @gt_mat_info.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_stl_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_stl_data .

  DATA : lv_lines TYPE sy-dbcnt.

  CASE gv_stltype.

*-- 원자재인 경우 모두 select from zc102mmt0005 with 플랜트, 창고번호
    WHEN 'R'.
      SELECT stlno stltype werks matnr batno
             labst meins lfdat vfdat
        INTO CORRESPONDING FIELDS OF TABLE gt_storage
        FROM zc102mmt0005
        WHERE werks = zc102mmt0008-werks
          AND stlno = gv_stlno
          AND matnr IN gr_matnr
          AND lfdat IN gr_lfdat
        ORDER BY matnr batno.
    WHEN 'P'.
*-- 완제품인 경우, 강원 plant는 신선완제품 창고, 나머지 plant는 가공 완제품 창고
      IF zc102mmt0008-werks EQ 'P1000'. " 강원 PLANT
        SELECT stlno stltype werks matnr batno
              labst meins lfdat vfdat
         INTO CORRESPONDING FIELDS OF TABLE gt_storage
         FROM zc102mmt0006
        WHERE werks = zc102mmt0008-werks
          AND stlno = gv_stlno
           AND matnr IN gr_matnr
          AND lfdat IN gr_lfdat
      ORDER BY matnr batno.
      ELSE.
        SELECT stlno stltype werks matnr batno
              labst meins lfdat vfdat
         INTO CORRESPONDING FIELDS OF TABLE gt_storage
         FROM zc102mmt0003
        WHERE werks = zc102mmt0008-werks
          AND stlno = gv_stlno
           AND matnr IN gr_matnr
           AND lfdat IN gr_lfdat
           ORDER BY matnr batno.
      ENDIF.
*-- 포장 자재인 경우 배치번호, 유통기한 x
    WHEN 'C'.
      SELECT stlno stltype werks matnr labst meins lfdat
        INTO CORRESPONDING FIELDS OF TABLE gt_storage
        FROM zc102mmt0007
      WHERE werks = zc102mmt0008-werks
        AND stlno = gv_stlno
        AND matnr IN gr_matnr
        AND lfdat IN gr_lfdat
        ORDER BY matnr.
  ENDCASE.

*-- SET MAKTX(자재이름)
  PERFORM set_maktx.

  lv_lines = lines( gt_storage ).
  IF gt_storage IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'I'.
  ELSE.
    MESSAGE s010 WITH lv_lines.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen .

*-- 창고마다 status 기준 다르게 표시
  gv_left_good = gv_threshold + 1.
  gv_left_soso = gv_threshold.
  gv_left_bad = 0.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form release_item
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM inventory_item .

  CLEAR : gt_select, gs_select.

*-- 사용자가 선택한 행 정보를 받아온다
  CALL METHOD go_alv_grid->get_selected_rows
    IMPORTING
      et_row_no = gt_select.

  " 행을 선택하지 않고 버튼 선택시 알림창
  IF gt_select IS INITIAL.
    MESSAGE s000 WITH TEXT-e01 DISPLAY LIKE 'E'.
    EXIT.
    " 재고실사 - 개별 항목 처리, 한 줄 이상 선택되면 알림창
  ELSEIF lines( gt_select ) > 1.
    MESSAGE s050 WITH TEXT-e01 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

*-- 가져온 행을 wa에 담는다.
  READ TABLE gt_select INTO gs_select INDEX 1.
  READ TABLE gt_storage INTO gs_storage INDEX gs_select-row_id.
  MOVE-CORRESPONDING gs_storage TO gs_inventory.

  CALL SCREEN 120 STARTING AT 5 15.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form init_screen_120
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM init_screen_120 .

  gv_werks = gv_werks.
  gv_matnr = gs_inventory-matnr.
  gv_maktx = gs_storage-maktx.
  gv_stlno = gs_inventory-stlno.
  gv_batno = gs_inventory-batno.
  gv_labst = gs_inventory-labst.

  IF gv_real IS INITIAL.
    gv_change = 0.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form apply_inventory
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM apply_inventory.
**********************************************************************
* 1. 원자재 테이블 UPDATE
* 2. 자재 관리 테이블 UPDATE
* 3. 자재 문서 생성 - 조정 출고 or 조정 입고
**********************************************************************
  DATA : lv_answer. " 저장시 사용자 동의

*-- 실사 수량이 재고 수량과 동일할 경우 알림
  PERFORM check_valid_labst.

*-- 사용자가 YES 시 저장 로직 실행
  PERFORM check_confirm CHANGING lv_answer.
  CHECK lv_answer EQ '1'.

*-- 원자재 테이블 update - 만약 전량이면 delete
  PERFORM update_storage_by_inventory.

*-- 자재 관리 테이블 update
  gv_change = gv_real - gv_labst. " 엔터 안 친경우 계산
  UPDATE zc102mmt0001
    SET labst = labst + gv_change
        rabst = rabst + gv_change
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
    WHERE stlno   = gv_stlno
      AND stltype = gv_stltype
      AND werks   = gs_inventory-werks
      AND matnr   = gs_inventory-matnr.

*-- 자재 문서 생성
  IF gv_change > 0.      " gv_change가 + -> 입고
    PERFORM set_md_in.
  ELSEIF gv_change < 0 . " gv_change가 - -> 출고
    gv_change *= -1.     " 음수값 양수값으로 변환
    PERFORM set_md_out.
  ENDIF.

  IF sy-subrc EQ 0.
    MESSAGE s000 WITH TEXT-s01.
    COMMIT WORK.

    PERFORM get_stl_data.
    PERFORM set_status.   " 상태 다시 표시
    IF gv_filter_on = abap_false.
      PERFORM list_clicked.
    ENDIF.
    PERFORM refresh_table.
    CLEAR : gv_real, gv_change.

  ELSE.
    ROLLBACK WORK.
  ENDIF.

  LEAVE TO SCREEN 0.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_valid_labst
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_valid_labst .

  IF gs_inventory-labst = gv_real.
    MESSAGE e000 WITH TEXT-e02 DISPLAY LIKE 'I'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_storage_by_inventory
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_storage_by_inventory .

  CASE gv_stltype.
*-- 원자재인 경우 zc102mmt0005
    WHEN 'R'.
      PERFORM update_0005_byinven.
    WHEN 'P'.
*-- 완제품인 경우, 강원 plant는 신선완제품 창고, 나머지 plant는 가공 완제품 창고 update
      IF zc102mmt0008-werks EQ 'P1000'. " 강원 PLANT
        PERFORM update_0006_byinven.
      ELSE.
        PERFORM update_0003_byinven.
      ENDIF.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form calculate_output
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM calculate .

  gv_change = gv_real - gv_labst.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form list_clicked
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM list_clicked .

**-- 전체 리스트를 백업
  gt_st_backup = gt_storage.

*-- ALV에 띄워지는 인터널 테이블 세팅(빨간색 STATUS만 넣기)
  CLEAR gt_storage.
  LOOP AT gt_st_backup INTO gs_st_backup.
    IF gs_st_backup-status = icon_led_red.
      APPEND gs_st_backup TO gt_storage.
    ENDIF.
  ENDLOOP.

*-- 모드 변경
  gv_filter_on = abap_false.

*-- ALV 업데이트
  PERFORM refresh_table.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_maktx
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_maktx .

  DATA : lv_tabix TYPE sy-tabix.

  LOOP AT gt_storage INTO gs_storage.

    lv_tabix = sy-tabix.

    CALL FUNCTION 'ZFM_CL102_MM_01'
      EXPORTING
        lv_matnr = gs_storage-matnr
      IMPORTING
        ev_maktx = gs_storage-maktx.

    MODIFY gt_storage FROM gs_storage INDEX lv_tabix
                                      TRANSPORTING maktx.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form allv_clicked
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM allv_clicked .

*-- 다시 SELECT
  PERFORM search_matno. " 자재번호, 입고일 세팅
  PERFORM get_stl_data.
  PERFORM set_status.

*-- 모드 변경
  gv_filter_on = abap_true.

*-- 동기화
  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_edit_pop
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_OBJECT
*&      --> E_INTERACTIVE
*&---------------------------------------------------------------------*
FORM handle_edit_pop USING po_object TYPE REF TO cl_alv_event_toolbar_set
                     pv_interactive.

  CLEAR gs_button_pop.
  gs_button_pop-function = 'SETA'.
  gs_button_pop-icon     = icon_check .
  gs_button_pop-quickinfo = '전체 유통기한 폐기'.
  gs_button_pop-text = '전체 유통기한 폐기'.
  APPEND gs_button_pop TO po_object->mt_toolbar.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_all_clicked
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_all_clicked .

  DATA : lv_answer, " 처리시 사용자 동의
         lv_tabix  TYPE sy-tabix,
         ls_style  TYPE lvc_s_styl.

*-- 사용자가 YES 시 저장 로직 실행
  PERFORM check_confirm_set_all CHANGING lv_answer.
  CHECK lv_answer EQ '1'.

  LOOP AT gt_dispose INTO gs_dispose.

    lv_tabix = sy-tabix.

*-- 폐기 사유 -> Z02(유통기한)
*    gs_dispose-reaso = 'Z02'.
    gs_dispose-reasotext = '유통기한 초과'.  " 유통기한 초과일 때

    MODIFY gt_dispose FROM gs_dispose INDEX lv_tabix
                                      TRANSPORTING reasotext.


  ENDLOOP.

  PERFORM set_pop_screen. " 유통기한인 경우 수량 DISABLED
  PERFORM refresh_pop_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_confirm_set_all
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- LV_ANSWER
*&---------------------------------------------------------------------*
FORM check_confirm_set_all  CHANGING pv_answer.

  CALL FUNCTION 'ZFM_CL102_CM_POP_UP'
    EXPORTING
      iv_titlebar = '유통기한 폐기 처리'
      iv_question = '전체 항목에 대해 유통기한 폐기 처리하시겠습니까?'
    IMPORTING
      ev_answer   = pv_answer.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_0005
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_0005 .

  IF gs_dispose-labst = gs_dispose-disme. " 가용재고 = 폐기수량
*-- 전량 폐기인 경우 DELETE
    DELETE FROM zc102mmt0005
  WHERE stlno = gv_stlno
    AND stltype = gv_stltype
    AND matnr = gs_dispose-matnr
    AND batno = gs_dispose-batno.
  ELSE.
*-- 일부 폐기인 경우 UPDATE
    UPDATE zc102mmt0005
    SET labst = gv_menge
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
    WHERE stlno = gv_stlno
        AND stltype = gv_stltype
        AND matnr = gs_dispose-matnr
        AND batno = gs_dispose-batno.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_0006
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_0006 .

  IF gs_dispose-labst = gs_dispose-disme. " 가용재고 = 폐기수량
*-- 전량 폐기인 경우 DELETE
    DELETE FROM zc102mmt0006
  WHERE stlno = gv_stlno
    AND stltype = gv_stltype
    AND matnr = gs_dispose-matnr
    AND batno = gs_dispose-batno.
  ELSE.
*-- 일부 폐기인 경우 UPDATE
    UPDATE zc102mmt0006
    SET labst = gv_menge
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
    WHERE stlno = gv_stlno
        AND stltype = gv_stltype
        AND matnr = gs_dispose-matnr
        AND batno = gs_dispose-batno.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_0003
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_0003 .

  IF gs_dispose-labst = gs_dispose-disme. " 가용재고 = 폐기수량
*-- 전량 폐기인 경우 DELETE
    DELETE FROM zc102mmt0003
  WHERE stlno = gv_stlno
    AND stltype = gv_stltype
    AND matnr = gs_dispose-matnr
    AND batno = gs_dispose-batno.
  ELSE.
*-- 일부 폐기인 경우 UPDATE
    UPDATE zc102mmt0003
    SET labst = gv_menge
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
    WHERE stlno = gv_stlno
        AND stltype = gv_stltype
        AND matnr = gs_dispose-matnr
        AND batno = gs_dispose-batno.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_0005_byinven
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_0005_byinven .

  IF gv_real = 0.        " 실제 수량 = 0
*-- 전량 실사인 경우 DELETE
    DELETE FROM zc102mmt0005
  WHERE stlno   = gv_stlno
    AND stltype = gv_stltype
    AND matnr   = gs_inventory-matnr
    AND batno   = gs_inventory-batno.
  ELSE.
*-- 일부 수량 실사의 경우 UPDATE
    UPDATE zc102mmt0005
    SET labst = gv_real
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
      WHERE stlno   = gv_stlno
        AND stltype = gv_stltype
        AND matnr   = gs_inventory-matnr
        AND batno   = gs_inventory-batno.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_0006_byinven
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_0006_byinven .


  IF gv_real = 0.        " 실제 수량 = 0
*-- 전량 실사인 경우 DELETE
    DELETE FROM zc102mmt0006
  WHERE stlno   = gv_stlno
    AND stltype = gv_stltype
    AND matnr   = gs_inventory-matnr
    AND batno   = gs_inventory-batno.
  ELSE.
*-- 일부 수량 실사의 경우 UPDATE
    UPDATE zc102mmt0006
    SET labst = gv_real
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
      WHERE stlno   = gv_stlno
        AND stltype = gv_stltype
        AND matnr   = gs_inventory-matnr
        AND batno   = gs_inventory-batno.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form update_0003_byinven
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_0003_byinven .

  IF gv_real = 0.        " 실제 수량 = 0
*-- 전량 실사인 경우 DELETE
    DELETE FROM zc102mmt0003
  WHERE stlno   = gv_stlno
    AND stltype = gv_stltype
    AND matnr   = gs_inventory-matnr
    AND batno   = gs_inventory-batno.
  ELSE.
*-- 일부 수량 실사의 경우 UPDATE
    UPDATE zc102mmt0003
    SET labst = gv_real
        aedat = sy-datum
        aenam = sy-uname
        aezet = sy-uzeit
      WHERE stlno   = gv_stlno
        AND stltype = gv_stltype
        AND matnr   = gs_inventory-matnr
        AND batno   = gs_inventory-batno.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_werks_f4
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_werks_f4 .

  DATA: lt_return TYPE TABLE OF ddshretval,
        ls_return TYPE ddshretval.

  " F4 도움말 팝업 표시
  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'WERKS'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_WERKS_D-WERKS'
      window_title = '창고번호'
      value_org    = 'S'
    TABLES
      value_tab    = gt_werks_d
      return_tab   = lt_return.

  " 선택한 사원번호로 내부 테이블에서 사원명 조회
  READ TABLE lt_return INTO ls_return INDEX 1.
  IF sy-subrc = 0 AND ls_return-fieldval IS NOT INITIAL.

    zc102mmt0008-werks = ls_return-fieldval.

    READ TABLE gt_werks_d INTO gs_werks_d WITH KEY werks = zc102mmt0008-werks.
    IF sy-subrc = 0.
      gv_pname = gs_werks_d-pname.
    ELSE.
      CLEAR zc102mmt0008-werks.
    ENDIF.

    PERFORM auto_enter.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_matnr_f4
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_matnr_f4 .

  DATA: lt_return TYPE TABLE OF ddshretval,
        ls_return TYPE ddshretval.

*-- 자재리스트 가져오기
  PERFORM get_matnr_data.

  " F4 도움말 팝업 표시
  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'MATNR'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_MAKTX-MATNR'
      window_title = '자재번호'
      value_org    = 'S'
    TABLES
      value_tab    = gt_maktx
      return_tab   = lt_return.

*  " 선택한 사원번호로 내부 테이블에서 사원명 조회
*  READ TABLE lt_return INTO ls_return INDEX 1.
*  IF sy-subrc = 0 AND ls_return-fieldval IS NOT INITIAL.
*
*    zc102mmt0005-matnr = ls_return-fieldval.

*  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_base_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_werks_data .

  IF gt_werks IS INITIAL. " 맨처음에만
*-- plant 도메인 가져와서 보여줄 테이블에 세팅
    DATA : lv_result TYPE string.                 .

    CALL FUNCTION 'DD_DOMVALUES_GET'
      EXPORTING
        domname   = 'ZC102D_PP_WERKS'
        text      = 'X'
        langu     = sy-langu
      TABLES
        dd07v_tab = gt_werks.

    CLEAR : gs_werks, gs_werks_d.
    LOOP AT gt_werks INTO gs_werks.
      IF gs_werks-domvalue_l <> 'P5000'. " 서울 빼고
        gs_werks_d-werks = gs_werks-domvalue_l.
        gs_werks_d-pname = gs_werks-ddtext.
        APPEND gs_werks_d TO gt_werks_d.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_matnr_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_matnr_data .

  CASE gv_stltype.

*-- 원자재인 경우 원자재만
    WHEN 'R'.
      SELECT matnr maktx
        INTO CORRESPONDING FIELDS OF TABLE gt_maktx
        FROM zc102mmt0004
        WHERE mtart = 'R'
        ORDER BY matnr.
    WHEN 'P'.
*-- 완제품인 경우, 강원 plant는 신선완제품만, 나머지 plant는 가공 완제품만
      IF zc102mmt0008-werks EQ 'P1000'. " 강원 PLANT
        SELECT matnr maktx
          INTO CORRESPONDING FIELDS OF TABLE gt_maktx
          FROM zc102mmt0004
          WHERE mtart = 'P' " 완제품
            AND mtype = 'F' " 신선
          ORDER BY matnr.
      ELSE.
        SELECT matnr maktx
          INTO CORRESPONDING FIELDS OF TABLE gt_maktx
          FROM zc102mmt0004
          WHERE mtart = 'P' " 완제품
            AND mtype = 'M' " 가공
          ORDER BY matnr.
      ENDIF.
*-- 포장 자재인 경우, 포장 자재만
    WHEN 'C'.
      SELECT matnr maktx
        INTO CORRESPONDING FIELDS OF TABLE gt_maktx
        FROM zc102mmt0004
        WHERE mtart = 'C' " 포장자재
        ORDER BY matnr.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form auto_enter
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM auto_enter .

  CALL FUNCTION 'SAPGUI_SET_FUNCTIONCODE'  " 엔터를 대신 눌러줌
    EXPORTING
      functioncode           = 'ENTER'
    EXCEPTIONS
      function_not_supported = 1
      OTHERS                 = 2.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form show_alv_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM show_alv_data .

*-- 만약 자재번호나 입고일이 입력되었을 때 처리
  PERFORM search_matno.

*-- 창고에서 자재 데이터 읽어옴
  PERFORM get_stl_data.

*-- 유통기한에 따른 상태 설정 & 화면 세팅
  PERFORM set_threshold. " 창고별 유통기한 기준
  PERFORM set_status.    " 유통기한 상태 표시 / 남은기한 / 체크박스
  PERFORM set_screen.    " 스크린 값 세팅

  IF gv_filter_on = abap_false.
    PERFORM list_clicked.
  ENDIF.

  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_display_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_display_screen .

  PERFORM set_layout.

  SET HANDLER : lcl_event_handler=>handle_edit_toolbar FOR go_alv_grid,
              lcl_event_handler=>user_command FOR go_alv_grid.

  CALL METHOD go_alv_grid->set_table_for_first_display
    EXPORTING
      is_variant           = gs_variant
      i_save               = 'A'
      i_default            = 'X'
      is_layout            = gs_layout
      it_toolbar_excluding = gt_ui_functions
    CHANGING
      it_outtab            = gt_storage
      it_fieldcatalog      = gt_fcat.
*        it_sort              = gt_sort.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_alv_listbox
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_alv_listbox .

*-- 도메인 값 읽어오기
  DATA: lv_domname TYPE domname VALUE 'ZC102D_MM_REASO'.  " 도메인명

  CLEAR : gt_drop, gs_drop, gt_ddtext, gs_ddtext.

  SELECT domname domvalue_l ddtext
    INTO CORRESPONDING FIELDS OF TABLE gt_ddtext
    FROM dd07t
    WHERE domname    = lv_domname
      AND ddlanguage = sy-langu.

*-- 드롭다운 테이블 구성
  LOOP AT gt_ddtext INTO gs_ddtext.
    CLEAR gs_drop.
    gs_drop-handle = 1.
    gs_drop-value = gs_ddtext-ddtext.   " 사용자에게 보여질 텍스트
    APPEND gs_drop TO gt_drop.
  ENDLOOP.

*-- ALV에 등록
  CALL METHOD go_pop_grid->set_drop_down_table
    EXPORTING
      it_drop_down = gt_drop.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_return_no
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_return_no .

  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      nr_range_nr = '01'
      object      = 'ZC102DIS'
    IMPORTING
      number      = gv_retno. " 자동채번 할 값을 받을 변수

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_md_in
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_md_in .

  CALL FUNCTION 'ZFM_CL102_MM_02'
    EXPORTING
      iv_bwart = '101'             " 자재문서유형
      iv_usnam = '한소연'            " 담당자명(OPTIONAL)
      iv_batno = gs_inventory-batno  " 배치번호
      iv_matnr = gs_inventory-matnr  " 자재번호
      iv_menge = gv_change          " 자재이동수량
      iv_meins = gs_inventory-meins  " 수량 단위
      iv_werks = gs_inventory-werks  " Plant번호
      iv_stlno = gs_inventory-stlno. " 창고번호

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_md_out
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_md_out .

  CALL FUNCTION 'ZFM_CL102_MM_02'
    EXPORTING
      iv_bwart = '103'             " 자재문서유형
      iv_usnam = '한소연'            " 담당자명(OPTIONAL)
      iv_batno = gs_inventory-batno  " 배치번호
      iv_matnr = gs_inventory-matnr  " 자재번호
      iv_menge = gv_change          " 자재이동수량
      iv_meins = gs_inventory-meins  " 수량 단위
      iv_werks = gs_inventory-werks  " Plant번호
      iv_stlno = gs_inventory-stlno. " 창고번호

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_md_dis
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_md_dis .

  CALL FUNCTION 'ZFM_CL102_MM_02'
    EXPORTING
      iv_bwart = '105'             " 자재문서유형
      iv_usnam = '한소연'            " 담당자명(OPTIONAL)
      iv_batno = gs_dispose-batno  " 배치번호
      iv_matnr = gs_dispose-matnr  " 자재번호
      iv_menge = gv_menge          " 자재이동수량
      iv_meins = gs_dispose-meins  " 수량 단위
      iv_werks = gs_dispose-werks  " Plant번호
      iv_stlno = gs_dispose-stlno. " 창고번호

ENDFORM.
*&---------------------------------------------------------------------*
*& Form goto_storage_1400
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM goto_storage_1400 .

*-- 체크된 항목이 있는지 체크
  DATA : lv_answer,
         lv_check_exist TYPE abap_bool VALUE abap_false,
         lv_werks       TYPE zc102mmt0008-werks,
         lv_stlno       TYPE zc102mmt0008-stlno,
         lv_docno       TYPE zc102mmt0012-mblnr,
         lv_refno       TYPE zc102mmt0012-refno.

  DATA: lt_mdline TYPE TABLE OF zc102mmt0013,
        ls_mdline TYPE zc102mmt0013.

*-- 변경된 데이터 있는지 확인
  IF go_alv_grid IS BOUND.
    CALL METHOD go_alv_grid->check_changed_data.
  ENDIF.

*-- 체크한 항목이 있는지 체크
  LOOP AT gt_storage INTO gs_storage.
    IF gs_storage-check = 'X'.
      lv_check_exist = abap_true.
    ENDIF.
  ENDLOOP.

  IF lv_check_exist EQ abap_false.
    MESSAGE s000 WITH '이동할 자재를 먼저 체크해주세요.' DISPLAY LIKE 'E'.
    EXIT.
  ELSE.
    PERFORM do_question CHANGING lv_answer.

    CHECK lv_answer EQ '1'.

*-- 사료 창고번호, PLANT 번호 가져오기
    SELECT SINGLE werks stlno
      INTO ( lv_werks, lv_stlno )
      FROM zc102mmt0008
      WHERE stltype = 'F'. " 사료창고

*-- 창고 이동 처리
    LOOP AT gt_storage INTO gs_storage WHERE check = 'X'.

*-- 자재 이동 문서 생성(출고)
      CLEAR ls_mdline.
      MOVE-CORRESPONDING gs_storage TO ls_mdline.
      ls_mdline-menge = gs_storage-labst.

      APPEND ls_mdline TO lt_mdline.

*-- 창고 번호 변경
      UPDATE zc102mmt0005
         SET werks = lv_werks
             stlno = lv_stlno
             stltype = 'F'
             aedat = sy-datum
             aenam = sy-uname
             aezet = sy-uzeit
       WHERE stlno = gs_storage-stlno
         AND matnr = gs_storage-matnr
         AND batno = gs_storage-batno.

    ENDLOOP.

*-- 입고 / 출고
    CALL FUNCTION 'ZFM_CL102_MM_03'
      EXPORTING
        iv_bwart          = '108'              " 유형 : 사료출고
*       IV_USNAM          =                    " 담당자명(OPTIONAL)
*       IV_REFNO          =                    " 참조번호(OPTIONAL)
        iv_werks          = zc102mmt0008-werks " Plant 번호(현재 plant)
        iv_stlno          = gv_stlno           " 창고번호(현재 창고)
      IMPORTING
        ev_docno          = lv_docno           " 필요한 경우 생성된 문서번호 get
      TABLES
        et_mdline         = lt_mdline
      EXCEPTIONS
        missing_key_value = 1
        OTHERS            = 2.

    lv_refno = CONV zc102mmt0012-refno( lv_docno ).
    CALL FUNCTION 'ZFM_CL102_MM_03'
      EXPORTING
        iv_bwart          = '107'    " 유형 : 사료입고
        iv_refno          = lv_refno " 참조번호(OPTIONAL)
        iv_werks          = lv_werks " Plant 번호(사료창고 plant)
        iv_stlno          = lv_stlno " 창고번호(사료창고)
      TABLES
        et_mdline         = lt_mdline
      EXCEPTIONS
        missing_key_value = 1
        OTHERS            = 2.

    PERFORM show_alv_data.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form do_question
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- LV_ANSWER
*&---------------------------------------------------------------------*
FORM do_question  CHANGING pv_answer.

  CALL FUNCTION 'ZFM_CL102_CM_POP_UP'
    EXPORTING
      iv_titlebar = '사료 창고 이동'
      iv_question = '사료 창고로 이동하시겠습니까?'
    IMPORTING
      ev_answer   = pv_answer.

ENDFORM.

----------------------------------------------------------------------------------
Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 758
