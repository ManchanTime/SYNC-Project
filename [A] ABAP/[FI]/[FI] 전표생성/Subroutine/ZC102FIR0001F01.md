``` abap
*&---------------------------------------------------------------------*
*& Include          ZC102FIR0001F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form main_screen_ctrl
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM main_screen_ctrl .
  IF go_container IS NOT BOUND.
    CLEAR : gt_line_fcat, gs_line_fcat.
    PERFORM set_fcat USING : 'X' 'BUZEI' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'BSCHL' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'SHKZG' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'SAKNR' 'ZC102FIT0010' 'C' ' ',
*                             ' ' 'BPACT' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'TXT20' 'ZC102FIT0002' ' ' 'X',
                             ' ' 'KOART' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'SGTXT' 'ZC102FIT0010' ' ' 'X',
                             ' ' 'WRBTR' 'ZC102FIT0010' ' ' ' ',
                             ' ' 'WAERS' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'DMBTR' 'ZC102FIT0010' ' ' ' ',
                             ' ' 'DWAER' '            ' 'C' ' ',
                             ' ' 'KOSTL' 'ZC102FIT0010' 'C' ' ',
                             ' ' 'MWSKZ' 'ZC102FIT0010' ' ' ' '.
    PERFORM set_layout USING TEXT-001.
    PERFORM set_variant USING 'ALV1'.
    PERFORM exclude_toolbar.
    PERFORM sort_data.
    PERFORM create_obj.
    PERFORM set_alv_listbox.
    SET HANDLER : lcl_event_handler=>modify_value       FOR go_alv_grid,
                  lcl_event_handler=>edit_toolbar       FOR go_alv_grid,
                  lcl_event_handler=>user_command       FOR go_alv_grid,
                  lcl_event_handler=>handle_search_help FOR go_alv_grid.
    PERFORM display_screen.
    PERFORM register_event.
    PERFORM regiset_f4_fields.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_fcat USING pv_key pv_field pv_table pv_just pv_emph.
  gs_line_fcat-key       = pv_key.
  gs_line_fcat-fieldname = pv_field.
  gs_line_fcat-ref_table = pv_table.
  gs_line_fcat-just      = pv_just.
  gs_line_fcat-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'WRBTR'.
      gs_line_fcat-cfieldname = 'WAERS'.
*      gs_line_fcat-ref_field  = 'WRBTR'.
      gs_line_fcat-do_sum = abap_true.
    WHEN 'DMBTR'.
      gs_line_fcat-cfieldname = 'DWAER'.
      gs_line_fcat-do_sum = abap_true.
    WHEN 'DWAER'.
      gs_line_fcat-coltext = TEXT-f01.
    WHEN 'TXT20'.
      gs_line_fcat-coltext = TEXT-f02.
    WHEN 'BSCHL'.
      gs_line_fcat-drdn_field  = 'DROP_DOWN_HANDLE'.
      gs_line_fcat-drdn_hndl   = '1'.
      gs_line_fcat-drdn_alias  = 'X'.
      gs_line_fcat-outputlen   = 20.
      gs_line_fcat-just        = 'C'.
    WHEN 'SAKNR'.
      gs_line_fcat-f4availabl = abap_true.
      gs_line_fcat-edit       = abap_true.
  ENDCASE.

  APPEND gs_line_fcat TO gt_line_fcat.
  CLEAR gs_line_fcat.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> TEXT_001
*&---------------------------------------------------------------------*
FORM set_layout USING pv_title.
  gs_layout-zebra      = abap_true.
  gs_layout-cwidth_opt = 'A'.
  gs_layout-sel_mode   = 'D'.
  gs_layout-stylefname = 'CELL_TAB'.
  gs_layout-grid_title = pv_title.
*  gs_layout-totals_bef = abap_true.
*  gs_layout-no_totline = abap_true.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_variant
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_variant  USING pv_handle.
  gs_variant-report = sy-repid.
  gs_variant-handle = pv_handle.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form exclude_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM exclude_toolbar .
  DATA : ls_ui_functions TYPE ui_func.

  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_undo.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_cut.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_delete_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_insert_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_append_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_refresh.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_auf.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_average.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_print.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_graph.
  APPEND ls_ui_functions TO gt_ui_functions.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_obj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_obj .
  CREATE OBJECT go_container
    EXPORTING
      container_name = 'MAIN_CONT'.

  CREATE OBJECT go_alv_grid
    EXPORTING
      i_parent = go_container.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_screen .
  CALL METHOD go_alv_grid->set_table_for_first_display
    EXPORTING
      is_variant           = gs_variant
      i_save               = 'A'
      i_default            = 'X'
      is_layout            = gs_layout
      it_toolbar_excluding = gt_ui_functions
    CHANGING
      it_outtab            = gt_line
      it_fieldcatalog      = gt_line_fcat
      it_sort              = gt_sort.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form register_event
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM register_event .
  CALL METHOD go_alv_grid->set_ready_for_input
    EXPORTING
      i_ready_for_input = 1.
  CALL METHOD go_alv_grid->register_edit_event
    EXPORTING
      i_event_id = cl_gui_alv_grid=>mc_evt_modified.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_icon
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen_element .
  IF gv_debit_sum = gv_credit_sum.
    gv_icon = '@5B@'.
  ELSE.
    gv_icon = '@5C@'.
  ENDIF.

  gv_info1 = '@0S@'. "느낌표
  gv_info2 = '@0S@'. "느낌표
  gv_info3 = '@0S@'. "느낌표
  gv_info4 = '@0S@'. "느낌표
  gv_info5 = '@0S@'. "느낌표

  READ TABLE gt_blart INTO gs_blart WITH KEY blart = zc102fit0009-blart.
  IF sy-subrc = 0.
    gv_ltext = gs_blart-ltext.

  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_edit_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_OBJECT
*&      --> E_INTERACTIVE
*&---------------------------------------------------------------------*
FORM handle_edit_toolbar USING po_object TYPE REF TO cl_alv_event_toolbar_set
                               pv_interactive.
  PERFORM button_ctrl USING 'DROW' '행 삭제' po_object.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form button_ctrl
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> PO_OBJECT
*&---------------------------------------------------------------------*
FORM button_ctrl USING pv_func pv_qinfo
                       po_object TYPE REF TO cl_alv_event_toolbar_set.
  CLEAR gs_button.
  gs_button-function  = pv_func.
  gs_button-quickinfo = pv_qinfo.

  CASE pv_func.
    WHEN 'DROW'.
      gs_button-icon = icon_delete_row.
  ENDCASE.

  APPEND gs_button TO po_object->mt_toolbar.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_user_command
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_UCOMM
*&---------------------------------------------------------------------*
FORM handle_user_command  USING pv_ucomm.
  CASE pv_ucomm.
    WHEN 'DROW'.
      PERFORM delete_row.
  ENDCASE.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form delete_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM delete_row .
  DATA : lt_roid TYPE lvc_t_roid,
         ls_roid TYPE lvc_s_roid.

  CALL METHOD go_alv_grid->get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

  IF lt_roid IS INITIAL.
    MESSAGE s009 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  LOOP AT lt_roid INTO ls_roid.
    DELETE gt_line INDEX ls_roid-row_id.
  ENDLOOP.

  PERFORM number_buzei.
  PERFORM refresh_table.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form number_buzei
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM number_buzei .
  CLEAR gv_tabix.

  LOOP AT gt_line INTO gs_line.
    gv_tabix = sy-tabix.
    gs_line-buzei = gv_tabix.
    MODIFY gt_line FROM gs_line INDEX sy-tabix.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_table .
  CALL METHOD go_alv_grid->refresh_table_display.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_modify_values
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_MODIFIED
*&      --> ET_GOOD_CELLS
*&---------------------------------------------------------------------*
FORM handle_modify_values USING pv_modified
                                pt_good_cells TYPE lvc_t_modi.

  DATA : ls_good_cells TYPE lvc_s_modi.

  CHECK pv_modified IS NOT INITIAL.

  LOOP AT pt_good_cells INTO ls_good_cells.
    CLEAR gs_line.
    READ TABLE gt_line INTO gs_line INDEX ls_good_cells-row_id.

    CASE ls_good_cells-fieldname.

      WHEN 'BSCHL'. " 수정된 필드가 BSCHL(전기키)이면 차/대 구분 자동 세팅
        CLEAR gs_bschl.
        READ TABLE gt_bschl INTO gs_bschl WITH KEY gs_line-bschl.
        IF sy-subrc = 0.
          gs_line-koart = gs_bschl-koart.
        ENDIF.

        CASE gs_line-bschl.
          WHEN '01' OR '31' OR '40'.
            gs_line-shkzg = 'S'. " 차변
            IF gs_line-wrbtr < 0.
              gs_line-wrbtr = gs_line-wrbtr * -1.
            ENDIF.
          WHEN '15' OR '35' OR '50'.
            gs_line-shkzg = 'H'. " 대변
            IF gs_line-wrbtr > 0.
              gs_line-wrbtr = gs_line-wrbtr * -1.
            ENDIF.
          WHEN OTHERS.
            MESSAGE s018 DISPLAY LIKE 'I'.
            CLEAR gs_line-bschl.
        ENDCASE.

      WHEN 'SAKNR'. " 수정된 필드가 SAKNR(계정)이면 계정 텍스트 자동 세팅
        READ TABLE gt_partner INTO gs_partner WITH KEY bpact = gs_line-saknr. " 조정계정 세팅
        IF sy-subrc = 0.
          gs_line-saknr = gs_partner-saknr.
          gs_line-bpact = gs_partner-bpact.
        ENDIF.

        READ TABLE gt_saknr INTO gs_saknr WITH KEY saknr = gs_line-saknr.
        IF sy-subrc = 0.
          gs_line-txt20 = gs_saknr-txt20.
        ENDIF.

      WHEN 'WRBTR'.
        CLEAR : gs_line-dmbtr, gv_currdec, gv_divider.

*-- 차변 음수 방지
        IF ( gs_line-shkzg = 'S' ) AND
           ( gs_line-wrbtr < 0 ).
          gs_line-wrbtr = gs_line-wrbtr * -1.
        ENDIF.

*-- 소수점 세팅
        READ TABLE gt_tcurx INTO gs_tcurx WITH KEY currkey = zc102fit0009-waers.
        IF sy-subrc <> 0.
          gv_currdec = 2.
        ELSE.
          gv_currdec = gs_tcurx-currdec.
        ENDIF.

        gv_divider = 10 ** gv_currdec.
        gv_amount = gs_line-wrbtr / gv_divider.
*
**-- 환율 계산
        READ TABLE gt_rate INTO gs_rate WITH KEY o_waers = zc102fit0009-waers.
        IF sy-subrc = 0.
          gs_line-dmbtr = gv_amount * gs_rate-wrbtr.
        ENDIF.

*-- 대변 부호 세팅
        IF ( gs_line-shkzg = 'H' ) AND
           ( gs_line-wrbtr > 0 ).
          gs_line-wrbtr = gs_line-wrbtr * -1.
        ENDIF.

        IF ( gs_line-shkzg = 'H' ) AND
           ( gs_line-dmbtr > 0 ).
          gs_line-dmbtr = gs_line-dmbtr * -1.
        ENDIF.

    ENDCASE.

    gs_line-modi_yn = abap_true.
    MODIFY gt_line FROM gs_line INDEX ls_good_cells-row_id
                                TRANSPORTING shkzg bschl koart wrbtr dmbtr
                                             txt20 modi_yn saknr bpact.
  ENDLOOP.

  PERFORM calculate_total.
  PERFORM pbo_execute.
  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form calculate_total
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM calculate_total .
  CLEAR: gv_debit_sum, gv_credit_sum.

  LOOP AT gt_line INTO gs_line.
    IF gs_line-shkzg = 'S'.
      gv_debit_sum = gv_debit_sum + gs_line-wrbtr.
    ELSEIF gs_line-shkzg = 'H'.
      IF ( gs_line-wrbtr < 0 ).
        gv_credit_sum = gv_credit_sum + ( gs_line-wrbtr * -1 ).
      ELSE.
        gv_credit_sum = gv_credit_sum + gs_line-wrbtr.
      ENDIF.
    ENDIF.
  ENDLOOP.

  IF gv_debit_sum >= gv_credit_sum.
    gv_total = gv_debit_sum - gv_credit_sum.
  ELSE.
    gv_total = gv_credit_sum - gv_debit_sum.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form pbo_execute
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM pbo_execute .
  CALL METHOD cl_gui_cfw=>set_new_ok_code
    EXPORTING
      new_code = 'XXXX'.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_init_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_init_screen .
  zc102fit0009-bukrs = '1000'.
  zc102fit0009-gjahr = sy-datum(4).
  zc102fit0009-bldat = sy-datum.
  gv_waers = 'KRW'.

  IF ( zc102fit0009-waers IS INITIAL ) AND
    ( zc102fit0009-budat IS INITIAL ).
    zc102fit0009-waers = 'KRW'.
    zc102fit0009-budat = sy-datum.
  ENDIF.

  zc102fit0010-waers = zc102fit0009-waers.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form insert_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM insert_row .
  DATA ls_line LIKE gs_line.
  CLEAR gs_line.

  PERFORM edit_ctrl USING ' '.
  PERFORM read_mode USING : 'BUZEI', 'SHKZG', 'KOART', 'DWAER',
                            'WAERS', 'TXT20', 'DMBTR', 'BPACT'.

  LOOP AT gt_line INTO ls_line.
    ls_line-buzei = ls_line-buzei + 1.
    gs_line-buzei = ls_line-buzei.
  ENDLOOP.

  IF gs_line-buzei IS INITIAL.
    gs_line-buzei = 1.
  ENDIF.

  gs_line-bschl = zc102fit0010-bschl.

  CASE gs_line-bschl.
    WHEN '01' OR '31' OR '40'.
      gs_line-shkzg = 'S'. " 차변
    WHEN '15' OR '35' OR '50'.
      gs_line-shkzg = 'H'. " 대변
  ENDCASE.

*-- 계정 유형
  READ TABLE gt_bschl INTO gs_bschl WITH KEY bschl = zc102fit0010-bschl.
  IF sy-subrc = 0.
    gs_line-koart = gs_bschl-koart.
  ENDIF.

  gs_line-saknr = zc102fit0010-saknr.

*-- 계정 상세
  READ TABLE gt_saknr INTO gs_saknr WITH KEY saknr = gs_line-saknr.
  IF sy-subrc = 0.
    gs_line-txt20 = gs_saknr-txt20.
  ENDIF.

  gs_line-wrbtr = zc102fit0010-wrbtr.
  gs_line-waers = zc102fit0009-waers.
  gs_line-dwaer = gv_waers.
  gs_line-modi_yn = abap_true.

  APPEND gs_line TO gt_line.

  PERFORM calculate_total.
  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form edit_ctrl
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&---------------------------------------------------------------------*
FORM edit_ctrl  USING pv_field.
  CLEAR : gs_style.
  gs_style-fieldname = pv_field.
  gs_style-style     = cl_gui_alv_grid=>mc_style_enabled.
  INSERT gs_style INTO TABLE gs_line-cell_tab.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form read_mode
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&---------------------------------------------------------------------*
FORM read_mode  USING pv_field.
  CLEAR : gs_style.
  gs_style-fieldname = pv_field.
  gs_style-style     = cl_gui_alv_grid=>mc_style_disabled.
  INSERT gs_style INTO TABLE gs_line-cell_tab.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_curr_key
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_curr_key .
  CLEAR : gs_line, gv_tabix.

  LOOP AT gt_line INTO gs_line.
    gv_tabix = sy-tabix.

    IF gs_line-waers <> zc102fit0009-waers.
      CLEAR : gs_line-wrbtr, gs_line-dmbtr.
      gs_line-waers = zc102fit0009-waers.
    ENDIF.

    MODIFY gt_line FROM gs_line INDEX gv_tabix
                                TRANSPORTING wrbtr dmbtr waers.
  ENDLOOP.
  PERFORM refresh_table.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_docu
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_docu .
*-- 금액 체크
  LOOP AT gt_line INTO gs_line.
    IF gs_line-wrbtr IS INITIAL.
      MESSAGE s001 WITH TEXT-002 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    IF gs_line-bschl IS INITIAL.
      MESSAGE s001 WITH TEXT-003 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    IF gs_line-saknr IS INITIAL.
      MESSAGE s001 WITH TEXT-004 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.
  ENDLOOP.

*-- 대차 금액 체크
  IF gv_total <> 0.
    MESSAGE s014 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

*-- 변경 여부 확인
  CLEAR : gs_line.
  READ TABLE gt_line INTO gs_line WITH KEY modi_yn = abap_true.
  IF sy-subrc NE 0.
    MESSAGE s006 DISPLAY LIKE 'W'.
    EXIT.
  ENDIF.

*-- 저장여부 확인
  PERFORM popup_confirm CHANGING gv_answer.
  CHECK gv_answer EQ '1'.

*-- 대변 부호 정상화
  CLEAR : gs_line, gv_tabix.

  LOOP AT gt_line INTO gs_line.
    gv_tabix = sy-tabix.

*-- 조정 계정 체크
    READ TABLE gt_partner INTO gs_partner WITH KEY saknr = gs_line-saknr.
    IF sy-subrc = 0.
      gs_line-saknr = gs_partner-bpact.
      gs_line-bpact = gs_partner-saknr.
      gs_line-partner = gs_partner-partner.
    ENDIF.

    IF gs_line-shkzg = 'H'.
      gs_line-wrbtr = gs_line-wrbtr * -1.
      gs_line-dmbtr = gs_line-dmbtr * -1.
    ENDIF.
    MODIFY gt_line FROM gs_line INDEX gv_tabix
                                TRANSPORTING wrbtr dmbtr saknr
                                             bpact partner.
  ENDLOOP.


*-- 전표 번호 세팅
  PERFORM set_belnr.

*-- 헤더 세팅
  PERFORM set_hedaer_data.

*-- 저장
  PERFORM save_data.

  IF sy-subrc = 0.
    MESSAGE s007 WITH gv_num. " 저장 성공
    COMMIT WORK.
  ELSE.
    MESSAGE s008 DISPLAY LIKE 'W'. " 저장 실패
    ROLLBACK WORK.
  ENDIF.

  PERFORM clear_screen.
  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form popup_confirm
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- GV_ANSWER
*&---------------------------------------------------------------------*
FORM popup_confirm CHANGING pv_answer.
  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = ' '
      text_question         = '전표를 생성하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '2'
      display_cancel_button = ' '
    IMPORTING
      answer                = pv_answer.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_belnr
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_belnr .
  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      nr_range_nr = '01'
      object      = 'ZC102_FI'
    IMPORTING
      number      = gv_num.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_hedaer_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_hedaer_data .
  CLEAR gs_header.

  gs_header = VALUE #( bukrs = zc102fit0009-bukrs
                       belnr = gv_num
                       gjahr = zc102fit0009-gjahr
                       blart = zc102fit0009-blart
                       budat = zc102fit0009-budat
                       bldat = zc102fit0009-bldat
                       bktxt = zc102fit0009-bktxt
                       waers = zc102fit0009-waers
                       erdat = sy-datum
                       ernam = sy-uname
                       erzet = sy-uzeit ).


  APPEND gs_header TO gt_header.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form save_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save_data .
*-- For Save
  DATA : lt_header_save TYPE TABLE OF zc102fit0009,
         ls_header_save TYPE zc102fit0009,
         lt_line_save   TYPE TABLE OF zc102fit0010,
         ls_line_save   TYPE zc102fit0010.

  CLEAR gv_tabix.

  MOVE-CORRESPONDING gt_header TO lt_header_save.

  LOOP AT gt_line INTO gs_line.
    gv_tabix = sy-tabix.
    IF sy-subrc = 0.
      gs_line = VALUE #( bukrs = gs_header-bukrs
                         belnr = gs_header-belnr
                         gjahr = gs_header-gjahr
                         waers = zc102fit0009-waers
                         kokrs = '1000'
                         erdat = sy-datum
                         ernam = sy-uname
                         erzet = sy-uzeit ).

      MODIFY gt_line FROM gs_line INDEX gv_tabix
                                  TRANSPORTING bukrs belnr gjahr waers
                                               kokrs erdat ernam erzet.
    ENDIF.
    CLEAR gs_line.
  ENDLOOP.

  MOVE-CORRESPONDING gt_line TO lt_line_save.

*-- DB 저장
  MODIFY zc102fit0009 FROM TABLE lt_header_save.
  MODIFY zc102fit0010 FROM TABLE lt_line_save.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form clear_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clear_screen .
  CLEAR : gt_line, gs_line, gv_num,
          gv_debit_sum, gv_credit_sum, gv_total,
          zc102fiT0009-blart, zc102fiT0009-bktxt,
          zc102fiT0010-bschl, zc102fiT0010-saknr,
          zc102fiT0010-wrbtr, zc102fit0009-budat,
          zc102fit0009-waers, gv_ltext.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_header
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_header .
  IF ( zc102fit0009-budat IS NOT INITIAL ) AND
     ( zc102fit0009-blart IS NOT INITIAL ) AND
     ( zc102fit0009-waers IS NOT INITIAL ).
    gv_lock = abap_false.
  ELSE.
    gv_lock = abap_true.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen .
  LOOP AT SCREEN.
    CASE screen-name.
      WHEN 'ZC102FIT0009-BUDAT'.
        IF zc102fit0009-budat IS INITIAL.
          MESSAGE s001 WITH TEXT-s01 DISPLAY LIKE 'E'.
          screen-input = 1.
          screen-intensified = '1'.
        ELSE.
          gv_lock = abap_false.
          screen-input = 0.
        ENDIF.

      WHEN 'ZC102FIT0009-BLART'.
        IF zc102fit0009-blart IS INITIAL.
          MESSAGE s001 WITH TEXT-s02 DISPLAY LIKE 'E'.
          screen-input = 1.
          screen-intensified = '1'.
        ELSE.
          gv_lock = abap_false.
          screen-input = 0.
        ENDIF.

      WHEN 'ZC102FIT0009-WAERS'.
        IF zc102fit0009-waers IS INITIAL.
          MESSAGE s001 WITH TEXT-s03 DISPLAY LIKE 'E'.
          screen-input = 1.
          screen-intensified = '1'.
        ELSE.
          gv_lock = abap_false.
          screen-input = 0.
        ENDIF.

    ENDCASE.
    MODIFY SCREEN.

  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_f4_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_f4_data .
  CLEAR : gt_blart, gt_waers, gt_saknr, gt_bschl.

  SELECT blart ltext
    INTO CORRESPONDING FIELDS OF TABLE gt_blart
    FROM zc102fit0005.

  SELECT bschl koart ltext
  INTO CORRESPONDING FIELDS OF TABLE gt_bschl
  FROM zc102fit0004.

  SELECT saknr txt20
    INTO CORRESPONDING FIELDS OF TABLE gt_saknr
    FROM zc102fit0002
    ORDER BY saknr.

  SELECT DISTINCT o_waers
    INTO CORRESPONDING FIELDS OF TABLE gt_waers
    FROM zc102fit0015.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_search_help_blart
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_search_help_blart .
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'BLART'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_BLART-BLART'
      window_title = '전표 유형'
      value_org    = 'S'
    TABLES
      value_tab    = gt_blart
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  CUST_F4_BSCHL  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE cust_f4_bschl INPUT.

  IF  zc102fit0009-blart IS NOT INITIAL.
    CLEAR gt_bschl.
    CASE zc102fit0009-blart.
      WHEN 'DR' OR 'DZ'.
        SELECT bschl koart ltext
          INTO CORRESPONDING FIELDS OF TABLE gt_bschl
          FROM zc102fit0004
          WHERE koart <> 'K'.

      WHEN 'KR' OR 'KZ'.
        SELECT bschl koart ltext
          INTO CORRESPONDING FIELDS OF TABLE gt_bschl
          FROM zc102fit0004
          WHERE koart <> 'D'.

      WHEN OTHERS.
        SELECT bschl koart ltext
          INTO CORRESPONDING FIELDS OF TABLE gt_bschl
          FROM zc102fit0004
          WHERE koart NOT IN ( 'D', 'K' ).
    ENDCASE.
  ENDIF.

  SORT gt_bschl BY bschl ASCENDING.

  IF zc102fit0010-bschl IS INITIAL.
    PERFORM set_search_help_bschl.
  ENDIF.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  CUST_F4_SAKNR  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE cust_f4_saknr INPUT.

  IF zc102fit0010-bschl IS NOT INITIAL.
    CLEAR : gs_bschl, gt_saknr.
    READ TABLE gt_bschl INTO gs_bschl WITH KEY bschl = zc102fit0010-bschl.
    CASE gs_bschl-koart.
      WHEN 'D'.
        SELECT saknr txt20
          INTO CORRESPONDING FIELDS OF TABLE gt_saknr
          FROM zc102fit0002
          WHERE ktoks NOT IN ( 'K', 'C' ).
      WHEN 'K'.
        SELECT saknr txt20
          INTO CORRESPONDING FIELDS OF TABLE gt_saknr
          FROM zc102fit0002
          WHERE ktoks NOT IN ( 'D', 'P' ).

      WHEN OTHERS.
        SELECT saknr txt20
          INTO CORRESPONDING FIELDS OF TABLE gt_saknr
          FROM zc102fit0002
          WHERE ktoks NOT IN ( 'D', 'K' ).
    ENDCASE.

  ELSE.
    CLEAR gt_saknr.
    IF zc102fit0009-blart IS NOT INITIAL.
      CASE zc102fit0009-blart.
        WHEN 'DR' OR 'DZ'.
          SELECT saknr txt20
            INTO CORRESPONDING FIELDS OF TABLE gt_saknr
            FROM zc102fit0002
            WHERE ktoks NOT IN ( 'K', 'C' ).

        WHEN 'KR' OR 'KZ'.
          SELECT saknr txt20
            INTO CORRESPONDING FIELDS OF TABLE gt_saknr
            FROM zc102fit0002
            WHERE ktoks NOT IN ( 'D', 'P' ).

        WHEN OTHERS.
          SELECT saknr txt20
            INTO CORRESPONDING FIELDS OF TABLE gt_saknr
            FROM zc102fit0002
            WHERE ktoks NOT IN ( 'K', 'D' ).
      ENDCASE.

    ELSE.
      SELECT saknr txt20
        INTO CORRESPONDING FIELDS OF TABLE gt_saknr
        FROM zc102fit0002.
    ENDIF.

  ENDIF.

  SORT gt_saknr BY saknr ASCENDING.

  IF zc102fit0010-saknr IS INITIAL.
    PERFORM set_search_help_saknr.
  ENDIF.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Form set_search_help_saknr
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_search_help_saknr .
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'SAKNR'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_SAKNR-SAKNR'
      window_title = '계정과목'
      value_org    = 'S'
    TABLES
      value_tab    = gt_saknr
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_search_help_bschl
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_search_help_bschl.
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'BSCHL'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_BSCHL-BSCHL'
      window_title = '전기 키'
      value_org    = 'S'
    TABLES
      value_tab    = gt_bschl
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_alv_listbox
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_alv_listbox .
*  DATA : lt_bschl TYPE TABLE OF zc102fit0004,
*         ls_bschl TYPE zc102fit0004.
*
*  CLEAR : lt_bschl, ls_bschl.
*
*  IF zc102fit0009-blart IS NOT INITIAL.
*    CASE zc102fit0009-blart.
*      WHEN 'DR' OR 'DZ'.
*        SELECT bschl
*          INTO CORRESPONDING FIELDS OF TABLE lt_bschl
*          FROM zc102fit0004
*          WHERE koart <> 'K'.
*      WHEN 'KR' OR 'KZ'.
*        SELECT bschl
*          INTO CORRESPONDING FIELDS OF TABLE lt_bschl
*          FROM zc102fit0004
*          WHERE koart <> 'D'.
*    ENDCASE.
*  ELSE.
*    SELECT bschl
*      INTO CORRESPONDING FIELDS OF TABLE lt_bschl
*      FROM zc102fit0004.
*  ENDIF.
*
*  LOOP AT lt_bschl INTO ls_bschl.
*    gs_bschl_drop-handle = 1.
*    gs_bschl_drop-value = ls_bschl-bschl.
*    IF sy-subrc = 0.
*      APPEND gs_bschl_drop TO gt_bschl_drop.
*    ENDIF.
*
*  ENDLOOP.
**********************************************************************
  CLEAR : gs_bschl.

  LOOP AT gt_bschl INTO gs_bschl.
    gs_bschl_drop-handle = 1.
    gs_bschl_drop-value = gs_bschl-bschl.
    IF sy-subrc = 0.
      APPEND gs_bschl_drop TO gt_bschl_drop.
    ENDIF.

  ENDLOOP.
**********************************************************************
  CALL METHOD go_alv_grid->set_drop_down_table
    EXPORTING
      it_drop_down = gt_bschl_drop.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form onf4
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_FIELDNAME
*&      --> E_FIELDVALUE
*&      --> ES_ROW_NO
*&      --> ER_EVENT_DATA
*&      --> ET_BAD_CELLS
*&      --> E_DISPLAY
*&---------------------------------------------------------------------*
FORM onf4 USING p_fieldname   TYPE  lvc_fname
                p_fieldvalue  TYPE  lvc_value
                ps_row_no     TYPE  lvc_s_roid
                pi_event_data TYPE REF TO cl_alv_event_data
                pt_bad_cells  TYPE  lvc_t_modi
                p_display     TYPE  char01.

  FIELD-SYMBOLS <fs_tab> TYPE STANDARD TABLE.

  DATA: dynprog          LIKE sy-repid,
        dynnr            LIKE sy-dynnr,
        window_title(30) TYPE c,
        l_row            TYPE p.

  DATA : ls_line  LIKE gs_line,
         lv_field TYPE dfies-fieldname,
         lv_text  TYPE help_info-dynprofld,
         lv_flag.

  READ TABLE gt_line INTO ls_line INDEX ps_row_no-row_id.

  DATA : lt_return LIKE TABLE OF ddshretval WITH HEADER LINE.
  CLEAR : dynprog, dynnr, window_title.

  dynprog = sy-repid.
  dynnr = sy-dynnr.

  CASE p_fieldname.
    WHEN 'SAKNR'.
      window_title = '계정 과목'.
      lv_field     = 'SAKNR'.
      lv_text      = 'TXT20'.
      ASSIGN gt_saknr TO <fs_tab>.
  ENDCASE.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield        = lv_field " ALV 에 박히는 값
      dynpprog        = dynprog
      dynpnr          = dynnr
      dynprofield     = lv_text
      window_title    = window_title
      value_org       = 'S'
    TABLES
      value_tab       = <fs_tab>
      return_tab      = lt_return
    EXCEPTIONS
      parameter_error = 1
      no_values_found = 2
      OTHERS          = 3.

  pi_event_data->m_event_handled = 'X'.

  FIELD-SYMBOLS:  <fs> TYPE lvc_t_modi.

  DATA: ls_modi TYPE lvc_s_modi.

  ASSIGN pi_event_data->m_data->* TO <fs>.

  READ TABLE lt_return INDEX 1.
  IF sy-subrc = 0.
    ls_modi-row_id    = ps_row_no-row_id.
    ls_modi-fieldname = p_fieldname.
    ls_modi-value     = lt_return-fieldval.
    APPEND ls_modi TO <fs>.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form regiset_f4_fields
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM regiset_f4_fields .
  DATA : lt_f4 TYPE lvc_t_f4 WITH HEADER LINE.
  DATA : lt_f4_data TYPE lvc_s_f4.

  lt_f4_data-fieldname   = 'SAKNR'.
  lt_f4_data-register    = 'X' .
  lt_f4_data-getbefore   = 'X' .
  lt_f4_data-chngeafter  = 'X'.
  INSERT lt_f4_data INTO TABLE lt_f4.

  CALL METHOD go_alv_grid->register_f4_for_fields
    EXPORTING
      it_f4 = lt_f4[].
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_exchange_amount
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_exchange_amount .
  CLEAR : gv_tabix, gv_amount, gv_divider, gv_currdec.

*-- 소수점 자릿수 계산
  READ TABLE gt_tcurx INTO gs_tcurx WITH KEY currkey = zc102fit0009-waers.
  IF sy-subrc <> 0.
    gv_currdec = 2.
  ELSE.
    gv_currdec = gs_tcurx-currdec.
  ENDIF.

  LOOP AT gt_line INTO gs_line.
    gv_tabix = sy-tabix.

*-- 소수점 자리 조정
    gv_divider = 10 ** gv_currdec.
    gv_amount = gs_line-wrbtr / gv_divider.

*-- 환율 계산
    READ TABLE gt_rate INTO gs_rate WITH KEY o_waers = zc102fit0009-waers.
    IF sy-subrc = 0.

      gs_line-dmbtr = gv_amount * gs_rate-wrbtr.

    ENDIF.

*-- 대변 부호 설정
    IF ( gs_line-shkzg = 'H' ) AND
       ( gs_line-wrbtr > 0 ).
      gs_line-wrbtr = gs_line-wrbtr * -1.
    ENDIF.

    IF ( gs_line-shkzg = 'H' ) AND
       ( gs_line-dmbtr > 0 ).
      gs_line-dmbtr = gs_line-dmbtr * -1.
    ENDIF.

    MODIFY gt_line FROM gs_line INDEX gv_tabix
                                TRANSPORTING shkzg wrbtr dmbtr.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_exchange_rate
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_exchange_rate .
  CLEAR : gt_rate, gs_rate.

  SELECT o_waers datum wrbtr
    INTO CORRESPONDING FIELDS OF TABLE gt_rate
    FROM zc102fit0015.

  SORT gt_rate BY o_waers datum DESCENDING.
  DELETE ADJACENT DUPLICATES FROM gt_rate
  COMPARING o_waers.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_search_help_waers
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_search_help_waers .
  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'WAERS'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_WAERS-O_WAERS'
      window_title = '통화 키'
      value_org    = 'S'
    TABLES
      value_tab    = gt_waers
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_init_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_init_value .
  zc102fit0009-waers = 'KRW'.
  zc102fit0009-budat = sy-datum.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_value .
  IF zc102fit0009-blart IS NOT INITIAL.
    READ TABLE gt_blart INTO gs_blart WITH KEY blart = zc102fit0009-blart.
    IF sy-subrc <> 0.
      gv_blart_lock = abap_true.
    ELSE.
      CLEAR gv_blart_lock.
    ENDIF.

  ENDIF.

  IF zc102fit0010-bschl IS NOT INITIAL.
    READ TABLE gt_bschl INTO gs_bschl WITH KEY bschl = zc102fit0010-bschl.
    IF sy-subrc <> 0.
      gv_bschl_lock = abap_true.
    ELSE.
      CLEAR gv_bschl_lock.
    ENDIF.

  ENDIF.

  IF zc102fit0010-saknr IS NOT INITIAL.
    READ TABLE gt_saknr INTO gs_saknr WITH KEY saknr = zc102fit0010-saknr.
    IF sy-subrc <> 0.
      gv_saknr_lock = abap_true.
    ELSE.
      CLEAR gv_saknr_lock.
    ENDIF.

  ENDIF.

  IF ( zc102fit0009-waers IS NOT INITIAL ) AND
    ( zc102fit0009-waers <> 'KRW' ).
    READ TABLE gt_waers INTO gs_waers WITH KEY o_waers = zc102fit0009-waers.
    IF sy-subrc <> 0.
      gv_waers_lock = abap_true.
    ELSE.
      CLEAR gv_waers_lock.
    ENDIF.

  ENDIF.

  IF zc102fit0010-wrbtr < 0.
    CLEAR zc102fit0010-wrbtr.
    MESSAGE s000 WITH TEXT-005 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form lock_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM lock_screen .
  LOOP AT SCREEN.
    IF ( gv_blart_lock IS NOT INITIAL ) OR
      ( gv_bschl_lock IS NOT INITIAL ) OR
      ( gv_saknr_lock IS NOT INITIAL ) OR
      ( gv_waers_lock IS NOT INITIAL ).

      screen-input = 0.
      CASE screen-name.

        WHEN 'ZC102FIT0009-BLART'.
          IF gv_blart_lock = abap_true.
            screen-input = 1.
            screen-intensified = '1'.
            screen-color = '13'.
            MESSAGE s001 WITH TEXT-c01 DISPLAY LIKE 'E'.
          ENDIF.

        WHEN 'ZC102FIT0010-BSCHL'.
          IF gv_bschl_lock = abap_true.
            screen-input = 1.
            screen-intensified = '1'.
            screen-color = '13'.
            MESSAGE s001 WITH TEXT-c01 DISPLAY LIKE 'E'.
          ENDIF.

        WHEN 'ZC102FIT0010-SAKNR'.
          IF gv_saknr_lock = abap_true.
            screen-input = 1.
            screen-intensified = '1'.
            screen-color = '13'.
            MESSAGE s001 WITH TEXT-c01 DISPLAY LIKE 'E'.
          ENDIF.

        WHEN 'ZC102FIT0009-WAERS'.
          IF gv_waers_lock = abap_true.
            screen-input = 1.
            screen-intensified = '1'.
            screen-color = '13'.
            MESSAGE s001 WITH TEXT-c01 DISPLAY LIKE 'E'.
          ENDIF.

      ENDCASE.

    ELSE.
      CONTINUE.
    ENDIF.

    MODIFY SCREEN.

  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_bp_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_bp_data .
  CLEAR : gs_partner, gt_partner.

  SELECT partner saknr bpact
    INTO CORRESPONDING FIELDS OF TABLE gt_partner
    FROM zc102bpt0002.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form sort_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM sort_data .
  CLEAR : gs_sort, gt_sort.

  gs_sort-spos      = 1.
  gs_sort-fieldname = 'SHKZG'.
  gs_sort-down      = abap_true.
  gs_sort-subtot    = abap_true.

  APPEND gs_sort TO gt_sort.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_tcurx
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_tcurx .
  CLEAR : gt_tcurx.

  SELECT currkey currdec
    INTO CORRESPONDING FIELDS OF TABLE gt_tcurx
    FROM tcurx.
ENDFORM.
