``` abap
*&---------------------------------------------------------------------*
*& Include          ZC102COR0003F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Include          ZC102COR0002F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form fill_subscreen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_subscreen .
  CASE gc_tab-activetab.
    WHEN 'TAB1'.
      gv_subscreen = '0101'.
    WHEN OTHERS.
      gv_subscreen = '0101'.
      gc_tab-activetab = 'TAB1'.
  ENDCASE.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form main_screen_ctrl
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM main_screen_ctrl .
  IF go_split_cont IS NOT BOUND.

    CLEAR : gt_cost_fcat, gs_cost_fcat.
    PERFORM set_cost_fcat USING : 'X' 'KOKRS'  'ZVC102CO0002' 'C' ' ',
                                  'X' 'KOSTL'  'ZVC102CO0002' 'C' ' ',
                                  ' ' 'TXT20'  'ZVC102CO0002' ' ' 'X',
                                  ' ' 'AWRBTR' 'ZVC102CO0002' ' ' ' ',
                                  ' ' 'WAERS'  'ZVC102CO0002' 'C' ' '.

    CLEAR : gt_value_fcat, gs_value_fcat.
    PERFORM set_value_fcat USING : 'X' 'KOKRS'    'ZVC102CO0012' 'C' ' ',
                                   'X' 'PRCTR'    'ZVC102CO0012' 'C' ' ',
                                   ' ' 'TOTAL'    'ZVC102CO0012' ' ' ' ',
                                   ' ' 'SKFVALUE' 'ZVC102CO0012' ' ' ' ',
                                   ' ' 'AUNIT'    'ZVC102CO0012' 'C' 'X',
                                   ' ' 'PERCT'    'ZVC102CO0012' ' ' ' '.

    CLEAR : gt_result_fcat, gs_result_fcat.
    PERFORM set_result_fcat USING : 'X' 'KOKRS'    'ZVC102CO0012' 'C' ' ',
                                    'X' 'PRCTR'    'ZVC102CO0012' 'C' ' ',
                                    ' ' 'KOSTL'    'ZVC102CO0012' 'C' ' ',
                                    ' ' 'SAKNR'    'ZVC102CO0012' 'C' ' ',
                                    ' ' 'TXT20'    'ZVC102CO0012' 'C' ' ',
                                    ' ' 'SKFVALUE' 'ZVC102CO0012' ' ' ' ',
                                    ' ' 'AUNIT'    'ZVC102CO0012' 'C' 'X',
                                    ' ' 'PERCT'    'ZVC102CO0012' ' ' ' ',
                                    ' ' 'WRBTR'    'ZVC102CO0012' ' ' ' '.

    PERFORM set_variant.
    PERFORM create_obj.

    PERFORM set_layout USING TEXT-t01.
    CALL METHOD go_left_top_alv->set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout
      CHANGING
        it_outtab       = gt_cost
        it_fieldcatalog = gt_cost_fcat.

    PERFORM set_layout USING TEXT-t02.
    PERFORM set_exclude.
    SET HANDLER lcl_event_handler=>modify_value FOR go_left_bot_alv.
    CALL METHOD go_left_bot_alv->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_value
        it_fieldcatalog      = gt_value_fcat.

    PERFORM register_event.

    PERFORM set_layout USING TEXT-t03.
    PERFORM set_result_sort.
    CALL METHOD go_right_alv->set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout
      CHANGING
        it_outtab       = gt_result
        it_fieldcatalog = gt_result_fcat
        it_sort         = gt_result_sort.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_layout USING pv_title.

  gs_layout-zebra      = abap_true.
  gs_layout-cwidth_opt = 'A'.
  gs_layout-sel_mode   = 'D'.
  gs_layout-grid_title = pv_title.
  gs_layout-stylefname = 'CELL_TAB'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_variant
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_variant .

  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV1'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_obj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_obj .

*-- Main Cont
  CREATE OBJECT go_base_cont
    EXPORTING
      container_name = 'MAIN_CONT'.

*-- Main Split
  CREATE OBJECT go_split_cont
    EXPORTING
      parent  = go_base_cont
      rows    = 1
      columns = 2.

*-- 사이즈 조절
  CALL METHOD go_split_cont->set_column_width
    EXPORTING
      id    = 2
      width = 70.

*-- Left Split
  CALL METHOD go_split_cont->get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_left_cont.

*-- right cont
  CALL METHOD go_split_cont->get_container
    EXPORTING
      row       = 1
      column    = 2
    RECEIVING
      container = go_right_cont.

*-- Left Split cont
  CREATE OBJECT go_left_split_cont
    EXPORTING
      parent  = go_left_cont
      rows    = 2
      columns = 1.

*-- Left Split Top-Bot Cont
  CALL METHOD go_left_split_cont->get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_left_top_cont.

  CALL METHOD go_left_split_cont->get_container
    EXPORTING
      row       = 2
      column    = 1
    RECEIVING
      container = go_left_bot_cont.

*-- Right Split cont
  CREATE OBJECT go_right_split_cont
    EXPORTING
      parent  = go_right_cont
      rows    = 1
      columns = 2.

  CALL METHOD go_right_split_cont->get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_right_alv_cont.

  CALL METHOD go_right_split_cont->get_container
    EXPORTING
      row       = 1
      column    = 2
    RECEIVING
      container = go_chart_cont.


*-- ALV
  CREATE OBJECT go_left_top_alv
    EXPORTING
      i_parent = go_left_top_cont.

  CREATE OBJECT go_left_bot_alv
    EXPORTING
      i_parent = go_left_bot_cont.

  CREATE OBJECT go_right_alv
    EXPORTING
      i_parent = go_right_alv_cont.

*-- Chart
  CREATE OBJECT go_chart
    EXPORTING
      parent = go_chart_cont.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_init_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_init_value .

  CLEAR gs_input.
  gs_input-kokrs = '1000'.
  gs_input-gjahr = sy-datum(4).
  gs_input-valid_fr = '20250101'.
  gs_input-valid_to = sy-datum.

  CLEAR gs_sub.
  gs_sub-cct = 'CCT500'.
  gs_sub-cct_to = 'CCT600'.
  gs_sub-pct_fr = 'PCT100'.
  gs_sub-pct_to = 'PCT200'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_cost_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_cost_fcat USING pv_key pv_field pv_table pv_just pv_emph.

  gs_cost_fcat-key       = pv_key.
  gs_cost_fcat-fieldname = pv_field.
  gs_cost_fcat-ref_table = pv_table.
  gs_cost_fcat-just      = pv_just.
  gs_cost_fcat-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'AWRBTR'.
      gs_cost_fcat-coltext = '금액'.
      gs_cost_fcat-cfieldname = 'WAERS'.
  ENDCASE.

  APPEND gs_cost_fcat TO gt_cost_fcat.
  CLEAR gs_cost_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_value_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_value_fcat USING pv_key pv_field pv_table pv_just pv_emph.

  gs_value_fcat-key       = pv_key.
  gs_value_fcat-fieldname = pv_field.
  gs_value_fcat-ref_table = pv_table.
  gs_value_fcat-just      = pv_just.
  gs_value_fcat-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'PRCTR'.
      gs_value_fcat-ref_table = 'ZC102COT0004'.
    WHEN 'SKFVALUE'.
      gs_value_fcat-coltext = TEXT-w01.
    WHEN 'TOTAL'.
      gs_value_fcat-coltext = TEXT-w02.
    WHEN 'PERCT'.
      gs_value_fcat-coltext = TEXT-w03.
    WHEN 'WRBTR'.
      gs_value_fcat-ref_table = 'ZC102FIT0010'.
      gs_value_fcat-currency = 'KRW'.
  ENDCASE.

  APPEND gs_value_fcat TO gt_value_fcat.
  CLEAR gs_value_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_cost_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_cost_data .

  DATA : lv_dbcnt TYPE sy-dbcnt.

  IF ( gs_input-valid_fr IS INITIAL ) OR
     ( gs_input-valid_to IS INITIAL ).
    MESSAGE s000 WITH TEXT-s05 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  PERFORM set_saknr_range.

  CLEAR gt_cost.
  SELECT DISTINCT kokrs, kostl, saknr, txt20, awrbtr, waers
    INTO CORRESPONDING FIELDS OF TABLE @gt_cost
    FROM zvc102co0002( pa_valid_fr = @gs_input-valid_fr,
                       pa_valid_to = @gs_input-valid_to )
    WHERE kostl IN ( 'CCT500', 'CCT600' )
      AND txt20 IN @gr_saknr
      AND status = ''
    ORDER BY kostl ASCENDING, txt20 ASCENDING.

  lv_dbcnt = lines( gt_cost ).
  MESSAGE s010 WITH lv_dbcnt.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_left_top_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_left_top_table .

  CALL METHOD go_left_top_alv->refresh_table_display.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_search_help_acttp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_search_help_acttp .

  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

*  CLEAR : gt_acttp.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'DESCT'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_ACTTP-ACTTP'
      window_title = '활동 유형'
      value_org    = 'S'
    TABLES
      value_tab    = gt_acttp
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_acttp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_acttp .

  CLEAR : gt_acttp.

  SELECT acttp desct
    INTO CORRESPONDING FIELDS OF TABLE gt_acttp
    FROM zc102cot0012.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen_value .

  LOOP AT SCREEN.

    IF gs_sub-check = abap_true.
      IF screen-group1 = 'SET'.
        screen-input = 0.
      ENDIF.
    ENDIF.

    IF screen-name = 'ZC102COT0006-AUNIT'.
      IF gs_sub-acttp IS INITIAL.
*        MESSAGE s000 WITH TEXT-m06 DISPLAY LIKE 'E'.
        screen-input = 0.
      ELSE.
        screen-input = 1.
      ENDIF.
    ENDIF.

    MODIFY SCREEN.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_saknr
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_saknr .

  CLEAR gt_saknr.
  SELECT DISTINCT a~saknr txt20
    INTO CORRESPONDING FIELDS OF TABLE gt_saknr
    FROM zc102fit0002 AS a INNER JOIN zc102cot0007 AS b
      ON a~saknr = b~saknr
    WHERE kostl IN ('CCT500', 'CCT600')
  ORDER BY txt20 ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_search_help_cel
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_search_help_cel .

  DATA : lt_return LIKE ddshretval OCCURS 0 WITH HEADER LINE,
         ls_modi   TYPE lvc_s_modi.

  DATA : BEGIN OF dynpfields OCCURS 0.
           INCLUDE TYPE dynpread.
  DATA : END OF dynpfields.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'DESCT'
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'GT_SAKNR-SAKNR'
      window_title = '활동 유형'
      value_org    = 'S'
    TABLES
      value_tab    = gt_saknr
      return_tab   = lt_return.

  READ TABLE dynpfields WITH KEY fieldname = lt_return-retfield.
  IF sy-subrc = 0.
    dynpfields-fieldvalue = lt_return-fieldval.
    MODIFY dynpfields INDEX sy-tabix.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_saknr_range
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_saknr_range .

  _init gr_saknr.

  IF ( gs_sub-cel_fr IS NOT INITIAL ) AND
   ( gs_sub-cel_to IS NOT INITIAL ).
    PERFORM set_saknr_value USING 'I' 'BT'.
  ELSEIF ( gs_sub-cel_fr IS NOT INITIAL ).
    PERFORM set_saknr_value USING 'I' 'EQ'.
  ELSEIF ( gs_sub-cel_to IS NOT INITIAL ).
    PERFORM set_saknr_value USING 'I' 'BT'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_saknr_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_saknr_value USING pv_sign pv_option.

  gr_saknr-sign = pv_sign.
  gr_saknr-option = pv_option.
  gr_saknr-low = gs_sub-cel_fr.
  gr_saknr-high = gs_sub-cel_to.
  APPEND gr_saknr.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_field_empty
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_skf_data .

  DATA : lv_calc  TYPE p DECIMALS 2.

  PERFORM check_acttp_validation.
  IF gv_check IS INITIAL.
    MESSAGE s000 WITH TEXT-m06 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  IF gs_sub-check = abap_true.
    gt_value = VALUE #(
                        ( kokrs = '1000' prctr = 'PCT100'
                          total = 100 aunit = '%' )
                        ( kokrs = '1000' prctr = 'PCT200'
                          total = 100 aunit = '%' )
                      ).
    LOOP AT gt_value INTO gs_value.
      PERFORM edit_ctrl USING 'SKFVALUE'.
      MODIFY gt_value FROM gs_value INDEX sy-tabix
                                    TRANSPORTING cell_tab.
    ENDLOOP.
  ELSE.

    IF ( zc102cot0006-aunit IS INITIAL ) OR
   ( gs_sub-acttp IS INITIAL ).
      MESSAGE s000 WITH TEXT-m01 DISPLAY LIKE 'E'.
      EXIT.
    ENDIF.

    CLEAR gt_value.
    SELECT kokrs aunit prctr total skfvalue
      INTO CORRESPONDING FIELDS OF TABLE gt_value
      FROM zvc102co0012
      WHERE aunit = zc102cot0006-aunit
      ORDER BY aunit ASCENDING prctr ASCENDING.

*-- 비율 계산
    LOOP AT gt_value INTO gs_value.

      lv_calc = ( gs_value-skfvalue / gs_value-total ) * 100.
      gs_value-perct = lv_calc && '%'.
      MODIFY gt_value FROM gs_value INDEX sy-tabix TRANSPORTING perct.

    ENDLOOP.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_left_bot_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_left_bot_table .

  CALL METHOD go_left_bot_alv->refresh_table_display.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form edit_ctrl
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&---------------------------------------------------------------------*
FORM edit_ctrl USING pv_field.

  DATA : ls_style TYPE lvc_s_styl.

  CLEAR : ls_style.
  ls_style-fieldname = pv_field.
  ls_style-style     = cl_gui_alv_grid=>mc_style_enabled.
  INSERT ls_style INTO TABLE gs_value-cell_tab.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form register_event
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM register_event .

  CALL METHOD go_left_bot_alv->set_ready_for_input
    EXPORTING
      i_ready_for_input = 1.

  CALL METHOD go_left_bot_alv->register_edit_event
    EXPORTING
      i_event_id = cl_gui_alv_grid=>mc_evt_modified.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_modify_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_MODIFIED
*&      --> ET_GOOD_CELLS
*&---------------------------------------------------------------------*
FORM handle_modify_value USING pv_modified
                               pt_good_cells TYPE lvc_t_modi.

  CHECK pv_modified IS NOT INITIAL.

  DATA : lv_value TYPE i.

  LOOP AT pt_good_cells INTO DATA(ls_good_cells).

*-- 비율 계산
    CASE ls_good_cells-fieldname.
      WHEN 'SKFVALUE'.
        " 지표 총 합 계산
        IF ls_good_cells-value > 100.
          MESSAGE s000 WITH TEXT-m02 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.

        " 변경한 지표 반영
        CLEAR gs_value.
        READ TABLE gt_value INTO gs_value INDEX ls_good_cells-row_id.
        gs_value-perct = gs_value-skfvalue && '%'.
        MODIFY gt_value FROM gs_value INDEX ls_good_cells-row_id
                                      TRANSPORTING perct.

        lv_value = 100 - gs_value-skfvalue.
        " 나머지 지표 반영
        CLEAR gs_value.

        READ TABLE gt_value INTO gs_value
                            INDEX ( ls_good_cells-row_id + 2 ) MOD 2 + 1.
        gs_value-perct = lv_value && '%'.
        gs_value-skfvalue = lv_value.
        MODIFY gt_value FROM gs_value
                        INDEX ( ls_good_cells-row_id + 2 ) MOD 2 + 1
                        TRANSPORTING skfvalue perct.

        PERFORM refresh_left_bot_table.
    ENDCASE.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_result_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_result_fcat USING pv_key pv_field pv_table pv_just pv_emph.

  gs_result_fcat-key       = pv_key.
  gs_result_fcat-fieldname = pv_field.
  gs_result_fcat-ref_table = pv_table.
  gs_result_fcat-just      = pv_just.
  gs_result_fcat-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'PRCTR'.
      gs_result_fcat-ref_table = 'ZC102COT0004'.
      gs_result_fcat-coltext = TEXT-f01.
    WHEN'KOSTL'.
      gs_result_fcat-coltext = TEXT-f02.
    WHEN 'SKFVALUE'.
      gs_result_fcat-coltext = TEXT-w01.
    WHEN 'PERCT'.
      gs_result_fcat-coltext = TEXT-w03.
    WHEN 'WRBTR'.
      gs_result_fcat-ref_table = 'ZC102FIT0010'.
      gs_result_fcat-cfieldname = 'WAERS'.
      gs_result_fcat-do_sum     = abap_true.
    WHEN 'SAKNR' OR 'TXT20'.
      gs_result_fcat-ref_table = 'ZC102FIT0002'.
    WHEN 'WAERS'.
      gs_result_fcat-ref_table = 'ZC102FIT0010'.
  ENDCASE.

  APPEND gs_result_fcat TO gt_result_fcat.
  CLEAR gs_result_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_distribution_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_distribution_data .

  DATA : lv_tabix TYPE sy-tabix,
         lv_sum   LIKE gs_cost-awrbtr.

  IF ( gs_input-valid_fr IS INITIAL ) OR
     ( gs_input-valid_to IS INITIAL ).
    MESSAGE s000 WITH TEXT-s05 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

*-- 시뮬레이션해야 실제 배부 진행
  IF gv_rdo2 = abap_true.
    IF gt_result IS INITIAL.
      MESSAGE s000 WITH TEXT-m03 DISPLAY LIKE 'E'.
    ELSE.
      PERFORM create_document.
      PERFORM refresh_left_bot_table.
      PERFORM refresh_left_top_table.
      PERFORM refresh_right_alv.
    ENDIF.
    EXIT.
  ENDIF.

*-- 집계 현황 금액 배부
  " 1. 계정 별로 금액 SKF 비율로 나누기
  " 2. 두 줄 생성해서 배부 결과 테이블에 Insert
  CLEAR gt_result.
  LOOP AT gt_cost INTO gs_cost.

    CLEAR gs_result.
    gs_result-kokrs = gs_cost-kokrs.
    gs_result-txt20 = gs_cost-txt20.
    gs_result-kostl = gs_cost-kostl.
    gs_result-waers = gs_cost-waers.
    READ TABLE gt_saknr INTO gs_saknr WITH KEY txt20 = gs_result-txt20
                                      BINARY SEARCH.
    IF sy-subrc = 0.
      gs_result-saknr = gs_saknr-saknr.
      LOOP AT gt_value INTO gs_value.
        gs_result-prctr = gs_value-prctr.
        gs_result-skfvalue = gs_value-skfvalue.
        gs_result-aunit = gs_value-aunit.
        gs_result-perct = gs_value-perct.
        lv_sum = gs_cost-awrbtr * ( gs_value-skfvalue / gs_value-total ).
        gs_result-wrbtr = lv_sum.

        COLLECT gs_result INTO gt_result.
      ENDLOOP.
    ENDIF.

  ENDLOOP.

  PERFORM refresh_right_alv.
  PERFORM set_char_value.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_right_alv
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_right_alv .

  CALL METHOD go_right_alv->refresh_table_display.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_result_sort
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_result_sort .

  CLEAR : gt_result_sort, gs_result_sort.
  gs_result_sort-spos = 1.
  gs_result_sort-fieldname = 'TXT20'.
  gs_result_sort-subtot = abap_true.
  APPEND gs_result_sort TO gt_result_sort.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_chart
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_chart .

  CLEAR : go_ixml,
          go_ixml_sf,
          go_ixml_docu,
          go_ixml_ostream,
          go_ixml_encoding,
          go_chartdata,
          go_categories,
          go_category,
          go_series,
          go_point,
          go_value.

  CLEAR : gv_xstring.

  go_ixml = cl_ixml=>create(  ).
  go_ixml_sf = go_ixml->create_stream_factory( ).

  go_ixml_docu = go_ixml->create_document( ).

  go_ixml_encoding = go_ixml->create_encoding(
                       byte_order    = if_ixml_encoding=>co_little_endian
                       character_set = 'utf-8' ).

  go_ixml_docu->set_encoding( encoding = go_ixml_encoding ).

*-- Now build a DOM, representing an XML document with chart data
  go_chartdata = go_ixml_docu->create_simple_element(
                                        name   = 'ChartData'
                                        parent = go_ixml_docu ).

*-- Categories (parent)
  go_categories = go_ixml_docu->create_simple_element(
                                        name   = 'Categories'
                                        parent = go_chartdata ).

*-- 차트 디자인 설정
  PERFORM set_category_value.
  PERFORM set_chart_value.
*  PERFORM set_design.

  go_chart->set_data( xdata = gv_xstring ).
  go_chart->render( ).

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_category_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_category_value .

  LOOP AT gt_chart INTO gs_chart.
    go_category = go_ixml_docu->create_simple_element(
                                      name   = 'Category'
                                      parent = go_categories ).
    go_category->if_ixml_node~set_value( gs_chart-prctr && '' ).
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_chart_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_chart_value .

  DATA : lv_value  TYPE string,
         lv_target TYPE string.

  FIELD-SYMBOLS <ls_value>.

  " 1. Revenue - 매출,  2. Cost - 직접 재료비, 3. Revenue - Cost - 공헌 이익
  " 4. sum - 비용 배부,  5. 3번 - 4번 - 영업이익 - 안씀
  DO 4 TIMES.
    CASE sy-index.
      WHEN 1.
        lv_value = '매출'.
        lv_target = 'REVENUE'.
      WHEN 2.
        lv_value = '직접 재료비'.
        lv_target = 'COST'.
      WHEN 3.
        lv_value = '재료 처리량 공헌 이익'.
        lv_target = 'CONTRIBUTIONMARGIN'.
      WHEN 4.
        lv_value = '배부 비용'.
        lv_target = 'SUM'.
    ENDCASE.

    ASSIGN COMPONENT lv_target OF STRUCTURE gs_chart TO <ls_value>.

    IF <ls_value> IS ASSIGNED.
*-- 라벨 달기
      go_series = go_ixml_docu->create_simple_element(
                                                        name = 'Series'
                                                        parent = go_chartdata ).
      go_series->set_attribute( name  = 'label'
                                value = lv_value ). "'Series1' ).
      LOOP AT gt_chart INTO gs_chart.

*-- 값 계산
        lv_value = <ls_value>.

        go_point = go_ixml_docu->create_simple_element(
                                                        name = 'Point'
                                                        parent = go_series ).
        go_point->set_attribute( name  = 'label'
                                 value = lv_value ).
*
        go_value = go_ixml_docu->create_simple_element(
                                                        name = 'Value'
                                                        parent = go_point ).

        go_value->if_ixml_node~set_value( lv_value ).

      ENDLOOP.
      UNASSIGN <ls_value>.
    ENDIF.
  ENDDO.

*  LOOP AT gt_month INTO gs_month.
*    lv_month = so_monat-low.
*    lv_value = gs_month-gjahr && '년-' && gs_month-acdes.
*
**-- 라벨 달기
*    go_series = go_ixml_docu->create_simple_element(
*                                                      name = 'Series'
*                                                      parent = go_chartdata ).
*    go_series->set_attribute( name  = 'label'
*                              value = lv_value ). "'Series1' ).
*
**-- 값 계산
*    DO.
*      lv_value = 'MON' && lv_month.
*
*      ASSIGN COMPONENT lv_value OF STRUCTURE gs_month TO <ls_month>.
*      IF ( <ls_month> IS NOT ASSIGNED ) OR
*         ( lv_month > so_monat-high ).
*        EXIT.
*      ENDIF.
*      lv_value = <ls_month>.
*
*      go_point = go_ixml_docu->create_simple_element(
*                                                      name = 'Point'
*                                                      parent = go_series ).
*      go_point->set_attribute( name  = 'label'
*                               value = lv_value ).
**
*      go_value = go_ixml_docu->create_simple_element(
*                                                      name = 'Value'
*                                                      parent = go_point ).
*
*      go_value->if_ixml_node~set_value( lv_value ).
*
*      UNASSIGN <ls_month>.
*
*      lv_month += 1.
*
*    ENDDO.
*
*  ENDLOOP.

*-- create ostream (into string variable) and render document into stream
  go_ixml_ostream = go_ixml_sf->create_ostream_xstring( gv_xstring ).
  go_ixml_docu->render( go_ixml_ostream ). "here f_xstring is filled

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_char_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_char_value .

  DATA : lv_sum TYPE zc102fit0010-wrbtr.

  LOOP AT gt_chart INTO gs_chart.

    LOOP AT gt_result INTO gs_result WHERE prctr = gs_chart-prctr.
      gs_chart-sum = gs_result-wrbtr.
      COLLECT gs_chart INTO gt_chart.
    ENDLOOP.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_report
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_report .

  CLEAR gt_chart.
  SELECT DISTINCT  prctr revenue cost contributionmargin fixed_currency
    INTO CORRESPONDING FIELDS OF TABLE gt_chart
    FROM zvc102co0033.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_aunit
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_aunit .

  DATA: lt_values TYPE vrm_values,
        ls_value  TYPE vrm_value.

  CLEAR lt_values.

  IF gs_sub-acttp = '경영 지원'.
    PERFORM set_aunit_value USING 'HR' ls_value lt_values.
    PERFORM set_aunit_value USING 'TF' ls_value lt_values.
    PERFORM set_aunit_value USING 'PC' ls_value lt_values.
  ELSE.
    LOOP AT gt_aunit INTO gs_aunit.

      ls_value-key = gs_aunit-aunit.
      ls_value-text = gs_aunit-value.
      APPEND ls_value TO lt_values.

    ENDLOOP.

  ENDIF.

  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = 'ZC102COT0006-AUNIT'
      values = lt_values.

  " ✅ 기본값 설정
*  IF zc102cot0006-aunit IS INITIAL.
*    zc102cot0006-aunit = 'A'.  " key 값 기준
*  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_aunit
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_aunit .

  CLEAR gt_aunit.
  SELECT domvalue_l AS aunit ddtext AS value
    INTO CORRESPONDING FIELDS OF TABLE gt_aunit
    FROM dd07t
    WHERE domname = 'ZC102D_CO_AUNIT'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_aunit_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> LS_VALUE
*&      --> LT_VALUES
*&---------------------------------------------------------------------*
FORM set_aunit_value USING pv_field
                           ps_value TYPE vrm_value
                           pt_values TYPE vrm_values.

  CLEAR gs_aunit.
  READ TABLE gt_aunit INTO gs_aunit WITH KEY pv_field.
  ps_value-key = gs_aunit-aunit.
  ps_value-text = gs_aunit-value.
  APPEND ps_value TO pt_values.
  CLEAR ps_value.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_document
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_document .

  DATA : lv_answer,
         ls_header TYPE zc102cot0009,
         lt_line   TYPE TABLE OF zc102cot0010,
         lv_belnr  TYPE string.

  PERFORM pop_up_confirm USING lv_answer.

  CHECK lv_answer = '1'.

*-- 배부할 전표 조회
  PERFORM get_fi_document.

*-- CO 문서 채번
  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      object      = 'ZC102CM_AU'  " SNRO 오브젝트 이름
      nr_range_nr = '01'          " 인터벌 번호
      subobject   = 'CO'     " Prefix (서브오브젝트)
      quantity    = 1
    IMPORTING
      number      = lv_belnr
    EXCEPTIONS
      OTHERS      = 1.

*-- CO 문서 헤더 생성
  PERFORM set_header_data USING lv_belnr
                          CHANGING ls_header.
  MODIFY zc102cot0009 FROM ls_header.

*-- CO 문서 라인 생성
  PERFORM set_line_data TABLES lt_line USING lv_belnr
                                             ls_header.

  MODIFY zc102cot0010 FROM TABLE lt_line.

  IF sy-subrc = 0.
    MESSAGE s001 WITH lv_belnr TEXT-m04.
    CLEAR : gt_cost, gt_value, gt_result.
    COMMIT WORK AND WAIT.
  ELSE.
    MESSAGE s000 WITH TEXT-m05.
    ROLLBACK WORK.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form pop_up_confirm
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_ANSWER
*&---------------------------------------------------------------------*
FORM pop_up_confirm USING pv_answer.

  CALL FUNCTION 'ZFM_CL102_CM_POP_UP'
    EXPORTING
      iv_titlebar = '전표 생성'
      iv_question = '전표를 생성하시겠습니까?'
    IMPORTING
      ev_answer   = pv_answer.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_exclude
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_exclude .

  DATA : ls_ui_functions TYPE ui_func.

  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_undo.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_cut.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_delete_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_insert_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_append_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_refresh.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_auf.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_average.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_print.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_graph.
  APPEND ls_ui_functions TO gt_ui_functions.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_header_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_BELNR
*&---------------------------------------------------------------------*
FORM set_header_data USING pv_belnr
                     CHANGING ps_header TYPE zc102cot0009.

*-- Set Header Data
  ps_header = VALUE #( kokrs = '1000'
                       bukrs = '1000'
                       belnr = pv_belnr
                       gjahr = sy-datum(4)
                       blart = 'KS'
                       bldat = sy-datum
                       budat = sy-datum
                       bktxt = '비용 1차 배부'
                       waers = 'KRW'
                       valid_from = gs_input-valid_fr
                       valid_to = gs_input-valid_to
                       erdat = sy-datum
                       ernam = sy-uname
                       erzet = sy-uzeit ).

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_line_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_BELNR
*&      <-- LT_LINE
*&---------------------------------------------------------------------*
FORM set_line_data TABLES lt_line
                   USING pv_belnr
                         ps_header TYPE zc102cot0009.

  DATA : ls_line  TYPE zc102cot0010,
         lv_buzei TYPE zc102cot0010-buzei.

  CLEAR : gs_result.
  lv_buzei = 1.

*-- acttp 찾기
  READ TABLE gt_acttp INTO gs_acttp WITH KEY desct = gs_sub-acttp.
  IF sy-subrc <> 0.
    EXIT.
  ENDIF.

*-- 수신 라인 생성
  LOOP AT gt_result INTO gs_result.
    CLEAR ls_line.

    ls_line = VALUE #( kokrs = ps_header-kokrs
                       bukrs = ps_header-bukrs
                       belnr = ps_header-belnr
                       buzei = lv_buzei
                       gjahr = ps_header-gjahr
                       objno = gs_result-prctr
                       benkz = 'R'
                       saknr = gs_result-saknr
                       sgtxt = '비용 1차 배부 수신'
                       wrbtr = gs_result-wrbtr
                       waers = gs_result-waers
                       acttp = gs_acttp-acttp
                       erdat = sy-datum
                       ernam = sy-uname
                       erzet = sy-uzeit ).
    APPEND ls_line TO lt_line.

    lv_buzei += 1.
  ENDLOOP.

*-- 송신 라인 생성
  CLEAR gs_cost.

  LOOP AT gt_cost INTO gs_cost.
    CLEAR ls_line.

    ls_line = VALUE #( kokrs = ps_header-kokrs
                       bukrs = ps_header-bukrs
                       belnr = ps_header-belnr
                       buzei = lv_buzei
                       gjahr = ps_header-gjahr
                       objno = gs_cost-kostl
                       benkz = 'S'
                       saknr = gs_cost-saknr
                       sgtxt = '비용 1차 배부 송신'
                       wrbtr = gs_cost-awrbtr
                       waers = gs_cost-waers
                       acttp = gs_acttp-acttp
                       erdat = sy-datum
                       ernam = sy-uname
                       erzet = sy-uzeit ).
    APPEND ls_line TO lt_line.

    lv_buzei += 1.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_fi_document
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_fi_document .

  DATA : lt_document TYPE TABLE OF zc102codocument.

  CLEAR lt_document.
  SELECT bukrs, gjahr, belnr
    INTO CORRESPONDING FIELDS OF TABLE @lt_document
    FROM zc102codocument( pa_valid_fr = @gs_input-valid_fr,
                          pa_valid_to = @gs_input-valid_to )
    WHERE kostl IN ('CCT500', 'CCT600').


  LOOP AT lt_document INTO DATA(ls_document).

    UPDATE zc102fit0010 SET status = 'X'
                            aedat = sy-datum
                            aenam = sy-uname
                            aezet = sy-uzeit
                        WHERE bukrs = ls_document-bukrs
                          AND belnr = ls_document-belnr
                          AND gjahr = ls_document-gjahr.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_actt_validation
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_CHECK
*&---------------------------------------------------------------------*
FORM check_acttp_validation.

  CLEAR gs_acttp.
  READ TABLE gt_acttp INTO gs_acttp WITH KEY desct = gs_sub-acttp.
  IF ( gs_acttp IS INITIAL ) AND
     ( gs_sub-check IS INITIAL ).
    gv_check = abap_false.
    EXIT.
  ENDIF.

  gv_check = abap_true.

ENDFORM.
